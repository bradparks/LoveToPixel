<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>LoveToPixel -- Alpha</title>
	<link rel="stylesheet" href="http://extjs.cachefly.net/ext-4.0.2a/resources/css/ext-all.css" />
	<link rel="stylesheet" href="ltp.css" />

	<script type="text/javascript" src="http://extjs.cachefly.net/ext-4.0.2a/ext-all.js"></script>

	<script type="text/javascript" src="../app/js/util.js"></script>
	<script type="text/javascript" src="../app/js/MessageBus.js"></script>

	<script type="text/javascript" src="../app/js/geometry/PointTransformer.js"></script>
	<script type="text/javascript" src="../app/js/geometry/Rectangle.js"></script>
	<script type="text/javascript" src="../app/js/geometry/Pair.js"></script>
	<script type="text/javascript" src="../app/js/geometry/BoundingBoxBuilder.js"></script>

	<script type="text/javascript" src="../app/js/tools/BrushTool.js"></script>
	<script type="text/javascript" src="../app/js/tools/EyeDropperTool.js"></script>

	<script type="text/javascript" src="../app/js/canvas/Container.js"></script>
	<script type="text/javascript" src="../app/js/canvas/Painter.js"></script>
	<script type="text/javascript" src="../app/js/canvas/LayerManager.js"></script>
	<script type="text/javascript" src="../app/js/canvas/Grid.js"></script>

	<script type="text/javascript" src="../app/js/KeyListener.js"></script>
	<script type="text/javascript" src="../app/js/LTP.js"></script>

	<script type="text/javascript" src="../app/js/ui/CurrentCoordinates.js"></script>
	<script type="text/javascript" src="../app/js/ui/CurrentZoom.js"></script>
	<script type="text/javascript" src="../app/js/ui/CurrentColor.js"></script>
	<script type="text/javascript" src="../app/js/ui/StatusBar.js"></script>
</head>
<body>
	<div id="outerContainerElement">
		<div id="containerElement"></div>
	</div>
	<div id="statusBarElement"></div>
	<script type="text/javascript">
		if(navigator.userAgent.indexOf('WebKit') < 0) {
			alert('so far LoveToPixel only works on Chrome and Safari');
		}

		var imageSize = s(800, 600);

		var layerManager = new LTP.LayerManager(imageSize, 'white');
		var container = new LTP.Container(document.getElementById('containerElement'));

		var pointTransformer = new LTP.PointTransformer();
		var painter = new LTP.Painter(imageSize, pointTransformer);
		painter.leftTool = new LTP.BrushTool('red', 20);
		painter.rightTool = new LTP.BrushTool('white', 80);
		
		var eyeDropperTool = new LTP.EyeDropperTool();
		
		LTP.GlobalMessageBus.subscribe('colorSampled', function(rgbColor, hexColor) {
			painter.leftTool = new LTP.BrushTool(rgbColor, 20);
			LTP.GlobalMessageBus.publish('leftColorChanged', hexColor);
		});

		var grid = new LTP.Grid(imageSize, 'gray', 5);

		container.addLayer(layerManager.activeLayer);
		painter.activeCanvas = layerManager.activeLayer;
		container.overlay = painter.overlay;
		container.grid = grid.canvas;
		container.setScratchForLayer(painter.scratch, layerManager.activeLayer);
		
		var zoomLevels = [.25, .5, 1, 2, 4, 8, 16, 32];
		var gridLevels = [5, 10, 15, 20, 20000];
		var currentGridIndex = 4;
		var currentZoomIndex = 2;
		var colors = [
			'red',
			'#9922ff',
			'blue',
			'green',
			'orange',
			'purple',
			'rgb(100, 20, 0)',
			'gray'
		];

		grid.cellSize = gridLevels[currentGridIndex];

		var keyListenerConfig = {
			callbacks : {
				z: function() {
					currentZoomIndex = (currentZoomIndex + 1) % zoomLevels.length;
					//container.zoomTo(zoomLevels[currentZoomIndex]);
					//pointTransformer.zoom = zoomLevels[currentZoomIndex];
					LTP.GlobalMessageBus.publish('zoomChanged', zoomLevels[currentZoomIndex]);
				},
				u: function() {
					painter.undo();
				},
				r: function() {
					painter.redo();
				},
				g: function() {
					currentGridIndex  = (currentGridIndex + 1) % gridLevels.length;
					grid.cellSize = gridLevels[currentGridIndex];
				},
				i: function() {
					if(this.overrideActive) {
						painter.popOverrideTool();
						this.overrideActive = false;
					} else {
						painter.pushOverrideTool(eyeDropperTool);
						this.overrideActive = true;
					}
				},
				a: function() {
					LTP.GlobalMessageBus.publish('zoomChanged', 1);
					currentZoomIndex = 2;
				},
				s: function() {
					var composited = layerManager.composite();
					window.open(composited.toDataURL('png'), 'savedImage');
				}
			}
		};

		for(var i = 0; i < colors.length; ++i) {
			keyListenerConfig.callbacks[(i+1).toString()] = (function(i) {
				return function() {
					painter.leftTool = new LTP.BrushTool(colors[i], 20);
					LTP.GlobalMessageBus.publish('leftColorChanged', colors[i]);
				}
			})(i);
		}

		var keyListener = new LTP.KeyListener(keyListenerConfig);
		
		Ext.onReady(function() {
			Ext.create('LTP.StatusBar', {
				renderTo: 'statusBarElement'
			});
			LTP.GlobalMessageBus.publish('leftColorChanged', colors[0]);
		});

	</script>
</body>
</html>

	
