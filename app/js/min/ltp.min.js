Ext.override(Ext.data.proxy.WebStorage,{setRecord:function(j,c){if(c){j.setId(c);}else{c=j.getId();}var l=this,a=j.data,g={},h=l.model,k=h.prototype.fields.items,d=k.length,f=0,m,b,e,n;for(;f<d;f++){m=k[f];if(m.persist!==false){b=m.name;if(typeof m.encode=="function"){g[b]=m.encode(a[b],j);}else{g[b]=a[b];}}}e=l.getStorageObject();n=l.getRecordKey(c);l.cache[c]=j;e.removeItem(n);e.setItem(n,Ext.encode(g));}});var jscolor={dir:"js/lib/jscolor/",bindClass:"color",binding:false,preloading:false,getDir:function(){if(!jscolor.dir){var a=jscolor.detectDir();jscolor.dir=a!==false?a:"jscolor/";}return jscolor.dir;},detectDir:function(){var c=location.href;var d=document.getElementsByTagName("base");for(var a=0;a<d.length;a+=1){if(d[a].href){c=d[a].href;}}var d=document.getElementsByTagName("script");for(var a=0;a<d.length;a+=1){if(d[a].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(d[a].src)){var f=new jscolor.URI(d[a].src);var b=f.toAbsolute(c);b.path=b.path.replace(/[^\/]+$/,"");b.query=null;b.fragment=null;return b.toString();}}return false;},bind:function(){var matchClass=new RegExp("(^|\\s)("+jscolor.bindClass+")\\s*(\\{[^}]*\\})?","i");var e=document.getElementsByTagName("input");for(var i=0;i<e.length;i+=1){var m;if(!e[i].color&&e[i].className&&(m=e[i].className.match(matchClass))){var prop={};if(m[3]){try{eval("prop="+m[3]);}catch(eInvalidProp){}}e[i].color=new jscolor.color(e[i],prop);}}},preload:function(){for(var a in jscolor.imgRequire){if(jscolor.imgRequire.hasOwnProperty(a)){jscolor.loadImage(a);}}},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(a){jscolor.imgRequire[a]=true;},loadImage:function(a){if(!jscolor.imgLoaded[a]){jscolor.imgLoaded[a]=new Image();jscolor.imgLoaded[a].src=jscolor.getDir()+a;}},fetchElement:function(a){return typeof a==="string"?document.getElementById(a):a;},addEvent:function(a,c,b){if(a.addEventListener){a.addEventListener(c,b,false);}else{if(a.attachEvent){a.attachEvent("on"+c,b);}}},fireEvent:function(a,c){if(!a){return;}if(document.createEvent){var b=document.createEvent("HTMLEvents");b.initEvent(c,true,true);a.dispatchEvent(b);}else{if(document.createEventObject){var b=document.createEventObject();a.fireEvent("on"+c,b);}else{if(a["on"+c]){a["on"+c]();}}}},getElementPos:function(c){var d=c,b=c;var a=0,f=0;if(d.offsetParent){do{a+=d.offsetLeft;f+=d.offsetTop;}while(d=d.offsetParent);}while((b=b.parentNode)&&b.nodeName.toUpperCase()!=="BODY"){a-=b.scrollLeft;f-=b.scrollTop;}return[a,f];},getElementSize:function(a){return[a.offsetWidth,a.offsetHeight];},getRelMousePos:function(b){var a=0,c=0;if(!b){b=window.event;}if(typeof b.offsetX==="number"){a=b.offsetX;c=b.offsetY;}else{if(typeof b.layerX==="number"){a=b.layerX;c=b.layerY;}}return{x:a,y:c};},getViewPos:function(){if(typeof window.pageYOffset==="number"){return[window.pageXOffset,window.pageYOffset];}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){return[document.body.scrollLeft,document.body.scrollTop];}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){return[document.documentElement.scrollLeft,document.documentElement.scrollTop];}else{return[0,0];}}}},getViewSize:function(){if(typeof window.innerWidth==="number"){return[window.innerWidth,window.innerHeight];}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){return[document.body.clientWidth,document.body.clientHeight];}else{if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){return[document.documentElement.clientWidth,document.documentElement.clientHeight];}else{return[0,0];}}}},URI:function(a){this.scheme=null;this.authority=null;this.path="";this.query=null;this.fragment=null;this.parse=function(d){var c=d.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);this.scheme=c[3]?c[2]:null;this.authority=c[5]?c[6]:null;this.path=c[7];this.query=c[9]?c[10]:null;this.fragment=c[12]?c[13]:null;return this;};this.toString=function(){var c="";if(this.scheme!==null){c=c+this.scheme+":";}if(this.authority!==null){c=c+"//"+this.authority;}if(this.path!==null){c=c+this.path;}if(this.query!==null){c=c+"?"+this.query;}if(this.fragment!==null){c=c+"#"+this.fragment;}return c;};this.toAbsolute=function(e){var e=new jscolor.URI(e);var d=this;var c=new jscolor.URI;if(e.scheme===null){return false;}if(d.scheme!==null&&d.scheme.toLowerCase()===e.scheme.toLowerCase()){d.scheme=null;}if(d.scheme!==null){c.scheme=d.scheme;c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.authority!==null){c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.path===""){c.path=e.path;if(d.query!==null){c.query=d.query;}else{c.query=e.query;}}else{if(d.path.substr(0,1)==="/"){c.path=b(d.path);}else{if(e.authority!==null&&e.path===""){c.path="/"+d.path;}else{c.path=e.path.replace(/[^\/]+$/,"")+d.path;}c.path=b(c.path);}c.query=d.query;}c.authority=e.authority;}c.scheme=e.scheme;}c.fragment=d.fragment;return c;};function b(e){var c="";while(e){if(e.substr(0,3)==="../"||e.substr(0,2)==="./"){e=e.replace(/^\.+/,"").substr(1);}else{if(e.substr(0,3)==="/./"||e==="/."){e="/"+e.substr(3);}else{if(e.substr(0,4)==="/../"||e==="/.."){e="/"+e.substr(4);c=c.replace(/\/?[^\/]*$/,"");}else{if(e==="."||e===".."){e="";}else{var d=e.match(/^\/?[^\/]*/)[0];e=e.substr(d.length);c=c+d;}}}}}return c;}if(a){this.parse(a);}},color:function(target,prop){this.required=true;this.adjust=true;this.hash=false;this.caps=true;this.slider=true;this.valueElement=target;this.styleElement=target;this.onImmediateChange=null;this.hsv=[0,0,1];this.rgb=[1,1,1];this.pickerOnfocus=true;this.pickerMode="HSV";this.pickerPosition="bottom";this.pickerSmartPosition=true;this.pickerButtonHeight=20;this.pickerClosable=false;this.pickerCloseText="Close";this.pickerButtonColor="ButtonText";this.pickerFace=10;this.pickerFaceColor="ThreeDFace";this.pickerBorder=1;this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight";this.pickerInset=1;this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow";this.pickerZIndex=10000;for(var p in prop){if(prop.hasOwnProperty(p)){this[p]=prop[p];}}this.hidePicker=function(){if(isPickerOwner()){removePicker();}};this.showPicker=function(){if(!isPickerOwner()){var tp=jscolor.getElementPos(target);var ts=jscolor.getElementSize(target);var vp=jscolor.getViewPos();var vs=jscolor.getViewSize();var ps=getPickerDims(this);var a,b,c;switch(this.pickerPosition.toLowerCase()){case"left":a=1;b=0;c=-1;break;case"right":a=1;b=0;c=1;break;case"top":a=0;b=1;c=-1;break;default:a=0;b=1;c=1;break;}var l=(ts[b]+ps[b])/2;if(!this.pickerSmartPosition){var pp=[tp[a],tp[b]+ts[b]-l+l*c];}else{var pp=[-vp[a]+tp[a]+ps[a]>vs[a]?(-vp[a]+tp[a]+ts[a]/2>vs[a]/2&&tp[a]+ts[a]-ps[a]>=0?tp[a]+ts[a]-ps[a]:tp[a]):tp[a],-vp[b]+tp[b]+ts[b]+ps[b]-l+l*c>vs[b]?(-vp[b]+tp[b]+ts[b]/2>vs[b]/2&&tp[b]+ts[b]-l-l*c>=0?tp[b]+ts[b]-l-l*c:tp[b]+ts[b]-l+l*c):(tp[b]+ts[b]-l+l*c>=0?tp[b]+ts[b]-l+l*c:tp[b]+ts[b]-l-l*c)];}drawPicker(pp[a],pp[b]);}};this.importColor=function(){if(!valueElement){this.exportColor();}else{if(!this.adjust){if(!this.fromString(valueElement.value,leaveValue)){styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor;styleElement.style.color=styleElement.jscStyle.color;this.exportColor(leaveValue|leaveStyle);}}else{if(!this.required&&/^\s*$/.test(valueElement.value)){valueElement.value="";styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor;styleElement.style.color=styleElement.jscStyle.color;this.exportColor(leaveValue|leaveStyle);}else{if(this.fromString(valueElement.value)){}else{this.exportColor();}}}}};this.exportColor=function(flags){if(!(flags&leaveValue)&&valueElement){var value=this.toString();if(this.caps){value=value.toUpperCase();}if(this.hash){value="#"+value;}valueElement.value=value;}if(!(flags&leaveStyle)&&styleElement){styleElement.style.backgroundColor="#"+this.toString();styleElement.style.color=0.213*this.rgb[0]+0.715*this.rgb[1]+0.072*this.rgb[2]<0.5?"#FFF":"#000";}if(!(flags&leavePad)&&isPickerOwner()){redrawPad();}if(!(flags&leaveSld)&&isPickerOwner()){redrawSld();}};this.fromHSV=function(h,s,v,flags){h<0&&(h=0)||h>6&&(h=6);s<0&&(s=0)||s>1&&(s=1);v<0&&(v=0)||v>1&&(v=1);this.rgb=HSV_RGB(h===null?this.hsv[0]:(this.hsv[0]=h),s===null?this.hsv[1]:(this.hsv[1]=s),v===null?this.hsv[2]:(this.hsv[2]=v));this.exportColor(flags);};this.fromRGB=function(r,g,b,flags){r<0&&(r=0)||r>1&&(r=1);g<0&&(g=0)||g>1&&(g=1);b<0&&(b=0)||b>1&&(b=1);var hsv=RGB_HSV(r===null?this.rgb[0]:(this.rgb[0]=r),g===null?this.rgb[1]:(this.rgb[1]=g),b===null?this.rgb[2]:(this.rgb[2]=b));if(hsv[0]!==null){this.hsv[0]=hsv[0];}if(hsv[2]!==0){this.hsv[1]=hsv[1];}this.hsv[2]=hsv[2];this.exportColor(flags);};this.fromString=function(hex,flags){var m=hex.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);if(!m){return false;}else{if(m[1].length===6){this.fromRGB(parseInt(m[1].substr(0,2),16)/255,parseInt(m[1].substr(2,2),16)/255,parseInt(m[1].substr(4,2),16)/255,flags);}else{this.fromRGB(parseInt(m[1].charAt(0)+m[1].charAt(0),16)/255,parseInt(m[1].charAt(1)+m[1].charAt(1),16)/255,parseInt(m[1].charAt(2)+m[1].charAt(2),16)/255,flags);}return true;}};this.toString=function(){return((256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1));};function RGB_HSV(r,g,b){var n=Math.min(Math.min(r,g),b);var v=Math.max(Math.max(r,g),b);var m=v-n;if(m===0){return[null,0,v];}var h=r===n?3+(b-g)/m:(g===n?5+(r-b)/m:1+(g-r)/m);return[h===6?0:h,m/v,v];}function HSV_RGB(h,s,v){if(h===null){return[v,v,v];}var i=Math.floor(h);var f=i%2?h-i:1-(h-i);var m=v*(1-s);var n=v*(1-s*f);switch(i){case 6:case 0:return[v,n,m];case 1:return[n,v,m];case 2:return[m,v,n];case 3:return[m,n,v];case 4:return[n,m,v];case 5:return[v,m,n];}}function removePicker(){delete jscolor.picker.owner;document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB);}function drawPicker(x,y){if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),btn:document.createElement("div"),btnS:document.createElement("span"),btnT:document.createTextNode(THIS.pickerCloseText)};for(var elem in jscolor.picker){if(jscolor.picker.hasOwnProperty(elem)){jscolor.picker[elem].id="jscolor."+elem;}}for(var i=0,segSize=4;i<jscolor.images.sld[1];i+=segSize){var seg=document.createElement("div");seg.style.height=segSize+"px";seg.style.fontSize="1px";seg.style.lineHeight="0";jscolor.picker.sld.appendChild(seg);}jscolor.picker.sldB.appendChild(jscolor.picker.sld);jscolor.picker.box.appendChild(jscolor.picker.sldB);jscolor.picker.box.appendChild(jscolor.picker.sldM);jscolor.picker.padB.appendChild(jscolor.picker.pad);jscolor.picker.box.appendChild(jscolor.picker.padB);jscolor.picker.box.appendChild(jscolor.picker.padM);jscolor.picker.btnS.appendChild(jscolor.picker.btnT);jscolor.picker.btn.appendChild(jscolor.picker.btnS);jscolor.picker.box.appendChild(jscolor.picker.btn);jscolor.picker.boxB.appendChild(jscolor.picker.box);}var p=jscolor.picker;p.box.onmouseup=p.box.onmouseout=function(){target.focus();};p.box.onmousedown=function(){abortBlur=true;};p.box.onmousemove=function(e){if(holdPad||holdSld){holdPad&&setPad(e);holdSld&&setSld(e);if(document.selection){document.selection.empty();}else{if(window.getSelection){window.getSelection().removeAllRanges();}}dispatchImmediateChange();}};p.padM.onmouseup=p.padM.onmouseout=function(){if(holdPad){holdPad=false;jscolor.fireEvent(valueElement,"change");}};p.padM.onmousedown=function(e){holdPad=true;setPad(e);dispatchImmediateChange();};p.sldM.onmouseup=p.sldM.onmouseout=function(){if(holdSld){holdSld=false;jscolor.fireEvent(valueElement,"change");}};p.sldM.onmousedown=function(e){holdSld=true;setSld(e);dispatchImmediateChange();};var dims=getPickerDims(THIS);p.box.style.width=dims[0]+"px";p.box.style.height=dims[1]+"px";p.boxB.style.position="absolute";p.boxB.style.clear="both";p.boxB.style.left=x+"px";p.boxB.style.top=y+"px";p.boxB.style.zIndex=THIS.pickerZIndex;p.boxB.style.border=THIS.pickerBorder+"px solid";p.boxB.style.borderColor=THIS.pickerBorderColor;p.boxB.style.background=THIS.pickerFaceColor;p.pad.style.width=jscolor.images.pad[0]+"px";p.pad.style.height=jscolor.images.pad[1]+"px";p.padB.style.position="absolute";p.padB.style.left=THIS.pickerFace+"px";p.padB.style.top=THIS.pickerFace+"px";p.padB.style.border=THIS.pickerInset+"px solid";p.padB.style.borderColor=THIS.pickerInsetColor;p.padM.style.position="absolute";p.padM.style.left="0";p.padM.style.top="0";p.padM.style.width=THIS.pickerFace+2*THIS.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px";p.padM.style.height=p.box.style.height;p.padM.style.cursor="crosshair";p.sld.style.overflow="hidden";p.sld.style.width=jscolor.images.sld[0]+"px";p.sld.style.height=jscolor.images.sld[1]+"px";p.sldB.style.display=THIS.slider?"block":"none";p.sldB.style.position="absolute";p.sldB.style.right=THIS.pickerFace+"px";p.sldB.style.top=THIS.pickerFace+"px";p.sldB.style.border=THIS.pickerInset+"px solid";p.sldB.style.borderColor=THIS.pickerInsetColor;p.sldM.style.display=THIS.slider?"block":"none";p.sldM.style.position="absolute";p.sldM.style.right="0";p.sldM.style.top="0";p.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+THIS.pickerFace+2*THIS.pickerInset+"px";p.sldM.style.height=p.box.style.height;try{p.sldM.style.cursor="pointer";}catch(eOldIE){p.sldM.style.cursor="hand";}function setBtnBorder(){var insetColors=THIS.pickerInsetColor.split(/\s+/);var pickerOutsetColor=insetColors.length<2?insetColors[0]:insetColors[1]+" "+insetColors[0]+" "+insetColors[0]+" "+insetColors[1];p.btn.style.borderColor=pickerOutsetColor;}p.btn.style.display=THIS.pickerClosable?"block":"none";p.btn.style.position="absolute";p.btn.style.left=THIS.pickerFace+"px";p.btn.style.bottom=THIS.pickerFace+"px";p.btn.style.padding="0 15px";p.btn.style.height="18px";p.btn.style.border=THIS.pickerInset+"px solid";setBtnBorder();p.btn.style.color=THIS.pickerButtonColor;p.btn.style.font="12px sans-serif";p.btn.style.textAlign="center";try{p.btn.style.cursor="pointer";}catch(eOldIE){p.btn.style.cursor="hand";}p.btn.onmousedown=function(){THIS.hidePicker();};p.btnS.style.lineHeight=p.btn.style.height;switch(modeID){case 0:var padImg="hs.png";break;case 1:var padImg="hv.png";break;}p.padM.style.backgroundImage="url('"+jscolor.getDir()+"cross.gif')";p.padM.style.backgroundRepeat="no-repeat";p.sldM.style.backgroundImage="url('"+jscolor.getDir()+"arrow.gif')";p.sldM.style.backgroundRepeat="no-repeat";p.pad.style.backgroundImage="url('"+jscolor.getDir()+padImg+"')";p.pad.style.backgroundRepeat="no-repeat";p.pad.style.backgroundPosition="0 0";redrawPad();redrawSld();jscolor.picker.owner=THIS;document.getElementsByTagName("body")[0].appendChild(p.boxB);}function getPickerDims(o){var dims=[2*o.pickerInset+2*o.pickerFace+jscolor.images.pad[0]+(o.slider?2*o.pickerInset+2*jscolor.images.arrow[0]+jscolor.images.sld[0]:0),o.pickerClosable?4*o.pickerInset+3*o.pickerFace+jscolor.images.pad[1]+o.pickerButtonHeight:2*o.pickerInset+2*o.pickerFace+jscolor.images.pad[1]];return dims;}function redrawPad(){switch(modeID){case 0:var yComponent=1;break;case 1:var yComponent=2;break;}var x=Math.round((THIS.hsv[0]/6)*(jscolor.images.pad[0]-1));var y=Math.round((1-THIS.hsv[yComponent])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=(THIS.pickerFace+THIS.pickerInset+x-Math.floor(jscolor.images.cross[0]/2))+"px "+(THIS.pickerFace+THIS.pickerInset+y-Math.floor(jscolor.images.cross[1]/2))+"px";var seg=jscolor.picker.sld.childNodes;switch(modeID){case 0:var rgb=HSV_RGB(THIS.hsv[0],THIS.hsv[1],1);for(var i=0;i<seg.length;i+=1){seg[i].style.backgroundColor="rgb("+(rgb[0]*(1-i/seg.length)*100)+"%,"+(rgb[1]*(1-i/seg.length)*100)+"%,"+(rgb[2]*(1-i/seg.length)*100)+"%)";}break;case 1:var rgb,s,c=[THIS.hsv[2],0,0];var i=Math.floor(THIS.hsv[0]);var f=i%2?THIS.hsv[0]-i:1-(THIS.hsv[0]-i);switch(i){case 6:case 0:rgb=[0,1,2];break;case 1:rgb=[1,0,2];break;case 2:rgb=[2,0,1];break;case 3:rgb=[2,1,0];break;case 4:rgb=[1,2,0];break;case 5:rgb=[0,2,1];break;}for(var i=0;i<seg.length;i+=1){s=1-1/(seg.length-1)*i;c[1]=c[0]*(1-s*f);c[2]=c[0]*(1-s);seg[i].style.backgroundColor="rgb("+(c[rgb[0]]*100)+"%,"+(c[rgb[1]]*100)+"%,"+(c[rgb[2]]*100)+"%)";}break;}}function redrawSld(){switch(modeID){case 0:var yComponent=2;break;case 1:var yComponent=1;break;}var y=Math.round((1-THIS.hsv[yComponent])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(THIS.pickerFace+THIS.pickerInset+y-Math.floor(jscolor.images.arrow[1]/2))+"px";}function isPickerOwner(){return jscolor.picker&&jscolor.picker.owner===THIS;}function blurTarget(){if(valueElement===target){THIS.importColor();}if(THIS.pickerOnfocus){THIS.hidePicker();}}function blurValue(){if(valueElement!==target){THIS.importColor();}}function setPad(e){var mpos=jscolor.getRelMousePos(e);var x=mpos.x-THIS.pickerFace-THIS.pickerInset;var y=mpos.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)),1-y/(jscolor.images.pad[1]-1),null,leaveSld);break;case 1:THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)),null,1-y/(jscolor.images.pad[1]-1),leaveSld);break;}}function setSld(e){var mpos=jscolor.getRelMousePos(e);var y=mpos.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(null,null,1-y/(jscolor.images.sld[1]-1),leavePad);break;case 1:THIS.fromHSV(null,1-y/(jscolor.images.sld[1]-1),null,leavePad);break;}}function dispatchImmediateChange(){if(THIS.onImmediateChange){if(typeof THIS.onImmediateChange==="string"){eval(THIS.onImmediateChange);}else{THIS.onImmediateChange(THIS);}}}var THIS=this;var modeID=this.pickerMode.toLowerCase()==="hvs"?1:0;var abortBlur=false;var valueElement=jscolor.fetchElement(this.valueElement),styleElement=jscolor.fetchElement(this.styleElement);var holdPad=false,holdSld=false;var leaveValue=1<<0,leaveStyle=1<<1,leavePad=1<<2,leaveSld=1<<3;jscolor.addEvent(target,"focus",function(){if(THIS.pickerOnfocus){THIS.showPicker();}});jscolor.addEvent(target,"blur",function(){if(!abortBlur){window.setTimeout(function(){abortBlur||blurTarget();abortBlur=false;},0);}else{abortBlur=false;}});if(valueElement){var updateField=function(){THIS.fromString(valueElement.value,leaveValue);dispatchImmediateChange();};jscolor.addEvent(valueElement,"keyup",updateField);jscolor.addEvent(valueElement,"input",updateField);jscolor.addEvent(valueElement,"blur",blurValue);valueElement.setAttribute("autocomplete","off");}if(styleElement){styleElement.jscStyle={backgroundColor:styleElement.style.backgroundColor,color:styleElement.style.color};}switch(modeID){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png");break;}jscolor.requireImage("cross.gif");jscolor.requireImage("arrow.gif");this.importColor();}};(function(){if(typeof Object.defineProperty!=="function"&&typeof Object.__defineGetter__==="function"){Object.defineProperty=function(c,b,a){if(typeof a.get==="function"){c.__defineGetter__(b,a.get);}if(typeof a.set==="function"){c.__defineSetter__(b,a.set);}};}})();(function(){function b(){return this;}function a(){var e=navigator.userAgent;var d=navigator.platform;info={};info.isOSX=(/Mac/i).test(d);info.isWindows=(/Windows/i).test(d);info.isLinux=(/Linux/i).test(d);info.isChrome=(/Chrome/i).test(e);info.isSafari=(/Safari/i).test(e)&&!info.isChrome;info.isFirefox=(/Firefox/i).test(e);info.isIE=(/MSIE/).test(e)&&info.isWindows;info.isOpera=(/Opera/i).test(e);return info;}var c=b.call(null);c.LTP=c.LTP||{};LTP.util={platformInfo:a(),ns:function(){for(var g=0,f=arguments.length;g<f;++g){var h=arguments[g].split(".");var d=h.indexOf("LTP")===0?c:LTP;for(var e=0,j=h.length;e<j;++e){if(d[h[e]]===undefined){d[h[e]]={};}d=d[h[e]];}}},bind:function(e,d){return function(){e.apply(d,arguments);};},toArray:function(e){var d=[];for(var f=0;f<e.length;++f){d.push(e[f]);}return d;},canvas:function(e,g){var d=document.createElement("canvas");d.width=e.width;d.height=e.height;if(g){for(var f in g){if(g.hasOwnProperty(f)){d.style[f]=g[f];}}}this.setImageRendering(d);return d;},setImageRendering:function(e){var d="optimizeSpeed";if(this.platformInfo.isChrome){d="-webkit-optimize-contrast";}else{if(this.platformInfo.isFirefox){d="-moz-crisp-edges";}}e.style.imageRendering=d;},scaleSize:function(d,h){if(d.width<=h.width&&d.height<=h.height){return s(d.width,d.height);}var g=h.width/d.width;var e=h.height/d.height;var f=Math.min(g,e);return sr(d.width*f,d.height*f);},waitFor:function(d,f){if(d()){f();}else{var e=this;setTimeout(function(){e.waitFor(d,f);},50);}}};Object.defineProperty(LTP.util,"global",{get:function(){return c;},enumerable:true});})();(function(){LTP.compatibilityInfo=function(){var b={desktop:{available:Ext.is.Desktop,message:"LTP does not work on mobile devices yet",severity:4},"Object.defineProperty":{available:(function(){if(typeof Object.defineProperty!=="function"){return false;}var g=[document.createElement("div"),{}];try{for(var f=0;f<g.length;++f){var h=g[f];Object.defineProperty(h,"definePropTest",{get:function(){return 41;}});if(h.definePropTest!==41){return false;}}}catch(h){return false;}return true;})(),message:"Object.defineProperty is missing",severity:3},canvas:{available:!!window.HTMLCanvasElement,message:"canvas is missing",severity:2},"image-rendering":{available:(function(){var f=false;if(LTP.util.platformInfo.isChrome){f=LTP.util.platformInfo.isOSX;}if(LTP.util.platformInfo.isFirefox){f=true;}return f;})(),message:"nearest neighbor for image-rendering is missing (or buggy in the case of Chrome on Windows)",severity:1},FileReader:{available:!!window.FileReader,message:"FileReader is missing (drag and drop operations won't be available)",severity:0},"Internet Explorer":{available:!Ext.isIE,message:"IE lacks key needed features",severity:4},Opera:{available:!LTP.util.platformInfo.isOpera,message:"Not all Opera issues have been resolved",severity:4}};var c=true;var a=-1;var e;for(var d in b){if(b.hasOwnProperty(d)){c=c&&b[d].available;if(!b[d].available){a=Math.max(a,b[d].severity);if(a===b[d].severity){e=b[d].message;}}}}b.success=c;b.conclusion=e;return b;};})();(function(){Ext.define("LTP.LayerModel",{extend:"Ext.data.Model",fields:[{name:"layerId",type:"integer"},{name:"ltp.projectmodel_id",type:"integer"},{name:"layerName",type:"string"},{name:"index",type:"integer"},{name:"isVisible",type:"boolean"},{name:"data",type:"string"},{name:"thumbnailData",type:"string",persist:false},{name:"thumbnailHeight",type:"integer",persist:false},{name:"thumbnailWidth",type:"integer",persist:false}],associations:[{type:"belongsTo",model:"LTP.ProjectModel",name:"project"}],idProperty:"layerId",proxy:{type:"localstorage",id:"ltp-layers"}});})();(function(){Ext.define("LTP.ProjectModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"integer"},{name:"name",type:"string"},{name:"width",type:"integer"},{name:"height",type:"integer"},{name:"palette",type:"string"},{name:"lastSaved",type:"date"}],associations:[{type:"hasMany",model:"LTP.LayerModel",name:"layers",autoLoad:true}],proxy:{type:"localstorage",id:"ltp-projects"}});})();(function(){LTP.ProjectPersister=function a(){this._projectStore=Ext.create("Ext.data.Store",{model:"LTP.ProjectModel",autoLoad:false});};LTP.ProjectPersister.prototype={loadAllProjects:function(c,b){this._projectStore.load({scope:this,callback:function(){this._extract(this._projectStore,c,b);}});},saveProject:function(e,d,f){e.width=e.size.width;e.height=e.size.height;e.lastSaved=new Date();e.palette=f;var c;if(e.id){c=this._projectStore.getById(e.id);}else{c=this._projectStore.add({})[0];}c.data=e;c.dirty=true;this._projectStore.sync();var b=c.layers();Ext.Array.each(d,function(h){var g;if(h.layerId){g=b.getById(h.layerId);}else{g=b.add({})[0];}g.data=h;g.dirty=true;b.add(g);});b.each(function(g){if(!g.dirty){g.destroy();}});b.sync();},_extract:function(d,f,c){this.projects=[];var e=this;var b=d.count();if(b===0){f.call(c,e.projects);}else{d.each(function(h){var i=h.data;i.size=s(i.width,i.height);i.layers=[];var g=h.layers();g.each(function(j){i.layers.push(j.data);});this._createThumbnail(i,function(){--b;if(b===0){f.call(c,e.projects);}});this.projects.push(i);},this);}},_createThumbnail:function(c,d){var b=new LTP.LayerManager(c,new LTP.MessageBus(LTP.GlobalMessages));LTP.util.waitFor(function(){return b.dataLoaded;},function(){var e=b.composite(s(200,100));c.thumbnailData=e.toDataURL();c.thumbnailHeight=e.height;c.thumbnailWidth=e.width;d();});}};})();(function(){LTP.ImageLoader={load:function a(c,e,b,d){this.loadToDataURL(c,function(f){this.fromDataUrlToImg(f,e,d);},function(f){b.call(d,f);},this);},loadToDataURL:function(d,f,c,e){if(d.type.indexOf("image/")!==0){c.call(e,"Chosen file is not an image: "+d.name);}else{var b=new FileReader();b.onload=function(g){f.call(e,g.target.result);};b.readAsDataURL(d);}},fromDataUrlToImg:function(d,e,c){var b=document.createElement("img");b.onload=function(){e.call(c,b);};b.src=d;},createThumbnail:function(c,e,d,b){this.fromDataUrlToImg(c,function(g){var h=document.createElement("canvas");var j=g.width-e.width;var i=g.height-e.height;var f;if(j>0&&j>i){f=e.width/g.width;}else{if(i>0&&i>j){f=e.height/g.height;}}if(f){h.width=g.width*f;h.height=g.height*f;}else{h.width=g.width;h.height=g.height;}h.getContext("2d").drawImage(g,0,0,g.width,g.height,0,0,h.width,h.height);d.call(b,h.toDataURL("png"),s(h.width,h.height));});}};})();(function(){LTP.util.global.colors={black:"#000000",white:"#FFFFFF",red:"#FF0000",blue:"#0000FF",green:"#00FF00",yellow:"#FFFF00",orange:"#FF8800",purple:"#CC00FF",gray:"#888888",lightGray:"#BBBBBB",brown:"#773355",isHexString:function(a){if(typeof a!=="string"){return false;}if(a[0]!=="#"||a.length!==7){return false;}if(a.toUpperCase()!==a){return false;}return parseInt(a.substring(1),16)!==NaN;},fromArrayToHex:function(f,b){var a="#";var e=(b&&b.includeAlpha&&f.length===4)?4:3;for(var c=0;c<e;++c){var d=f[c].toString(16);if(d.length<2){d="0"+d;}a+=d;}return a.toUpperCase();},fromHexToArray:function(e,c){e=e.substring(1);var b=e.substring(0,2);var a=e.substring(2,4);var d=e.substring(4,6);result=[parseInt(b,16),parseInt(a,16),parseInt(d,16),];if(c&&c.includeAlpha){result.push(255);}return result;},invert:function(b){var c=this.fromHexToArray(b);for(var a=0;a<c.length;++a){c[a]=255-c[a];}return this.fromArrayToHex(c);}};})();(function(){LTP.MessageBus=function e(f){if(!f||!f.length){throw new Error("MessageBus: messages is required");}this._messages=f;this._subscribers={};};LTP.MessageBus.prototype={subscribe:function c(g,h,f){if(!this._messageExists(g)){throw new Error("MessageBus.subscribe: subscribing to a nonexistant message: "+g);}if(typeof h!=="function"){throw new Error("MessageBus.subscribe: must provide a a callback when subscribing");}this._subscribers[g]=this._subscribers[g]||[];this._subscribers[g].push({scope:f,callback:h});},unsubscribe:function b(h,k){if(!this._messageExists(h)){throw new Error("MessageBus.unsubscribe: non existant message: "+h);}var j=this._subscribers[h];if(j){var g=-1;for(var f=0;f<j.length;++f){if(j[f].callback===k){g=f;break;}}if(g>=0){j.splice(g,1);}}},publish:function a(j){if(!this._messageExists(j)){throw new Error("MessageBus.publish: publishing a non existant message: "+j);}var k=this._subscribers[j];if(k&&k.length){var f=LTP.util.toArray(arguments).slice(1);for(var g=0;g<k.length;++g){var h=k[g];h.callback.apply(h.scope||null,f);}}},_messageExists:function d(f){return this._messages.indexOf(f)>=0;},};})();(function(){LTP.PointTransformer=function a(b){this._pageOffsets=b||window;};LTP.PointTransformer.prototype={transform:function(c){var d=1/(this.zoom);var b=this._pageOffsets.pageXOffset*d;var g=this._pageOffsets.pageYOffset*d;var f=c.x*d+b;var e=c.y*d+g;f=Math.ceil(f);e=Math.ceil(e);return p(f,e);}};Object.defineProperty(LTP.PointTransformer.prototype,"zoom",{get:function(){return this._zoom||1;},set:function(b){this._zoom=b;}});})();(function(){LTP.Rectangle=function a(c,e,d,b){this._x=c||0;this._y=e||0;this._width=d||0;this._height=b||0;if(this._width<0||this._height<0){throw new Error("Rectangle: negative sizes are not allowed");}};LTP.Rectangle.prototype={equals:function(b){if(b){return b===this||(b.x===this._x&&b.y===this._y&&b.width===this._width&&b.height===this._height);}else{return false;}},clipInside:function(d){var h=Math.max(this.x,d.x);var e=Math.min(this.x+this.width,d.x+d.width);var g=Math.max(this.y,d.y);var c=Math.min(this.y+this.height,d.y+d.height);var f=e-h;var b=c-g;if(f>0&&b>0){return r(h,g,f,b);}else{return r(0,0,0,0);}}};Object.defineProperty(LTP.Rectangle.prototype,"x",{get:function(){return this._x;}});Object.defineProperty(LTP.Rectangle.prototype,"y",{get:function(){return this._y;}});Object.defineProperty(LTP.Rectangle.prototype,"width",{get:function(){return this._width;}});Object.defineProperty(LTP.Rectangle.prototype,"height",{get:function(){return this._height;}});Object.defineProperty(LTP.Rectangle.prototype,"hasArea",{get:function(){return this.height*this.width>0;}});})();(function(){LTP.Pair=function c(e,d){this._a=e||0;this._b=d||0;};LTP.Pair.prototype={equals:function b(d){if(d){return(d===this)||(d._a===this._a&&d._b==this._b)||(d.x===this._a&&d.y==this._b)||(d.width==this._a&&d.height==this._b);}return false;},toString:function a(){return"["+this._a+","+this._b+"]";}};Object.defineProperty(LTP.Pair.prototype,"width",{get:function(){return this._a;}});Object.defineProperty(LTP.Pair.prototype,"height",{get:function(){return this._b;}});Object.defineProperty(LTP.Pair.prototype,"x",{get:function(){return this._a;}});Object.defineProperty(LTP.Pair.prototype,"y",{get:function(){return this._b;}});})();(function(){LTP.BoundingBoxBuilder=function b(c){c=c||new LTP.Rectangle();this._minX=c.x;this._maxX=c.x+c.width;this._minY=c.y;this._maxY=c.y+c.height;};LTP.BoundingBoxBuilder.prototype={append:function a(c){if(!c){throw new Error("BoundingBoxBuilder.append: rect argument is required");}this._minX=Math.min(this._minX,c.x);this._minY=Math.min(this._minY,c.y);this._maxX=Math.max(this._maxX,c.x+c.width);this._maxY=Math.max(this._maxY,c.y+c.height);}};Object.defineProperty(LTP.BoundingBoxBuilder.prototype,"boundingBox",{get:function(){return r(this._minX,this._minY,this._maxX-this._minX,this._maxY-this._minY);}});})();(function(){LTP.ColorManager=function a(c,b){this._colors=c||[colors.black,colors.white];this._leftColorIndex=0;this._rightColorIndex=1;this._messageBus=b||LTP.GlobalMessageBus;};LTP.ColorManager.prototype={getColorsAsString:function(){return this._colors.join(",");},setColorsFromString:function(b,c){if(!b){this._colors=c;}else{this._colors=b.split(",");}if(!this._colors||this._colors.length===0||(this._colors.length===1&&!this._colors[0])){this._colors=c;}if(this._leftColorIndex>this._colors.length-1){this._leftColorIndex=0;}if(this._rightColorIndex>this._colors.length-1){if(this._colors.length>1){this._rightColorIndex=1;}else{this._rightColorIndex=0;}}},setLeftColorTo:function(b){if(this._inRange(b)){this._leftColorIndex=b;this._messageBus.publish("leftColorSelected",this.leftColor,this._leftColorIndex);}},setRightColorTo:function(b){if(this._inRange(b)){this._rightColorIndex=b;this._messageBus.publish("rightColorSelected",this.rightColor,this._rightColorIndex);}},addColor:function(b){if(!colors.isHexString(b)){throw new Error("Attempted to add a color that is not in hex format: "+b);}this._colors.push(b);this._messageBus.publish("paletteContentChange");},removeColorAt:function(b){if(this._inRange(b)){this._colors.splice(b,1);this._messageBus.publish("paletteContentChange");}},redefineAt:function(c,b){if(this._inRange(c)){if(this._colors[c]!==b){this._colors[c]=b;this._messageBus.publish("paletteContentChange");}}},moveColor:function(d,c){if(this._inRange(d)&&this._inRange(c)){var b=this._colors.splice(d,1);this._colors.splice(c,0,b[0]);this._messageBus.publish("paletteContentChange");}},_inRange:function(b){return b>=0&&b<this._colors.length;}};Object.defineProperty(LTP.ColorManager.prototype,"colors",{get:function(){return this._colors;},enumerable:true});Object.defineProperty(LTP.ColorManager.prototype,"leftColor",{get:function(){return this._colors[this._leftColorIndex];},enumerable:true});Object.defineProperty(LTP.ColorManager.prototype,"rightColor",{get:function(){return this._colors[this._rightColorIndex];},enumerable:true});})();(function(){LTP.BaseTool=function(a,b){this._causesChange=a;this._cursor=b;};LTP.BaseTool.prototype={perform:function(a){},_dropPoint:function(b,a,d,c){if(a.x+d>=0&&a.x+d<b.canvas.width&&a.y+c>=0&&a.y+c<b.canvas.height){b.fillRect(a.x+d,a.y+c,1,1);}},overlay:function(b,a){b.save();b.globalCompositeOperation="lighter";b.fillStyle=this.overlayColor||"rgba(255, 0, 0, .5)";this._dropPoint(b,a,0,0);b.fillStyle=this.overlayColor||"rgba(255, 0, 255, .5)";this._dropPoint(b,a,-2,0);this._dropPoint(b,a,2,0);this._dropPoint(b,a,0,-2);this._dropPoint(b,a,0,2);b.restore();}};Object.defineProperty(LTP.BaseTool.prototype,"causesChange",{get:function(){return this._causesChange;},enumerable:true});Object.defineProperty(LTP.BaseTool.prototype,"cursor",{get:function(){return this._cursor;},enumerable:true});})();(function(){var b=true;var a="none";LTP.BrushTool=function(){LTP.BaseTool.call(this,b,a);};LTP.BrushTool.prototype=new LTP.BaseTool();LTP.BrushTool.prototype.overlay=function(f,c,e){f.save();var d=this.overlayColor||"rgba(255, 0, 0, .5)";f.globalCompositeOperation="lighter";if(e<3){f.fillStyle=d;this._placePoint(f,c,e);}else{f.strokeStyle=d;f.lineWidth=1;this._placePoint(f,c,e,{stroke:true});}f.restore();};LTP.BrushTool.prototype.getBoundsAt=function(d,e,c){return r(d.x-e,d.y-e,e,e).clipInside(r(0,0,c.width,c.height));};LTP.BrushTool.prototype.perform=function(h){var d=h.context;var c=h.lastPoint;var j=h.currentPoint;d.save();d.fillStyle=h.color;if(c.equals(j)){this._placePoint(d,c,h.size);}else{if(c.x>j.x){var k=c;c=j;j=k;}var i=(j.y-c.y)/(j.x-c.x);var f=c.y-i*c.x;var g=false;while(!g){this._placePoint(d,c,h.size);var l=this._moveTowards(c,j,i,f);g=l.arrived;c=l.point;}}this._placePoint(d,j,h.size);d.restore();};LTP.BrushTool.prototype._placePoint=function(f,c,e,d){var h=d&&d.stroke?f.strokeRect:f.fillRect;var g=d&&d.stroke?0.5:0;h.call(f,c.x-e-g,c.y-e-g,e+(2*g),e+(2*g));};LTP.BrushTool.prototype._moveTowards=function(h,g,f,e){if(f===Infinity||f===-Infinity){if(h.y===g.y){return{arrived:true,point:pr(h.x,h.y)};}else{var j=f===Infinity?1:-1;return{arrived:false,point:pr(h.x,h.y+j)};}}if(h.x===g.x){return{arrived:true,point:pr(h.x,h.y)};}var d,i;if(Math.abs(f)>1){if(g.y>h.y){i=h.y+1;}else{i=h.y-1;}d=(i-e)/f;}else{d=h.x+1;i=d*f+e;}var c=pr(d,i);return{arrived:false,point:c};};})();(function(){var c=false;var b="url(images/cursors/EyeDropper.png), auto";LTP.EyeDropperTool=function a(d){LTP.BaseTool.call(this,c,b);this._messageBus=d||LTP.GlobalMessageBus;};LTP.EyeDropperTool.prototype=new LTP.BaseTool();LTP.EyeDropperTool.prototype.perform=function(g){var d=g.context;var h=g.currentPoint;var f=d.getImageData(h.x,h.y,1,1);this._sampledRgbColor=this._pixelToRgbString(f.data);this._sampledHexColor=colors.fromArrayToHex(f.data);this._messageBus.publish("colorSampled",this._sampledRgbColor,this._sampledHexColor,g.mouseButton);};LTP.EyeDropperTool.prototype._pixelToRgbString=function(d){return"rgb("+d[0]+","+d[1]+","+d[2]+");";};Object.defineProperty(LTP.EyeDropperTool.prototype,"sampledRgbColor",{get:function(){return this._sampledRgbColor;}});Object.defineProperty(LTP.EyeDropperTool.prototype,"sampledHexColor",{get:function(){return this._sampledHexColor;}});})();(function(){var b=false;var a="move";LTP.PanningTool=function(){LTP.BaseTool.call(this,b,a);};LTP.PanningTool.prototype=new LTP.BaseTool();LTP.PanningTool.prototype.perform=function(i){var f=i.containerElement;var c=i.currentPointNonTransformed.y-i.lastPointNonTransformed.y;var d=i.currentPointNonTransformed.x-i.lastPointNonTransformed.x;var g=f.scrollTop-c;var h=f.scrollLeft-d;f.scrollTop=g;f.scrollLeft=h;};LTP.PanningTool.prototype.overlay=function(){};})();(function(){var b=true;var a="url(images/cursors/Fill.png), auto";LTP.FillTool=function(){LTP.BaseTool.call(this,b,a);};LTP.FillTool.prototype=new LTP.BaseTool();LTP.FillTool.prototype._sampleColorAt=function(d,c){var e=d.getImageData(c.x,c.y,1,1);return LTP.util.toArray(e.data);};LTP.FillTool.prototype._areSame=function(d,c){if(d===c){return true;}if(d.length!==c.length){return false;}for(var e=0;e<d.length;++e){if(d[e]!==c[e]){return false;}}return true;};LTP.FillTool.prototype.perform=function(g){if(g.imageCanvas.width!==g.context.canvas.width||g.imageCanvas.height!==g.context.canvas.height){throw new Error("FillTool.perform: source and dest canvases need to be the same size");}var d=g.imageCanvas.getContext("2d");var f=this._sampleColorAt(d,g.currentPoint);var c=colors.fromHexToArray(g.color,{includeAlpha:true});if(!this._areSame(f,c)){this._fill(d,g.context,g.currentPoint,f,c);}};LTP.FillTool.prototype.getBoundsAt=function(){return this._lastBoundingBox||r(0,0,0,0);};LTP.FillTool.prototype._fill=function(o,c,j,v,n){var q=o.getImageData(0,0,o.canvas.width,o.canvas.height);var s=c.getImageData(0,0,c.canvas.width,c.canvas.height);var p=new LTP.BoundingBoxBuilder();function g(w){s.data[w]=n[0];s.data[w+1]=n[1];s.data[w+2]=n[2];s.data[w+3]=n[3];}function k(A){if(s.data[A+3]!==0){return false;}var z=q.data[A];var y=q.data[A+1];var w=q.data[A+2];var x=q.data[A+3];return z===v[0]&&y===v[1]&&w===v[2]&&x===v[3];}var d=[[j.x,j.y]];var f,m,l,u,i,h;var t=c.canvas.width;var e=c.canvas.height;while(d.length){f=d.pop();m=f[0];l=f[1];u=(l*t+m)*4;while(l-->=0&&k(u)){u-=t*4;}u+=t*4;++l;i=false;h=false;while(l++<e-1&&k(u)){g(u);p.append(r(m,l,1,1));if(m>0){if(k(u-4)){if(!i){d.push([m-1,l]);i=true;}}else{if(i){i=false;}}}if(m<t-1){if(k(u+4)){if(!h){d.push([m+1,l]);h=true;}}else{if(h){h=false;}}}u+=t*4;}}c.putImageData(s,0,0);this._lastBoundingBox=p.boundingBox;};})();(function(){LTP.DirectionLockTransformer=function a(b){if(!b){throw new Error("DirectionLockTransformer: direction is required");}this._direction=b;};LTP.DirectionLockTransformer.directions={leftRight:"leftRight",upDown:"upDown"};LTP.DirectionLockTransformer.prototype={transform:function(b,c){if(b.equals(c)){return c;}if(this._direction===LTP.DirectionLockTransformer.directions.leftRight){return p(c.x,b.y);}else{if(this._direction===LTP.DirectionLockTransformer.directions.upDown){return p(b.x,c.y);}}return c;},overlay:function(c,b){c.save();c.fillStyle="blue";if(this._direction===LTP.DirectionLockTransformer.directions.leftRight){c.fillRect(0,b.y,c.canvas.width,1);}else{if(this._direction===LTP.DirectionLockTransformer.directions.upDown){c.fillRect(b.x,0,1,c.canvas.height);}}c.restore();}};Object.defineProperty(LTP.DirectionLockTransformer.prototype,"transformOnHover",{get:function(){return false;},enumerable:true});})();(function(){function b(d,c){return Math.round(d/c)*c;}LTP.BrushSizeLockTransformer=function a(){};LTP.BrushSizeLockTransformer.prototype={transform:function(d,e,c){if(!c){return e;}return p(b(e.x,c),b(e.y,c));}};Object.defineProperty(LTP.BrushSizeLockTransformer.prototype,"transformOnHover",{get:function(){return true;},enumerable:true});Object.defineProperty(LTP.BrushSizeLockTransformer.prototype,"currentPointOnly",{get:function(){return true;},enumerable:true});})();(function(){var a=2000;var d=1999;LTP.Container=function b(g,e,f){if(!g){throw new Error("Container: size is required");}if(!e){throw new Error("Container: containingElement is required");}this._zoom=1;this._imageSize=g;this._containingElement=e;this._layers=[];this._messageBus=f||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",this._onZoomChanged,this);this._messageBus.subscribe("newLayerCreated",this._onNewLayerCreated,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("layerRemoved",this._onLayerRemoved,this);this._messageBus.subscribe("noLayersInProject",this._onNoLayersInProject,this);Ext.fly(this._containingElement.parentNode).on("mousemove",this._onMouseMove,this);this._pointTransformer=new LTP.PointTransformer();this._windowResizeListener=LTP.util.bind(this._onWindowResize,this);window.addEventListener("resize",this._windowResizeListener,false);this._addTransparencyBackdrop();};LTP.Container.prototype={zoomTo:function(e){this._zoom=e;this._pointTransformer.zoom=e;this._containingElement.style.zoom=(Math.round(e*100)).toString()+"%";Ext.Array.each(this._layers,function(f){f.style.MozTransform="scale("+e+")";});this._backdrop.style.MozTransform="scale("+e+")";this._centerLayers();if(this._mouseCoords){this._scrollTo(this._mouseCoords);}},_centerLayers:function(){this._centerLayer(this._backdrop);for(var e=0;e<this._layers.length;++e){this._centerLayer(this._layers[e]);}},_centerLayer:function(e){var f=LTP.util.platformInfo.isFirefox?this._centerLayerFirefox:this._centerLayerNotFirefox;f.call(this,e);},_centerLayerFirefox:function(f){var h=(this._imageSize.width*this._zoom-this._containingElement.clientWidth)/2;var e=(this._imageSize.height*this._zoom-this._containingElement.clientHeight)/2;var g=(this._containingElement.clientWidth-this._imageSize.width)/2;var i=(this._containingElement.clientHeight-this._imageSize.height)/2;if(h>0){g+=h;}if(e>0){i+=e;}f.style.top=Math.round(i)+"px";f.style.left=Math.round(g)+"px";},_centerLayerNotFirefox:function(e){var g=(this._containingElement.offsetHeight/2-e.height/2);var f=(this._containingElement.offsetWidth/2-e.width/2);e.style.top=Math.max(0,Math.round(g))+"px";e.style.left=Math.max(0,Math.round(f))+"px";},_scrollTo:function(e){var g=e.x/this._imageSize.x;var f=e.y/this._imageSize.y;var h=this._containingElement.parentNode;h.scrollLeft=h.scrollWidth*g-h.clientWidth/2;h.scrollTop=h.scrollHeight*f-h.clientHeight/2;},addLayer:function(e){e.style.position="absolute";e.style.cursor="none";this._containingElement.appendChild(e);this._centerLayer(e);this._layers.push(e);},removeLayer:function(f){var e=this._layers.indexOf(f);this._layers.splice(e,1);this._containingElement.removeChild(f);},_addTransparencyBackdrop:function(){var e=document.createElement("div");e.id="transparencyBackdropElement";e.style.position="absolute";e.style.cursor="none";e.style.width=this._imageSize.width+"px";e.style.height=this._imageSize.height+"px";e.width=this._imageSize.width;e.height=this._imageSize.height;this._containingElement.appendChild(e);this._centerLayer(e);this._backdrop=e;},_setScratchForLayer:function(f){var h=false;for(var e=0;e<this._layers.length;++e){if(this._layers[e]===f){h=true;break;}}if(h){var g=parseInt(f.style.zIndex,10);this._scratch.style.zIndex=g+1;}},destroy:function(){this._layers=null;this._messageBus.unsubscribe("zoomChanged",this._onZoomChanged);this._messageBus.unsubscribe("newLayerCreated",this._onNewLayerCreated);this._messageBus.unsubscribe("activeLayerChanged",this._onActiveLayerChanged);this._messageBus.unsubscribe("layerDeleted",this._onLayerRemoved);this._messageBus.unsubscribe("noLayersInProject",this._onNoLayersInProject);this._messageBus=null;Ext.fly(this._containingElement.parentNode).un("mousemove",this._onMouseMove,this);},_onZoomChanged:function(e){this.zoomTo(e);},_onNewLayerCreated:function(e){this.addLayer(e);this._backdrop.style.display="";},_onLayerRemoved:function(e){this.removeLayer(e);},_onNoLayersInProject:function(){this._backdrop.style.display="none";},_onActiveLayerChanged:function(e){this._setScratchForLayer(e);},_onMouseMove:function(h){var g=Ext.fly(h.target);var f=p(h.getX()-g.getLeft(),h.getY()-g.getTop());this._mouseCoords=this._pointTransformer.transform(f);},_onWindowResize:function c(){this._centerLayers();}};Object.defineProperty(LTP.Container.prototype,"overlay",{set:function(e){this.addLayer(e);e.style.zIndex=a;}});Object.defineProperty(LTP.Container.prototype,"grid",{set:function(e){this.addLayer(e);e.style.zIndex=d;}});Object.defineProperty(LTP.Container.prototype,"scratch",{set:function(e){this._scratch=e;this.addLayer(e);}});})();(function(){LTP.Painter=function(l,e,f,g,d,i,k,j,h){if(!l){throw new Error("LTP.Painter: size is required");}if(!e){throw new Error("LTP.Painter: pointTransformer is required");}this._size=l;this._pointTransformer=e;this._messageBus=f||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",this._onZoomChanged,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("leftColorSelected",this._onLeftColorSelected,this);this._messageBus.subscribe("rightColorSelected",this._onRightColorSelected,this);this._messageBus.subscribe("leftSizeSelected",this._onLeftSizeSelected,this);this._messageBus.subscribe("rightSizeSelected",this._onRightSizeSelected,this);this._leftToolState={down:false,color:i||colors.black,size:j||8};this._rightToolState={down:false,color:k||colors.white,size:h||8};this._overlay=LTP.util.canvas(this._size,{position:"absolute",cursor:"none",top:0,left:0});this._scratch=LTP.util.canvas(this._size,{cursor:"none",position:"absolute",top:0,left:0});this.leftTool=g||new LTP.BrushTool();this.rightTool=d||new LTP.BrushTool();this._clear(this._overlay);this._clear(this._scratch);this._hook(this._overlay);this._undoRedoStates=[];this._currentUndoRedoStateIndex=-1;this._entireBoundingBox=r(0,0,this._size.width,this._size.height);this._zoom=1;this._lastToolState=this._leftToolState;};LTP.Painter.prototype={_hook:function b(d){this._setEventListeners(Ext.get(d),"on");},_unhook:function c(d){this._setEventListeners(Ext.get(d),"un");},_setEventListeners:function a(d,e){d[e]("mousedown",this._onMouseDown,this);d[e]("mousemove",this._onMouseMove,this);d[e]("mouseout",this._onMouseOut,this);d[e]("mouseup",this._onMouseUp,this);d[e]("contextmenu",this._onContextMenu,this);},_setCursor:function(d){if(this._overlay){this._overlay.style.cursor=d;}},_doOverlay:function(e,f){this._clear(this._overlay);var d=f&&f.currentPoint||this._lastOverlayPoint;e=e||this._lastToolState;if(d){var g=this._overlay.getContext("2d");e.tool.overlay(g,d,e.size);if(this._adhocTransformer&&this._adhocTransformer.overlay){this._adhocTransformer.overlay(g,d,e.size);}this._lastOverlayPoint=d;}this._setCursor(e.tool.cursor);this._messageBus.publish("canvasMouseCoordinatesChanged",d);},_getLeftFirefox:function(d){var e=d.getLeft();var f=this._size.width*this._zoom-this._size.width;f=f/2;return e-f;},_getTopFirefox:function(d){var f=d.getTop();var e=this._size.height*this._zoom-this._size.height;e=e/2;return f-e;},_getCurrentPoint:function(i){var f=Ext.fly(i.target);var h,g;if(LTP.util.platformInfo.isFirefox){h=this._getLeftFirefox(f);g=this._getTopFirefox(f);}else{h=f.getLeft()*this._zoom;g=f.getTop()*this._zoom;}var d=i.getX()-h;var j=i.getY()-g;return p(d,j);},_getToolState:function(d){return d.button>0?this._rightToolState:this._leftToolState;},_getPointInfo:function(d,i,g){var f=this._getCurrentPoint(i);var j=this._pointTransformer.transform(f);var k=d.lastPointNonTransformed||f;var h=d.lastPoint||j;if(g&&g.currentOnly){k=f;h=j;}if(this._adhocTransformer){j=this._adhocTransformer.transform(h,j,d.size);}return{currentPoint:j,lastPoint:h,currentPointNonTransformed:f,lastPointNonTransformed:k};},_paint:function(d,e,g){var f=this._activeCanvas;if(d.tool.causesChange){this._pruneUndoRedoStates();f=this._scratch;}d.tool.perform({canvas:f,imageCanvas:this._activeCanvas,context:f.getContext("2d"),lastPoint:e.lastPoint,currentPoint:e.currentPoint,lastPointNonTransformed:e.lastPointNonTransformed,currentPointNonTransformed:e.currentPointNonTransformed,containerElement:this._activeCanvas.parentNode.parentNode,mouseButton:g,color:d.color,size:d.size});d.lastPoint=e.currentPoint;d.lastPointNonTransformed=e.currentPointNonTransformed;if(d.tool.causesChange){if(!this._currentBoundingBox){this._currentBoundingBox=new LTP.BoundingBoxBuilder(d.tool.getBoundsAt(e.currentPoint,d.size,this._size));}else{this._currentBoundingBox.append(d.tool.getBoundsAt(e.currentPoint,d.size,this._size));this._currentBoundingBox.append(d.tool.getBoundsAt(e.lastPoint,d.size,this._size));}}},_onMouseDown:function(g){g.preventDefault();var d=this._getToolState(g);if(this._lastToolState&&d!==this._lastToolState){d.tool.overlayColor=colors.gray;}else{var f=this._getPointInfo(d,g,{currentOnly:true});d.down=true;this._paint(d,f,g.button);delete d.tool.overlayColor;}this._lastToolState=d;this._doOverlay(d,f);return false;},_onMouseMove:function(g){g.preventDefault();var d=this._getToolState(g);var f=this._getPointInfo(d,g);if(d.down){this._paint(d,f,g.button);this._doOverlay(d,f);}else{this._doOverlay(null,f);}return false;},_conclude:function(d,e){if(d.down&&d.tool.causesChange){this._finishUndoRedo(d.tool,e.currentPoint,d.size);}d.down=false;},_onMouseUp:function(g){g.preventDefault();var d=this._getToolState(g);var f=this._getPointInfo(d,g);this._conclude(d,f);this._doOverlay(d,f);return false;},_onMouseOut:function(g){g.preventDefault();var d=(this._leftToolState.down&&this._leftToolState)||(this._rightToolState.down&&this._rightToolState);if(d){var f=this._getPointInfo(d,g);this._conclude(d,f);}this._doOverlay();return false;},_pruneUndoRedoStates:function(){this._undoRedoStates=this._undoRedoStates.slice(0,this._currentUndoRedoStateIndex+1);this._currentUndoredoStateIndex=this._undoRedoStates.length-1;},_finishUndoRedo:function(f,d,g){this._currentBoundingBox.append(f.getBoundsAt(d,g,this._size));var e=this._currentBoundingBox.boundingBox;if(e.hasArea){this._undoRedoStates.push({boundingBox:e,undoClip:this._createClip(this._activeCanvas,e),redoClip:this._createClip(this._scratch,e),canvas:this._activeCanvas});this._currentUndoRedoStateIndex=this._undoRedoStates.length-1;}this._applyClip(this._activeCanvas,this._scratch,this._entireBoundingBox);this._clear(this._scratch);},_onContextMenu:function(d){d.preventDefault();d.stopPropagation();return false;},_clear:function(d){d.getContext("2d").clearRect(0,0,d.width,d.height);},_createClip:function(e,d){var f=LTP.util.canvas(d);f.getContext("2d").drawImage(e,d.x,d.y,d.width,d.height,0,0,d.width,d.height);return f;},_applyClip:function(d,g,f,e){var h=d.getContext("2d");if(typeof g.getContext==="function"){if(e){h.clearRect(f.x,f.y,f.width,f.height);}h.drawImage(g,f.x,f.y,f.width,f.height);}else{h.putImageData(g,f.x,f.y);}},undo:function(){if(this._currentUndoRedoStateIndex>-1){var d=this._undoRedoStates[this._currentUndoRedoStateIndex];this._applyClip(d.canvas,d.undoClip,d.boundingBox,true);this._messageBus.publish("canvasContentChange",this._activeCanvas);this._currentUndoRedoStateIndex-=1;}},redo:function(){if(this._currentUndoRedoStateIndex<this._undoRedoStates.length-1){this._currentUndoRedoStateIndex+=1;var d=this._undoRedoStates[this._currentUndoRedoStateIndex];this._applyClip(d.canvas,d.redoClip,d.boundingBox,false);this._messageBus.publish("canvasContentChange",this._activeCanvas);}},_onZoomChanged:function(d){this._zoom=d;this._pointTransformer.zoom=d;},_onActiveLayerChanged:function(d){this.activeCanvas=d;},_onLeftColorSelected:function(d){this._leftToolState.color=d;this._lastToolState=this._leftToolState;},_onRightColorSelected:function(d){this._rightToolState.color=d;this._lastToolState=this._rightToolState;},_onLeftSizeSelected:function(d){this._leftToolState.size=d;},_onRightSizeSelected:function(d){this._rightToolState.size=d;}};Object.defineProperty(LTP.Painter.prototype,"overlay",{get:function(){return this._overlay;},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"scratch",{get:function(){return this._scratch;},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"activeCanvas",{set:function(d){this._activeCanvas=d;}});Object.defineProperty(LTP.Painter.prototype,"leftTool",{get:function(){return this._leftToolState.tool;},set:function(d){this._leftToolState.tool=d;this._lastToolState=this._leftToolState;this._messageBus.publish("leftToolChanged",d);this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"rightTool",{get:function(){return this._rightToolState.tool;},set:function(d){this._rightToolState.tool=d;this._lastToolState=this._rightToolState;this._messageBus.publish("rightToolChanged",d);this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"leftColor",{get:function(){return this._leftToolState.color;},set:function(d){this._leftToolState.color=d;this._lastToolState=this._leftToolState;this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"rightColor",{get:function(){return this._rightToolState.color;},set:function(d){this._rightToolState.color=d;this._lastToolState=this._rightToolState;this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"adhocTransformer",{set:function(d){this._adhocTransformer=d;this._doOverlay();},});})();(function(){LTP.LayerManager=function d(f,e){if(!f){throw new Error("LayerManager: project is required");}this._size=f.size;this._messageBus=e||LTP.GlobalMessageBus;if(f.layers){this._layers=this._hydrateLayersFromProject(f);}else{this._layers=[this._createLayer(this.InitialLayerName,f.size)];}this._activeLayerIndex=this._layers.length-1;this._layerCounter=1;};LTP.LayerManager.prototype={InitialLayerName:"Initial Layer",_hydrateLayersFromProject:function a(j){var h=[];for(var f=0;f<j.layers.length;++f){var e=j.layers[f];var g=this._createLayer(e.layerName,j.size,e.data,{layerId:e.layerId,index:e.index});h.push(g);}h.sort(function(k,i){return k.index-i.index;});return h;},dumpLayers:function(){for(var f=0;f<this._layers.length;++f){var e=this._layers[f];window.open(e.toDataURL("png"),e.layerName+f);}},setActiveLayer:function(e){this._activeLayerIndex=e;this._messageBus.publish("activeLayerChanged",this.activeLayer);return this.activeLayer;},setActiveLayerByLayer:function b(f){var e=this._layers.indexOf(f);if(e>-1){this.setActiveLayer(e);}},addNewLayerFromImage:function(e){var f=this.addNewLayer(null,this._size);f.getContext("2d").drawImage(e,0,0);this._messageBus.publish("canvasContentChange",f);},addNewLayer:function(e,f){this._layers.push(this._createLayer(e||"new layer "+this._layerCounter++,f));this._activeLayerIndex=this._layers.length-1;this._updateZIndices();this._messageBus.publish("newLayerCreated",this.activeLayer);this.setActiveLayer(this._activeLayerIndex);return this.activeLayer;},moveLayerAhead:function(f,h){var e=this._layers.indexOf(f);this._layers.splice(e,1);var g=this._layers.indexOf(h);this._layers.splice(g+1,0,f);this._updateZIndices();},moveLayerBehind:function(f,h){var e=this._layers.indexOf(f);this._layers.splice(e,1);var g=this._layers.indexOf(h);this._layers.splice(g,0,f);this._updateZIndices();},deleteLayer:function(e){if(e<0||e>=this.count){throw new Error("LayerManger.deleteLayer: index out of range: "+e);}var f=this._layers.splice(e,1)[0];if(this._activeLayerIndex>=this.count){this._activeLayerIndex=this.count-1;}this.setActiveLayer(this._activeLayerIndex);this._updateZIndices();this._messageBus.publish("layerRemoved",f);if(this._layers.length===0){this._messageBus.publish("noLayersInProject");}return true;},deleteLayerByLayer:function(f){var e=this._layers.indexOf(f);if(e>=0){return this.deleteLayer(e);}},mergeLayer:function(f){if(f<=0){return false;}var e=this._layers[f];var g=this._layers[f-1];if(e.isVisible){g.getContext("2d").drawImage(e,0,0);}this.deleteLayer(f);this._messageBus.publish("canvasContentChange",g);return true;},mergeLayerByLayer:function(f){var e=this._layers.indexOf(f);if(e>=1){return this.mergeLayer(e);}},composite:function(m){m=m||this._size;var j=LTP.util.scaleSize(this._size,m);var f=this._createLayer("composite",j);var k=f.getContext("2d");for(var h=0,e=this.count;h<e;++h){var g=this._layers[h];if(g.isVisible){k.drawImage(g,0,0,g.width,g.height,0,0,f.width,f.height);}}return f;},flatten:function(){if(this.count===0){return;}var e=this.composite();e.layerName=this._layers[0].layerName;while(this.count>0){this.deleteLayer(0);}this._layers.push(e);this._messageBus.publish("newLayerCreated",e);this.setActiveLayer(0);return e;},destroy:function(){this._layers=null;},_createLayer:function(f,h,i,g){h=h||this._size;var e=LTP.util.canvas(h,{position:"absolute",top:0,left:0});c(e);e.layerName=f;e.layerManager=this;if(g){for(var j in g){if(g.hasOwnProperty(j)){e[j]=g[j];}}}if(i){e.data=i;}return e;},_drawImageInto:function(g,f){var e=f.getContext("2d");e.save();e.drawImage(g,0,0);e.restore();},_updateZIndices:function(){for(var e=0;e<this._layers.length;++e){this._layers[e].style.zIndex=(e+1)*3;}}};Object.defineProperty(LTP.LayerManager.prototype,"dataLoaded",{get:function(){if(!this._layers||this._layers.length===0){return true;}for(var e=0;e<this._layers.length;++e){if(!this._layers[e].dataLoaded){return false;}}return true;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"size",{get:function(){return this._size;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"count",{get:function(){return this._layers.length;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"layers",{get:function(){return this._layers;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"activeLayer",{get:function(){return this._layers[this._activeLayerIndex];},enumerable:true});function c(e){Object.defineProperty(e,"layerName",{get:function(){return this._layerName;},set:function(f){this._layerName=f;},enumerable:true});Object.defineProperty(e,"isVisible",{get:function(){return this.style.display==="";},set:function(f){this.style.display=f?"":"none";},enumerable:true});Object.defineProperty(e,"index",{get:function(){return parseInt(this.style.zIndex,10);},set:function(f){this.style.zIndex=f;},enumerable:true});Object.defineProperty(e,"data",{get:function(){return this.toDataURL("png");},set:function(h){var g=this;var f=document.createElement("img");f.onload=function(){g.getContext("2d").drawImage(f,0,0);g.dataLoaded=true;g.layerManager._messageBus.publish("layerLoad",g);};f.src=h;},enumerable:true});Object.defineProperty(e,"thumbnailData",{get:function(){var g=LTP.util.scaleSize(s(this.width,this.height),s(50,50));var f=LTP.util.canvas(g);f.getContext("2d").drawImage(this,0,0,this.width,this.height,0,0,g.width,g.height);return f.toDataURL();},set:function(f){},enumerable:true});Object.defineProperty(e,"thumbnailHeight",{get:function(){var f=LTP.util.scaleSize(s(this.width,this.height),s(50,50));return f.height;},set:function(f){},enumerable:true});Object.defineProperty(e,"thumbnailWidth",{get:function(){var f=LTP.util.scaleSize(s(this.width,this.height),s(50,50));return f.width;},set:function(f){},enumerable:true});}})();(function(){LTP.Grid=function a(b,d,e,c){if(!b){throw new Error("Grid: canvasSize is required");}this._canvasSize=b;this._color=d||colors.blue;this._cellSize=e||0;this._messageBus=c||LTP.GlobalMessageBus;this._canvas=LTP.util.canvas(b);this._paintGrid(this._canvas,this._cellSize,this._color);};LTP.Grid.prototype={destroy:function(){this._canvas=null;this._messageBus=null;},_paintGrid:function(d,g,c){var e=d.getContext("2d");e.clearRect(0,0,d.width,d.height);if(g<=0){return;}e.save();e.strokeStyle=c;e.beginPath();for(var b=0.5;b<d.width;b+=g){e.moveTo(b,0);e.lineTo(b,d.height);}for(var f=0.5;f<d.height;f+=g){e.moveTo(0,f);e.lineTo(d.width,f);}e.strokeRect(0,0,d.width,d.height);e.closePath();e.stroke();e.restore();this._messageBus.publish("gridCellSizeChanged",g);}};Object.defineProperty(LTP.Grid.prototype,"color",{get:function(){return this._color;}});Object.defineProperty(LTP.Grid.prototype,"canvasSize",{get:function(){return this._canvasSize;}});Object.defineProperty(LTP.Grid.prototype,"cellSize",{get:function(){return this._cellSize;},set:function(b){this._cellSize=b;this._paintGrid(this._canvas,b,this._color);}});Object.defineProperty(LTP.Grid.prototype,"canvas",{get:function(){return this._canvas;}});Object.defineProperty(LTP.Grid.prototype,"visible",{get:function(){return this._canvas.style.display==="";},set:function(b){if(b){this._canvas.style.display="";}else{this._canvas.style.display="none";}}});})();(function(){var c={"16":"shift","17":"control","18":"alt","32":"space","91":"command","27":"esc"};var b={"!":1,"@":2,"#":3,"$":4,"%":5,"^":6,"&":7,"*":8,"(":9,")":0};LTP.KeyListener=function a(d){var e=this;if(!d){throw new Error("KeyListener: must be constructed with a config object");}this._scope=d.scope||this;this._hook=d.hook||window;this._callbacks=d.callbacks||{};this._keyPressListener=LTP.util.bind(this._onKeyPress,this);this._hook.addEventListener("keypress",this._keyPressListener,false);this._keyDownListener=LTP.util.bind(this._onKeyDown,this);this._hook.addEventListener("keydown",this._keyDownListener,false);this._keyUpListener=LTP.util.bind(this._onKeyUp,this);this._hook.addEventListener("keyup",this._keyUpListener,false);this._downKeys={};};LTP.KeyListener.prototype={_getCharacter:function(d){return c[d]||String.fromCharCode(d).toLowerCase();},_onKeyPress:function(f){if(f.target instanceof HTMLInputElement){return;}var d=this._getCharacter(f.keyCode||f.charCode);d=d.toLowerCase();if(d==="space"){f.preventDefault();}if(typeof this._callbacks[d]==="object"){this._callbacks[d].fn.call(this._scope,f.shiftKey);}else{if(b[d]&&typeof this._callbacks[b[d].toString()]==="object"){this._callbacks[b[d].toString()].fn.call(this._scope,true);}}return d!=="space";},_onKeyDown:function(g){if(g.target instanceof HTMLInputElement){return;}var d=this._getCharacter(g.keyCode);if(d==="space"){g.preventDefault();}if(!this._downKeys[d]){var f=d+"down";if(typeof this._callbacks[f]==="object"){this._callbacks[f].fn.call(this._scope,g.shiftKey);}this._downKeys[d]=true;}return d!=="space";},_onKeyUp:function(g){if(g.target instanceof HTMLInputElement){return;}var d=this._getCharacter(g.keyCode);var f=d+"up";if(d==="space"){g.preventDefault();}if(typeof this._callbacks[f]==="object"){this._callbacks[f].fn.call(this._scope,g.shiftKey);}this._downKeys[d]=false;return d!=="space";},destroy:function(){this._hook.removeEventListener("keypress",this._keyPressListener,false);this._hook.removeEventListener("keydown",this._keyDownListener,false);this._hook.removeEventListener("keyup",this._keyUpListener,false);}};})();(function(){LTP.firstTimeHere=!!!localStorage["ltp-projects"];LTP.version="0.1 beta";LTP.s=function(a,b){return new LTP.Pair(a,b);};LTP.sr=function(a,b){return new LTP.Pair(Math.round(a),Math.round(b));};LTP.r=function(){if(arguments.length===4){return new LTP.Rectangle(arguments[0],arguments[1],arguments[2],arguments[3]);}else{var a=arguments[0];return new LTP.Rectangle(a.x,a.y,arguments[1],arguments[2]);}};LTP.util.global.s=LTP.p=LTP.util.global.p=LTP.s;LTP.util.global.sr=LTP.pr=LTP.util.global.pr=LTP.sr;LTP.util.global.r=LTP.r;LTP.GlobalMessages=["colorSampled","zoomChanged","canvasMouseCoordinatesChanged","gridCellSizeChanged","leftToolChanged","rightToolChanged","leftColorSelected","rightColorSelected","leftSizeSelected","rightSizeSelected","newLayerCreated","activeLayerChanged","lockChanged","flairMessage","canvasContentChange","paletteContentChange","layerLoad","layerRemoved","noLayersInProject"];LTP.GlobalMessageBus=new LTP.MessageBus(LTP.GlobalMessages);})();(function(){Ext.define("LTP.FlairMessage",{extend:"Ext.container.Container",alias:"widget.ltp.flairmessage",width:280,items:{xtype:"label",text:"Let's pixel!"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("flairMessage",function(b){if(b){this.el.highlight("#EDE459",{duration:2000});this.down("label").setText(b);Ext.defer(function(){this._resetMessage();},2000,this);}else{this._resetMessage();}},this);},_resetMessage:function(){this.down("label").setText("Let's pixel!");}});})();(function(){Ext.define("LTP.CurrentCoordinates",{extend:"Ext.container.Container",alias:"widget.ltp.currentcoordinates",width:100,items:{xtype:"label",text:"x: out y: out"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("canvasMouseCoordinatesChanged",function(b){if(b){this.down("label").setText("x: "+b.x+", y: "+b.y);}else{this.down("label").setText("x: out, y: out");}},this);}});})();(function(){Ext.define("LTP.CurrentZoom",{extend:"Ext.container.Container",alias:"widget.ltp.currentzoom",width:100,items:{xtype:"label",text:"zoom: 100%",},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",function(b){this.down("label").setText("zoom: "+(b*100).toString()+"%");},this);}});})();(function(){Ext.define("LTP.CurrentColor",{extend:"Ext.container.Container",alias:"widget.ltp.currentcolor",width:40,height:16,style:{margin:"2px",border:"1px solid black"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe(a.tool+"ColorSelected",function(b){if(b){this.el.setStyle("backgroundColor",b);}},this);}});})();(function(){Ext.define("LTP.CurrentLock",{extend:"Ext.container.Container",alias:"widget.ltp.currentlock",width:100,items:{xtype:"label",text:"lock: none"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("lockChanged",function(b){if(b){this.down("label").setText("lock: "+b);}else{this.down("label").setText("lock: none");}},this);}});})();(function(){Ext.define("LTP.HelpLink",{extend:"Ext.container.Container",alias:"widget.ltp.helplink",constructor:function(a){this.callParent(arguments);this.html=Ext.String.format('<a href="#" id="_helpLink">{0}</a>',a.linkText||"help");},initComponent:function(){this.callParent(arguments);this.addEvents("helprequested");this.on("afterrender",function(){Ext.fly("_helpLink").on("click",this._onHelpLinkClick,this);},this);},_onHelpLinkClick:function(a){a.preventDefault();a.stopPropagation();this.fireEvent("helprequested");return false;}});})();(function(){var a="LTP allows painting with both the left and right mouse button. The status bar shows the current color for each one. When selecting a color in the color palette, the button you use determines which tool gets set to your selection";Ext.define("LTP.HelpWindow",{extend:"Ext.window.Window",alias:"widget.ltp.helpwindow",title:"Key Commands",width:600,constructor:function(b){this.callParent(arguments);Ext.apply(this,b);},buttons:[{text:"OK",handler:function(){this.up("window").close();}}],initComponent:function(){var b=[];b.push(this._createKeyCommandHelp());this.items=b;this.callParent(arguments);},_createKeyCommandHelp:function(){var d=[];for(var f in this.commands){if(this.commands.hasOwnProperty(f)&&this.commands[f].fn&&this.commands[f].noHelp!==true){var e=this.commands[f];var b=this._createCommandEntry(e.label||f,e.message);d.push(b);if(e.shiftMessage){var c=this._createCommandEntry(e.label||f,e.shiftMessage,true);d.push(c);}}}return{xtype:"panel",items:d,border:false};},_createHelpEntry:function(c,b){return{xtype:"panel",title:c,items:{xtype:"container",html:b,margin:5}};},_createCommandEntry:function(c,d,b){return{xtype:"container",border:false,layout:"hbox",defaults:{xtype:"container",border:false,margin:1},items:[{width:100,style:{textAlign:"right",marginRight:"10px"},html:Ext.String.format("<b>{0}{1}</b>: ",b?"&lt;shift&gt; ":"",c)},{html:d}]};}});})();(function(){Ext.define("LTP.StatusBar",{extend:"Ext.container.Container",layout:"hbox",alias:"widget.ltp.statusbar",items:[{xtype:"ltp.flairmessage",style:{paddingLeft:"10px"}},{xtype:"ltp.currentcolor",tool:"left"},{xtype:"ltp.currentcolor",tool:"right"},{xtype:"ltp.currentzoom",style:{marginLeft:"30px"}},{xtype:"ltp.currentcoordinates"},{xtype:"ltp.currentlock"},{xtype:"ltp.helplink",linkText:"key commands",style:{marginLeft:"80px"},listeners:{helprequested:function(){Ext.create("LTP.HelpWindow",{commands:LTP.app.callbacks}).show();}}},{xtype:"container",style:{marginLeft:"30px"},html:'<a href="https://github.com/city41/LoveToPixel/issues/new" target="_blank">Found a bug?</a>'}]});})();(function(){Ext.define("LTP.ColorSwatch",{extend:"Ext.container.Container",alias:"widget.ltp.colorswatch",width:20,height:20,margin:1,constructor:function(a){this.callParent(arguments);this.addEvents("click","dblclick");this.style={backgroundColor:a.color,border:"1px solid black",color:colors.invert(a.color)};var b=this;this.on("render",function(){b.el.dom.addEventListener("mousedown",function(c){b._mouseIsDown=true;setTimeout(function(){if(b._mouseIsDown){b.fireEvent("longclick",c);b._mouseIsDown=false;}},200);});b.el.dom.addEventListener("mouseup",function(c){if(b._mouseIsDown){b.fireEvent("click",c);}b._mouseIsDown=false;});b.el.dom.addEventListener("contextmenu",function(c){c.preventDefault();c.stopPropagation();return false;});});},initComponent:function(){this.items=[{xtype:"container",itemId:"leftIndicator",width:4,height:4,style:{backgroundColor:colors.invert(this.color),"float":"left"},},{xtype:"container",itemId:"rightIndicator",width:4,height:4,style:{backgroundColor:colors.invert(this.color),"float":"right"}}];this.callParent(arguments);this.setIsCurrentLeft(false);this.setIsCurrentRight(false);},_setCurrent:function(c,b){var a=this.down("#"+b+"Indicator");a.setVisible(c);},setIsCurrentLeft:function(a){this._setCurrent(a,"left");},setIsCurrentRight:function(a){this._setCurrent(a,"right");}});})();(function(){Ext.define("LTP.SizeSwatch",{extend:"Ext.container.Container",alias:"widget.ltp.sizeswatch",width:40,height:40,baseCls:"sizeSwatch",constructor:function(a){this.callParent(arguments);this.addEvents("click");var b=this.size+"px";var d=(this.width/2)-(this.size/2)+"px";this.html=Ext.String.format('<div style="width:{0};height:{0};margin:{1};background-color:black"></div>',b,d);var c=this;this.on("render",function(){c.el.dom.addEventListener("mousedown",function(g){var f=g.button===0?"left":"right";LTP.GlobalMessageBus.publish(f+"SizeSelected",c.size);c.fireEvent("click");});c.el.dom.addEventListener("contextmenu",function(f){f.preventDefault();f.stopPropagation();return false;});});}});})();(function(){Ext.define("LTP.Toolbar",{extend:"Ext.container.Container",alias:"widget.ltp.toolbar",layout:"column",height:25,defaults:{xtype:"ltp.swatch",},constructor:function(a){this.callParent(arguments);},initComponent:function(){var a=this.colors||[];var b=[];for(var c=0;c<a.length;++c){b.push({color:a[c]});}this.items=b;this.callParent(arguments);}});})();(function(){Ext.define("LTP.ProjectList",{extend:"Ext.grid.Panel",alias:"widget.ltp.projectlist",layout:"fit",multiSelect:false,selType:"rowmodel",sortableColumns:false,border:false,viewConfig:{emptyText:"<div class='emptyGridText'>You have no saved projects. Start a new project above, then when you save it with 's' it will show up here</div>",deferEmptyText:false},initComponent:function(){this.columns=[{header:"Thumbnail",xtype:"templatecolumn",tpl:'<div style="height:{thumbnailHeight}px; width:{thumbnailWidth}px"><img class="thumbnail" src="{thumbnailData}" /></div>',flex:1,dataIndex:"thumbnailData",menuDisabled:true},{header:"Name",dataIndex:"name",menuDisabled:true},{header:"Last Saved",xtype:"datecolumn",dataIndex:"lastSaved",menuDisabled:true},{xtype:"actioncolumn",header:"Delete",width:50,menuDisabled:true,items:[{icon:"/images/delete.png",iconCls:"x-grid-center-icon",handler:function(b,c,a){this.up("panel").deleteAt(c);}}]}],this.store=Ext.create("Ext.data.Store",{model:"LTP.ProjectModel",data:this.projects,sorters:[{property:"lastSaved",direction:"DESC"}]});this.callParent(arguments);},getSelectedProject:function(){var a=this.getSelectionModel().getSelection();return a&&a.length&&a[0]&&a[0].data;},deleteAt:function(a){Ext.MessageBox.confirm("Delete?","Really delete this project?",function(d){if(d==="yes"){var b=this.store.getAt(a);if(b){var c=b.layers();c.each(function(e){e.destroy();});c.sync();this.store.remove(b);this.store.sync();}}},this);}});})();(function(){Ext.define("LTP.BrowserWarningPanel",{extend:"Ext.panel.Panel",alias:"widget.ltp.browserwarningpanel",border:false,iconCls:"warningIcon",style:{borderBottom:"4px solid black"},constructor:function(){this.callParent(arguments);},initComponent:function(){var b=LTP.compatibilityInfo();var a=[];if(!b.success){a.push({xtype:"container",margin:0,html:'<img src="images/browserWarning.png" alt="browser warning" />',height:63,style:{borderBottom:"4px solid black",backgroundColor:"orange"}},{xtype:"container",border:false,margin:15,html:"So far only Chrome (on OSX) or Firefox 8 (on all platforms) are fully supported. Your browser is not supported because: <b>"+b.conclusion+"</b>"});}this.items=a;this.callParent(arguments);this.setVisible(!b.success);}});})();(function(){Ext.define("LTP.ProjectChooserHeader",{extend:"Ext.panel.Panel",alias:"widget.ltp.projectchooserheader",layout:"anchor",border:false,defaults:{border:false},items:[{html:"header goes here"},{xtype:"ltp.browserwarningpanel"}]});})();(function(){function a(){if(!window.FileReader){return false;}if(!!window.DataTransfer){return"files" in DataTransfer.prototype;}else{var b=document.createElement("div");return b&&typeof b.ondragover!=="undefined"&&b.ondrop!=="undefined";}}Ext.define("LTP.DragDropZone",{extend:"Ext.container.Container",alias:"widget.ltp.dragdropzone",border:false,constructor:function(b){this.callParent(arguments);Ext.apply(this,b);this.resetColor=this.resetColor||colors.white;this.style.backgroundColor=this.resetColor;},initComponent:function(){this.callParent(arguments);this.addEvents("filereceived");if(a()){this.on("afterrender",this._onRender,this);this.setVisible(true);}else{this.setVisible(false);}},_onRender:function(){this.el.on("dragover",this._onDragOver,this);this.el.on("dragleave",this._onDragLeave,this);this.el.on("drop",this._onDrop,this);},_onDragOver:function(b){b.preventDefault();b.stopPropagation();b.browserEvent.dataTransfer.dropEffect="copy";this.el.setStyle("background-color","#EDE459");return false;},_onDragLeave:function(b){b.preventDefault();b.stopPropagation();this.el.setStyle("background-color",this.resetColor);return false;},_onDrop:function(b){if(b&&b.browserEvent.dataTransfer&&b.browserEvent.dataTransfer.files&&b.browserEvent.dataTransfer.files.length){b.preventDefault();b.stopPropagation();this.el.setStyle("background-color",this.resetColor);this.fireEvent("filereceived",b.browserEvent.dataTransfer.files[0]);return false;}}});})();(function(){var c="__ltp_projectchooser_size__";var a='love to pixel is a web based pixel editor. That\'s a fancy name for a paint program geared towards those who do "old school" pixel art (think 16 bit video games).';function b(e){if(!e){return e;}var g=e.split("x");if(!g||g.length!==2){return;}var f=parseInt(g[0],10);var d=parseInt(g[1],10);if(isNaN(f)||f<=0||isNaN(d)||d<=0){return;}return s(f,d);}Ext.define("LTP.ProjectChooser",{extend:"Ext.container.Container",alias:"widget.ltp.projectchooser",layout:"fit",border:false,width:"100%",height:"100%",itemId:"projectChooser",baseCls:"projectChooserContainer",defaults:{border:false},initComponent:function(){Ext.EventManager.onWindowResize(this._onWindowResize,this);this.items={xtype:"panel",width:556,itemId:"chooserPanel",layout:{type:"vbox",align:"stretch"},baseCls:"projectChooser",defaults:{autoScroll:false,border:false},items:[{xtype:"container",margin:0,html:'<img src="images/mainLogo.png" alt="main logo" />',height:107,style:{borderBottom:"4px solid black"}},{xtype:"container",items:{xtype:"container",baseCls:"introSection",margin:15,html:a},style:{borderBottom:"4px solid black",backgroundColor:"white"}},{xtype:"ltp.browserwarningpanel"},{xtype:"container",margin:0,html:'<img src="images/newProject.png" alt="new project header" />',height:63,style:{borderBottom:"4px solid black",backgroundColor:"#9E0000"}},{xtype:"panel",layout:"hbox",defaults:{margin:5},items:[{xtype:"textfield",fieldLabel:"Name",labelWidth:40,name:"name",itemId:"nameField",enableKeyEvents:true,listeners:{keydown:function(g,f){if(f.keyCode===Ext.EventObject.ENTER){var d=this.up("#projectChooser");d._startNewProject();}}}},{xtype:"textfield",fieldLabel:"Size",labelWidth:40,value:this._getInitialSizeValue(),name:"size",itemId:"sizeField",invalidText:"needs to be in the form '100x100'",enableKeyEvents:true,listeners:{keydown:function(g,f){if(f.keyCode===Ext.EventObject.ENTER){var d=this.up("#projectChooser");d._startNewProject();}}},validate:function(){var d=!!b(this.value);if(!d){this.markInvalid("needs to be in the form '100x100'");}else{this.clearInvalid();}return d;}},{xtype:"button",text:"Start",handler:function(){var d=this.up("#projectChooser");d._startNewProject();}}]},{xtype:"ltp.dragdropzone",html:"or drag an image file here",listeners:{filereceived:this._onFileReceived,scope:this},style:{paddingLeft:"15px",paddingRight:"15px",paddingBottom:"10px",fontStyle:"italic",},resetColor:colors.white},{xtype:"container",margin:0,html:'<img src="images/savedProjects.png" alt="saved projects header" />',height:63,style:{borderBottom:"4px solid black",borderTop:"4px solid black",backgroundColor:"#9E0000"}},{xtype:"ltp.projectlist",itemId:"projectList",projects:this.projects,flex:1,autoScroll:true,listeners:{itemdblclick:function(e,d,f){this._startExistingProject(d.data);},scope:this}},{xtype:"container",margin:0,items:{xtype:"container",margin:10,baseCls:"doubleClickLine",html:"double click a project to edit it",},style:{backgroundColor:"white"}},{xtype:"container",margin:0,style:{textAlign:"right",backgroundColor:"black",color:"white",fontSize:".9em",fontStyle:"italic",padding:"2px"},html:Ext.String.format('version {0}, <a href="http://github.com/city41/LoveToPixel" target="_blank">github</a>',LTP.version)}]};this.callParent(arguments);this.on("afterrender",this._centerItems,this);},_getInitialSizeValue:function(){return localStorage[c]||"600x400";},_getSizeFromSizeField:function(){var f=this.down("#sizeField");var d=f.getValue();var e=b(d);if(e){localStorage[c]=d;}return e;},_getNameFromNameField:function(){var d=this.down("#nameField").getValue();return d||"Untitled Project";},_setSizeAndImageDataFromFile:function(d,e,f){LTP.ImageLoader.load(d,function(g){e.size=s(g.width,g.height);e.layers[0].data=g.src;f();});},_onWindowResize:function(e,d){this.setSize(e,d);this._centerItems();},_centerItems:function(){var d=this.down("#chooserPanel");if(this.el&&d&&d.el){var e=this.getWidth();var f=(e-d.getWidth())/2;d.el.setStyle("margin-left",f+"px");d.el.setStyle("margin-right",f+"px");}},_onFileReceived:function(d){function f(h){var g={size:s(h.width,h.height),name:d.name,isDirty:true,layers:[{layerName:"Initial Layer",isVisible:true,index:3,data:h.src}]};this._go(g);}function e(g){Ext.MessageBox.alert("Error",g);}LTP.ImageLoader.load(d,f,e,this);},_startNewProject:function(){var d=this._getSizeFromSizeField();if(!d){return;}var e={name:this._getNameFromNameField(),layers:[{id:1,layerName:"Initial Layer",isVisible:true,index:3,data:null}],isDirty:true,size:d};this._go(e);},_startExistingProject:function(d){this._go(d);},_go:function(d){this.fireEvent("projectChosen",d);this.destroy();}});})();(function(){Ext.define("LTP.LayerPanel",{extend:"Ext.panel.Panel",layout:{type:"vbox",align:"stretch"},height:"100%",width:"100%",itemId:"layerPanel",border:false,constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("canvasContentChange",this._onCanvasContentChange,this);this._messageBus.subscribe("newLayerCreated",this._onNewLayerCreated,this);this._messageBus.subscribe("layerLoad",this._onCanvasContentChange,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("layerRemoved",this._onLayerRemoved,this);},initComponent:function(){var a=Ext.create("Ext.data.Store",{model:"LTP.LayerModel"});this.viewStore=a;this.viewStore.sync=function(){};var b=this;this.dockedItems=[{dock:"top",xtype:"toolbar",items:[{text:"New Layer",listeners:{click:this._onNewClick,scope:this}},{text:"Flatten",listeners:{click:this._onFlattenClick,scope:this}}]}];this.items=[{xtype:"ltp.dragdropzone",style:{paddingLeft:"10px",paddingTop:"2px",paddingBottom:"2px",backgroundColor:"#999999",fontStyle:"italic"},html:"drag an image here to create a layer",resetColor:"#999999",listeners:{filereceived:this._onFileReceived,scope:this}},{xtype:"grid",hideHeaders:true,itemId:"layerGrid",multiSelect:false,sortableColumns:false,viewConfig:{plugins:{ptype:"gridviewdragdrop",dragText:"Drag to re-arrange layer ordering"},listeners:{drop:function(d,f,e,c){var g=c==="before"?"Ahead":"Behind";b.layerManager["moveLayer"+g](f.records[0].data,e.data);}}},store:a,minHeight:100,columns:[{dataIndex:"layerName",flex:2,field:{xtype:"textfield"},menuDisabled:true},{xtype:"templatecolumn",tpl:'<div style="height:{thumbnailHeight}px; width:{thumbnailWidth}px"><img class="thumbnail" src="{thumbnailData}" /></div>',flex:1,dataIndex:"thumbnailData",menuDisabled:true},{xtype:"actioncolumn",width:75,items:[{icon:"/images/visible.png",getClass:this._getVisibleIcon,tooltip:"Toggle visibility",handler:function(d,e,c){this.up("#layerPanel")._toggleVisibilityAt(e);}},{icon:"/images/merge.png",getClass:this._getMergeIcon,tooltip:"Merge into layer below",handler:function(d,e,c){this.up("#layerPanel")._deleteOrMergeAt(e,"merge");}},{icon:"/images/delete.png",tooltip:"Delete",iconCls:"x-grid-center-icon",handler:function(d,e,c){this.up("#layerPanel")._deleteOrMergeAt(e,"delete");}}],menuDisabled:true}],selType:"rowmodel",plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2,listeners:{edit:function(c,d){c.context.record.commit();}}})],listeners:{selectionchange:this._selectionChange,scope:this}}];this.disabled=true;this.callParent(arguments);},_getMergeIcon:function(d,e,a,f,c,b){return f<b.count()-1?"x-grid-center-icon":"x-hide-display";},_getVisibleIcon:function(b,c,a){return a.get("isVisible")?"x-grid-center-icon":"x-grid-center-icon closed-eye-visibility";},load:function(b){this.layerManager=b;this._addLayersToStore(this.viewStore,b);this.setDisabled(false);var a=this.down("#layerGrid");a.getSelectionModel().select(a.store.first());},_onFileReceived:function(a){function c(d){this.layerManager.addNewLayerFromImage(d);}function b(d){Ext.MessageBox.alert("Error",d);}LTP.ImageLoader.load(a,c,b,this);},_selectionChange:function(a,c,b){if(c&&c.length){this.layerManager.setActiveLayerByLayer(c[0].data);}},_onFlattenClick:function(){Ext.MessageBox.confirm("Flatten?","Flatten all layers into one?<br/> This cannot be undone",function(a){if(a==="yes"){this.layerManager.flatten();}},this);},_onNewLayerCreated:function(c){var b=Ext.create("LTP.LayerModel");b.data=c;this.viewStore.insert(0,[b]);var a=this.down("#layerGrid");a.getSelectionModel().select(b,false);},_onNewClick:function(){this.layerManager.addNewLayer();},_addLayersToStore:function(a,e){for(var d=0;d<e.layers.length;++d){var c=e.layers[d];var b=Ext.create("LTP.LayerModel");b.data=c;a.insert(0,[b]);}},_onCanvasContentChange:function(b){var a=this._findRecordByCanvas(b);if(a){a.commit();}},_onActiveLayerChanged:function(c){var a=this._findRecordByCanvas(c);if(a){var b=this.down("#layerGrid");b.getSelectionModel().select(a,false);}},_onLayerRemoved:function(b){var a=this._findRecordByCanvas(b);if(a){this.viewStore.remove(a);}},_findRecordByCanvas:function(a){var b;this.viewStore.each(function(c){if(c.data===a){b=c;return false;}});return b;},_toggleVisibilityAt:function(a){var b=this.viewStore.getAt(a);b.set("isVisible",!b.get("isVisible"));b.commit();},_deleteOrMergeAt:function(b,d){var c=this.viewStore.getAt(b);var a=Ext.String.capitalize(d);var e=Ext.String.format("Really {0} '{1}'? <br/>This cannot be undone.",d,c.get("layerName"));Ext.MessageBox.confirm(a+" Layer",e,function(f){if(f==="yes"){this.layerManager[d+"LayerByLayer"](c.data);}},this);}});})();(function(){var b,a;function c(d){b=d.getX();a=d.getY();}Ext.define("LTP.FloatingPalette",{extend:"Ext.panel.Panel",alias:"widget.ltp.floatingpalette",width:200,autoRender:true,floating:true,layout:"column",isPopped:false,constructor:function(d){this.callParent(arguments);this.messageBus=d.messageBus||LTP.GlobalMessageBus;},togglePopup:function(){if(!this.isPopped){this.showAt(b-this.width/2,a);}else{this.hide();}this.isPopped=!this.isPopped;}},function(){Ext.getDoc().on("mousemove",c);});})();(function(){var e;var b;function d(i){var h=i.button?"Right":"Left";var g=this.up("panel");g.colorManager["set"+h+"ColorTo"](this.index);g.hide();g.isPopped=false;if(e){e.hidePicker();e=null;}}function c(g){g.addEventListener("contextmenu",function(h){h.preventDefault();h.stopPropagation();return false;});}function f(){b=this;this.el.dom.value=b.color;e=new jscolor.color(b.el.dom,{pickerClosable:false,pickerPosition:"right",pickerZIndex:40000});e.showPicker();c(document.getElementById("jscolor.boxB"));}function a(i){if(i.target.id&&i.target.id.indexOf("colorswatch")>=0){return;}if(e&&i.target){if(!i.target.id||i.target.id.indexOf("jscolor.")===-1){if(b){b.color="#"+e.toString().toUpperCase();var g=b.up("panel");g.colorManager.redefineAt(b.index,b.color);var h=i.button?"Right":"Left";g.colorManager["set"+h+"ColorTo"](b.index);b=null;}e.hidePicker();e=null;if(this.isPopped){this.togglePopup();}}}}Ext.define("LTP.FloatingColorPalette",{extend:"LTP.FloatingPalette",alias:"widget.ltp.floatingcolorpalette",constructor:function(g,h){this.callParent(arguments);this.initialLeftColor=g;this.initialRightColor=h;this.messageBus.subscribe("leftColorSelected",this._onLeftColorSelected,this);this.messageBus.subscribe("rightColorSelected",this._onRightColorSelected,this);},dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{text:"Add Color",handler:function(){var g=this.up("panel");g.addColor();}}]}],defaults:{xtype:"ltp.colorswatch"},initComponent:function(){var g=[];var k=this;for(var h=0;h<this.colorManager.colors.length;++h){var j={color:this.colorManager.colors[h],index:h,listeners:{click:d,longclick:f}};if(h<9){j.label=(h+1).toString();}g.push(j);}this.items=g;Ext.getBody().on("mousedown",a,this);this.callParent(arguments);this._onLeftColorSelected(this.initialLeftColor);this._onRightColorSelected(this.initialRightColor);},addColor:function(){this.add({color:colors.white,index:this.items.items.length,listeners:{click:d,longclick:f}});this.colorManager.addColor(colors.white);},_onLeftColorSelected:function(g){Ext.Array.each(this.items.items,function(h){h.setIsCurrentLeft(h.color===g);});},_onRightColorSelected:function(g){Ext.Array.each(this.items.items,function(h){h.setIsCurrentRight(h.color===g);});},togglePopup:function(){this.callParent(arguments);if(!this.isPopped){if(e){e.hidePicker();e=null;}}}});})();(function(){Ext.define("LTP.FloatingSizePalette",{extend:"LTP.FloatingPalette",alias:"widget.ltp.floatingsizepalette",width:41*5,defaults:{xtype:"ltp.sizeswatch"},initComponent:function(){var c=this.sizes||[];var a=[];for(var b=0;b<c.length;++b){a.push({size:c[b],listeners:{click:function(){var d=this.up("panel");d.hide();d.isPopped=false;}}});}this.items=a;this.callParent(arguments);},});})();(function(){Ext.define("LTP.Publisher",{extend:"Ext.window.Window",alias:"widget.ltp.publisher",title:"Publish",items:[{xtype:"container",html:"This image will get uploaded to Imgur",margin:10,},{xtype:"container",itemId:"thumbnail",margin:10,html:'<img id="_publisherThumbnailImg" class="thumbnail" alt="thumbnail of what is going to be published" />'},{xtype:"textfield",itemId:"titleField",fieldLabel:"Title",margin:10,enableKeyEvents:true,listeners:{keydown:function(c,b){if(b.keyCode===Ext.EventObject.ENTER){var a=this.up("window");a._publishClick();}}}},{xtype:"container",itemId:"resultContainer"}],buttons:[{text:"Publish",itemId:"publishButton",handler:function(){this.up("window")._publishClick();}},{text:"Cancel",itemId:"closeButton",handler:function(){this.up("window").close();}}],constructor:function(a){this.callParent(arguments);Ext.apply(this,a);},initComponent:function(){this.callParent(arguments);this.on("afterrender",this._onAfterRender,this);},_onAfterRender:function(){var a=this.layerManager.composite(s(300,300));Ext.fly("_publisherThumbnailImg").dom.src=a.toDataURL();this.down("#thumbnail").setHeight(a.height+20);this.setWidth(Math.max(a.width+50,300));this.down("#titleField").setValue(this.projectName);},_publishClick:function(){var a=Ext.create("Ext.LoadMask",this.el,{msg:"Uploading..."});a.show();this.down("#publishButton").setDisabled(true);this.down("#closeButton").setText("OK");var c=this.down("#titleField").getValue();var b=this;this._publish(c,function(e){var d=b.down("#resultContainer");d.add({xtype:"container",html:e.message,margin:10});if(e.success){d.add({xtype:"container",html:Ext.String.format('<a href="http://www.reddit.com/r/pixelart/submit?url={0}&title={1}" target="_blank">Submit to Reddit</a>',e.imgurImgLink,encodeURI(e.imgurTitle)),margin:10});}a.destroy();});},_publish:function(c,e){var d=this.layerManager.composite();var b=d.toDataURL("image/png").split(",")[1];var a=Ext.create("Ext.data.Connection",{useDefaultXhrHeader:false});a.request({cors:true,url:"http://api.imgur.com/2/upload.json",type:"POST",params:{type:"base64",key:"c61f0d1212952dc31b6bd8311493ecea",name:c,title:c,caption:"Created with love to pixel, http://www.lovetopixel.com",image:b},success:function(g,j){var f=JSON.parse(g.responseText);var i=f.upload.links.imgur_page;var h=f.upload.links.original;e({success:true,imgurTitle:c,imgurLink:i,imgurImgLink:h,message:Ext.String.format('Published to <a href="{0}" target="_blank">{0}</a>',i)});},failure:function(){e({success:false,message:"There was an error publishing to Imgur, please try again later"});},scope:this});}});})();(function(){var m=[0.125,0.25,0.5,1,1.5,2,3,4,6,8,16,32];var g=m.indexOf(1);var n=undefined;var c=g;var e=[0,5,10,15,20];var b=e.indexOf(0);var h=new LTP.FillTool();var i=new LTP.EyeDropperTool();var a=new LTP.PanningTool();var k=new LTP.BrushTool();var o=[LTP.DirectionLockTransformer.directions.upDown,LTP.DirectionLockTransformer.directions.leftRight];var l=0;var j=[colors.white,colors.black,colors.red,colors.lightGray,colors.blue,colors.green,colors.yellow,colors.orange,colors.purple,colors.gray,colors.brown,"#FF9999","#33AA11","#333333","#88AAFF","#337722",];var d=[1,2,3,4,5,8,14,20,24,30];var f={callbacks:{h:{fn:function(){Ext.create("LTP.HelpWindow",{commands:LTP.app.callbacks}).show();},message:"Display this help"},c:{fn:function(){if(!LTP.app.floatingColorPalette){LTP.app.floatingColorPalette=Ext.create("LTP.FloatingColorPalette",{colorManager:LTP.app.colorManager,initialLeftColor:LTP.app.painter.leftColor,initialRightColor:LTP.app.painter.rightColor});}LTP.app.floatingColorPalette.togglePopup();},message:"Display the color palette. Press again (or ESC) to hide"},b:{fn:function(){if(!LTP.app.floatingSizePalette){LTP.app.floatingSizePalette=Ext.create("LTP.FloatingSizePalette",{sizes:d});}LTP.app.floatingSizePalette.togglePopup();},message:"Display the brush palette. Press again (or ESC) to hide"},dummy:{fn:function(){},label:"1-9",message:"Change the left color to the nth color in your color palette",shiftMessage:"Change the right color to the nth color in your color palette"},escdown:{fn:function(){if(LTP.app.floatingColorPalette&&LTP.app.floatingColorPalette.isPopped){LTP.app.floatingColorPalette.togglePopup();}if(LTP.app.floatingSizePalette&&LTP.app.floatingSizePalette.isPopped){LTP.app.floatingSizePalette.togglePopup();}},noHelp:true},z:{fn:function(p){var q=p?-1:1;c+=q;if(c>=m.length){c=m.length-1;}if(c<0){c=0;}LTP.GlobalMessageBus.publish("zoomChanged",m[c]);},message:"Zoom in",shiftMessage:"Zoom out"},u:{fn:function(p){if(p){LTP.app.painter.redo();}else{LTP.app.painter.undo();}},message:"Undo the last paint operation",shiftMessage:"Redo the last undone operation"},g:{fn:function(){b=(b+1)%e.length;LTP.app.grid.cellSize=e[b];},message:"Toggle the grid"},i:{fn:function(p){if(p){LTP.app.painter.rightTool=i;}else{LTP.app.painter.leftTool=i;}},message:"Set the left tool to the eye dropper",shiftMessage:"Set the right tool to the eye dropper"},k:{fn:function(p){if(p){LTP.app.painter.rightTool=h;}else{LTP.app.painter.leftTool=h;}},message:"Set the left tool to the paint bucket",shiftMessage:"Set the right tool to the paint bucket"},d:{fn:function(p){if(p){LTP.app.painter.rightTool=k;}else{LTP.app.painter.leftTool=k;}},message:"Set the left tool to the brush tool",shiftMessage:"Set the right tool to the brush tool"},adown:{fn:function(p){if(!p){n=c;}c=g;LTP.GlobalMessageBus.publish("zoomChanged",m[c]);},label:"a",message:"Hold to zoom to 100%, let go to return to your previous zoom",shiftMessage:"Return to 100% zoom"},aup:{fn:function(p){if(!p&&!!n){c=n;LTP.GlobalMessageBus.publish("zoomChanged",m[c]);}},noHelp:true},controldown:{fn:function(){var p=o[l];l=(l+1)%o.length;LTP.app.painter.adhocTransformer=new LTP.DirectionLockTransformer(p);LTP.GlobalMessageBus.publish("lockChanged",p);},label:"CTRL",message:"Hold to turn on direction lock. Cycles between vertical and horizontal lock"},controlup:{fn:function(){LTP.app.painter.adhocTransformer=null;LTP.GlobalMessageBus.publish("lockChanged",null);},noHelp:true},altdown:{fn:function(){LTP.app.painter.adhocTransformer=new LTP.BrushSizeLockTransformer();LTP.GlobalMessageBus.publish("lockChanged","brush");},label:"ALT",message:"Hold to lock the brush to the current brush size"},altup:{fn:function(){LTP.app.painter.adhocTransformer=null;LTP.GlobalMessageBus.publish("lockChanged",null);},noHelp:true},s:{fn:function(){LTP.app.projectPersister.saveProject(LTP.app._currentProject,LTP.app.layerManager.layers,LTP.app.colorManager.getColorsAsString());LTP.GlobalMessageBus.publish("flairMessage","Project Saved");LTP.app._currentProject.isDirty=false;},message:"Save the project (to local storage)"},e:{fn:function(){var p=LTP.app.layerManager.composite();window.open(p.toDataURL("png"),"savedImage");},message:"Export the project to an image (opens in a new window)"},"[":{fn:function(){LTP.app.layerManager.dumpLayers();},noHelp:true},n:{fn:function(){window.location.reload();},message:"Return to the project chooser"},p:{fn:function(){Ext.create("LTP.Publisher",{layerManager:LTP.app.layerManager,projectName:LTP.app._currentProject.name}).show();},message:"Publish your project to imgur"}},init:function(p){Ext.apply(this,p);this.showProjectChooser();},showProjectChooser:function(){this.projectPersister=new LTP.ProjectPersister();this.projectPersister.loadAllProjects(function(p){this.projectChooser=Ext.create("LTP.ProjectChooser",{renderTo:Ext.getBody(),projects:p,listeners:{projectChosen:this._load,scope:this}});},this);},_createDomStructure:function(){Ext.getBody().createChild('<div id="layerPanelElement"></div>');Ext.getBody().createChild('<div id="outerContainerElement"><div id="containerElement"></div></div >');Ext.getBody().createChild('<div id="statusBarElement"></div>');},_load:function(q){this._currentProject=q;document.title=q.name+" - ltp";this._createDomStructure();this.statusBar=Ext.create("LTP.StatusBar",{renderTo:"statusBarElement"});this.layerPanel=Ext.create("LTP.LayerPanel",{renderTo:"layerPanelElement"});this.colorManager=new LTP.ColorManager();this.colorManager.setColorsFromString(q.palette,j);this.layerManager=new LTP.LayerManager(q);this.container=new LTP.Container(q.size,document.getElementById("containerElement"));this.painter=new LTP.Painter(q.size,new LTP.PointTransformer());this.grid=new LTP.Grid(q.size,"gray",0);Ext.Array.each(this.layerManager.layers,function(r){this.container.addLayer(r);},this);this.painter.activeCanvas=this.layerManager.activeLayer;this.container.overlay=this.painter.overlay;this.container.grid=this.grid.canvas;this.container.scratch=this.painter.scratch;LTP.GlobalMessageBus.subscribe("colorSampled",function(t,s,r){var u=r===0?"left":"right";LTP.GlobalMessageBus.publish(u+"ColorSelected",s);},this);for(var p=1;p<10;++p){this.callbacks[p.toString()]=(function(r){return function(s){var t=s?"Right":"Left";LTP.app.colorManager["set"+t+"ColorTo"](r-1);};})(p);}this.keyListener=new LTP.KeyListener(this);LTP.GlobalMessageBus.publish("activeLayerChanged",this.layerManager.activeLayer);LTP.GlobalMessageBus.publish("rightColorSelected",this.painter.rightColor);LTP.GlobalMessageBus.publish("leftColorSelected",this.painter.leftColor);this._addCloseWarningHook();this.layerPanel.load(this.layerManager);},_addCloseWarningHook:function(){LTP.GlobalMessageBus.subscribe("canvasContentChange",function(){this._currentProject.isDirty=true;},this);LTP.GlobalMessageBus.subscribe("paletteContentChange",function(){this._currentProject.isDirty=true;},this);var p=this;window.onbeforeunload=function(){if(p._currentProject.isDirty){return"There are unsaved changes to this project";}};}};LTP.app=f;})();