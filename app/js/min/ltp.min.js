Ext.override(Ext.data.proxy.WebStorage,{setRecord:function(j,c){if(c){j.setId(c);}else{c=j.getId();}var l=this,a=j.data,g={},h=l.model,k=h.prototype.fields.items,d=k.length,f=0,m,b,e,n;for(;f<d;f++){m=k[f];if(m.persist!==false){b=m.name;if(typeof m.encode=="function"){g[b]=m.encode(a[b],j);}else{g[b]=a[b];}}}e=l.getStorageObject();n=l.getRecordKey(c);l.cache[c]=j;e.removeItem(n);e.setItem(n,Ext.encode(g));}});var jscolor={dir:"js/lib/jscolor/",bindClass:"color",binding:false,preloading:false,getDir:function(){if(!jscolor.dir){var a=jscolor.detectDir();jscolor.dir=a!==false?a:"jscolor/";}return jscolor.dir;},detectDir:function(){var c=location.href;var d=document.getElementsByTagName("base");for(var a=0;a<d.length;a+=1){if(d[a].href){c=d[a].href;}}var d=document.getElementsByTagName("script");for(var a=0;a<d.length;a+=1){if(d[a].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(d[a].src)){var f=new jscolor.URI(d[a].src);var b=f.toAbsolute(c);b.path=b.path.replace(/[^\/]+$/,"");b.query=null;b.fragment=null;return b.toString();}}return false;},bind:function(){var matchClass=new RegExp("(^|\\s)("+jscolor.bindClass+")\\s*(\\{[^}]*\\})?","i");var e=document.getElementsByTagName("input");for(var i=0;i<e.length;i+=1){var m;if(!e[i].color&&e[i].className&&(m=e[i].className.match(matchClass))){var prop={};if(m[3]){try{eval("prop="+m[3]);}catch(eInvalidProp){}}e[i].color=new jscolor.color(e[i],prop);}}},preload:function(){for(var a in jscolor.imgRequire){if(jscolor.imgRequire.hasOwnProperty(a)){jscolor.loadImage(a);}}},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(a){jscolor.imgRequire[a]=true;},loadImage:function(a){if(!jscolor.imgLoaded[a]){jscolor.imgLoaded[a]=new Image();jscolor.imgLoaded[a].src=jscolor.getDir()+a;}},fetchElement:function(a){return typeof a==="string"?document.getElementById(a):a;},addEvent:function(a,c,b){if(a.addEventListener){a.addEventListener(c,b,false);}else{if(a.attachEvent){a.attachEvent("on"+c,b);}}},fireEvent:function(a,c){if(!a){return;}if(document.createEvent){var b=document.createEvent("HTMLEvents");b.initEvent(c,true,true);a.dispatchEvent(b);}else{if(document.createEventObject){var b=document.createEventObject();a.fireEvent("on"+c,b);}else{if(a["on"+c]){a["on"+c]();}}}},getElementPos:function(c){var d=c,b=c;var a=0,f=0;if(d.offsetParent){do{a+=d.offsetLeft;f+=d.offsetTop;}while(d=d.offsetParent);}while((b=b.parentNode)&&b.nodeName.toUpperCase()!=="BODY"){a-=b.scrollLeft;f-=b.scrollTop;}return[a,f];},getElementSize:function(a){return[a.offsetWidth,a.offsetHeight];},getRelMousePos:function(b){var a=0,c=0;if(!b){b=window.event;}if(typeof b.offsetX==="number"){a=b.offsetX;c=b.offsetY;}else{if(typeof b.layerX==="number"){a=b.layerX;c=b.layerY;}}return{x:a,y:c};},getViewPos:function(){if(typeof window.pageYOffset==="number"){return[window.pageXOffset,window.pageYOffset];}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){return[document.body.scrollLeft,document.body.scrollTop];}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){return[document.documentElement.scrollLeft,document.documentElement.scrollTop];}else{return[0,0];}}}},getViewSize:function(){if(typeof window.innerWidth==="number"){return[window.innerWidth,window.innerHeight];}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){return[document.body.clientWidth,document.body.clientHeight];}else{if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){return[document.documentElement.clientWidth,document.documentElement.clientHeight];}else{return[0,0];}}}},URI:function(a){this.scheme=null;this.authority=null;this.path="";this.query=null;this.fragment=null;this.parse=function(d){var c=d.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);this.scheme=c[3]?c[2]:null;this.authority=c[5]?c[6]:null;this.path=c[7];this.query=c[9]?c[10]:null;this.fragment=c[12]?c[13]:null;return this;};this.toString=function(){var c="";if(this.scheme!==null){c=c+this.scheme+":";}if(this.authority!==null){c=c+"//"+this.authority;}if(this.path!==null){c=c+this.path;}if(this.query!==null){c=c+"?"+this.query;}if(this.fragment!==null){c=c+"#"+this.fragment;}return c;};this.toAbsolute=function(e){var e=new jscolor.URI(e);var d=this;var c=new jscolor.URI;if(e.scheme===null){return false;}if(d.scheme!==null&&d.scheme.toLowerCase()===e.scheme.toLowerCase()){d.scheme=null;}if(d.scheme!==null){c.scheme=d.scheme;c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.authority!==null){c.authority=d.authority;c.path=b(d.path);c.query=d.query;}else{if(d.path===""){c.path=e.path;if(d.query!==null){c.query=d.query;}else{c.query=e.query;}}else{if(d.path.substr(0,1)==="/"){c.path=b(d.path);}else{if(e.authority!==null&&e.path===""){c.path="/"+d.path;}else{c.path=e.path.replace(/[^\/]+$/,"")+d.path;}c.path=b(c.path);}c.query=d.query;}c.authority=e.authority;}c.scheme=e.scheme;}c.fragment=d.fragment;return c;};function b(e){var c="";while(e){if(e.substr(0,3)==="../"||e.substr(0,2)==="./"){e=e.replace(/^\.+/,"").substr(1);}else{if(e.substr(0,3)==="/./"||e==="/."){e="/"+e.substr(3);}else{if(e.substr(0,4)==="/../"||e==="/.."){e="/"+e.substr(4);c=c.replace(/\/?[^\/]*$/,"");}else{if(e==="."||e===".."){e="";}else{var d=e.match(/^\/?[^\/]*/)[0];e=e.substr(d.length);c=c+d;}}}}}return c;}if(a){this.parse(a);}},color:function(target,prop){this.required=true;this.adjust=true;this.hash=false;this.caps=true;this.slider=true;this.valueElement=target;this.styleElement=target;this.onImmediateChange=null;this.hsv=[0,0,1];this.rgb=[1,1,1];this.pickerOnfocus=true;this.pickerMode="HSV";this.pickerPosition="bottom";this.pickerSmartPosition=true;this.pickerButtonHeight=20;this.pickerClosable=false;this.pickerCloseText="Close";this.pickerButtonColor="ButtonText";this.pickerFace=10;this.pickerFaceColor="ThreeDFace";this.pickerBorder=1;this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight";this.pickerInset=1;this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow";this.pickerZIndex=10000;for(var p in prop){if(prop.hasOwnProperty(p)){this[p]=prop[p];}}this.hidePicker=function(){if(isPickerOwner()){removePicker();}};this.showPicker=function(){if(!isPickerOwner()){var tp=jscolor.getElementPos(target);var ts=jscolor.getElementSize(target);var vp=jscolor.getViewPos();var vs=jscolor.getViewSize();var ps=getPickerDims(this);var a,b,c;switch(this.pickerPosition.toLowerCase()){case"left":a=1;b=0;c=-1;break;case"right":a=1;b=0;c=1;break;case"top":a=0;b=1;c=-1;break;default:a=0;b=1;c=1;break;}var l=(ts[b]+ps[b])/2;if(!this.pickerSmartPosition){var pp=[tp[a],tp[b]+ts[b]-l+l*c];}else{var pp=[-vp[a]+tp[a]+ps[a]>vs[a]?(-vp[a]+tp[a]+ts[a]/2>vs[a]/2&&tp[a]+ts[a]-ps[a]>=0?tp[a]+ts[a]-ps[a]:tp[a]):tp[a],-vp[b]+tp[b]+ts[b]+ps[b]-l+l*c>vs[b]?(-vp[b]+tp[b]+ts[b]/2>vs[b]/2&&tp[b]+ts[b]-l-l*c>=0?tp[b]+ts[b]-l-l*c:tp[b]+ts[b]-l+l*c):(tp[b]+ts[b]-l+l*c>=0?tp[b]+ts[b]-l+l*c:tp[b]+ts[b]-l-l*c)];}drawPicker(pp[a],pp[b]);}};this.importColor=function(){if(!valueElement){this.exportColor();}else{if(!this.adjust){if(!this.fromString(valueElement.value,leaveValue)){styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor;styleElement.style.color=styleElement.jscStyle.color;this.exportColor(leaveValue|leaveStyle);}}else{if(!this.required&&/^\s*$/.test(valueElement.value)){valueElement.value="";styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor;styleElement.style.color=styleElement.jscStyle.color;this.exportColor(leaveValue|leaveStyle);}else{if(this.fromString(valueElement.value)){}else{this.exportColor();}}}}};this.exportColor=function(flags){if(!(flags&leaveValue)&&valueElement){var value=this.toString();if(this.caps){value=value.toUpperCase();}if(this.hash){value="#"+value;}valueElement.value=value;}if(!(flags&leaveStyle)&&styleElement){styleElement.style.backgroundColor="#"+this.toString();styleElement.style.color=0.213*this.rgb[0]+0.715*this.rgb[1]+0.072*this.rgb[2]<0.5?"#FFF":"#000";}if(!(flags&leavePad)&&isPickerOwner()){redrawPad();}if(!(flags&leaveSld)&&isPickerOwner()){redrawSld();}};this.fromHSV=function(h,s,v,flags){h<0&&(h=0)||h>6&&(h=6);s<0&&(s=0)||s>1&&(s=1);v<0&&(v=0)||v>1&&(v=1);this.rgb=HSV_RGB(h===null?this.hsv[0]:(this.hsv[0]=h),s===null?this.hsv[1]:(this.hsv[1]=s),v===null?this.hsv[2]:(this.hsv[2]=v));this.exportColor(flags);};this.fromRGB=function(r,g,b,flags){r<0&&(r=0)||r>1&&(r=1);g<0&&(g=0)||g>1&&(g=1);b<0&&(b=0)||b>1&&(b=1);var hsv=RGB_HSV(r===null?this.rgb[0]:(this.rgb[0]=r),g===null?this.rgb[1]:(this.rgb[1]=g),b===null?this.rgb[2]:(this.rgb[2]=b));if(hsv[0]!==null){this.hsv[0]=hsv[0];}if(hsv[2]!==0){this.hsv[1]=hsv[1];}this.hsv[2]=hsv[2];this.exportColor(flags);};this.fromString=function(hex,flags){var m=hex.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);if(!m){return false;}else{if(m[1].length===6){this.fromRGB(parseInt(m[1].substr(0,2),16)/255,parseInt(m[1].substr(2,2),16)/255,parseInt(m[1].substr(4,2),16)/255,flags);}else{this.fromRGB(parseInt(m[1].charAt(0)+m[1].charAt(0),16)/255,parseInt(m[1].charAt(1)+m[1].charAt(1),16)/255,parseInt(m[1].charAt(2)+m[1].charAt(2),16)/255,flags);}return true;}};this.toString=function(){return((256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1));};function RGB_HSV(r,g,b){var n=Math.min(Math.min(r,g),b);var v=Math.max(Math.max(r,g),b);var m=v-n;if(m===0){return[null,0,v];}var h=r===n?3+(b-g)/m:(g===n?5+(r-b)/m:1+(g-r)/m);return[h===6?0:h,m/v,v];}function HSV_RGB(h,s,v){if(h===null){return[v,v,v];}var i=Math.floor(h);var f=i%2?h-i:1-(h-i);var m=v*(1-s);var n=v*(1-s*f);switch(i){case 6:case 0:return[v,n,m];case 1:return[n,v,m];case 2:return[m,v,n];case 3:return[m,n,v];case 4:return[n,m,v];case 5:return[v,m,n];}}function removePicker(){delete jscolor.picker.owner;document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB);}function drawPicker(x,y){if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),btn:document.createElement("div"),btnS:document.createElement("span"),btnT:document.createTextNode(THIS.pickerCloseText)};for(var elem in jscolor.picker){if(jscolor.picker.hasOwnProperty(elem)){jscolor.picker[elem].id="jscolor."+elem;}}for(var i=0,segSize=4;i<jscolor.images.sld[1];i+=segSize){var seg=document.createElement("div");seg.style.height=segSize+"px";seg.style.fontSize="1px";seg.style.lineHeight="0";jscolor.picker.sld.appendChild(seg);}jscolor.picker.sldB.appendChild(jscolor.picker.sld);jscolor.picker.box.appendChild(jscolor.picker.sldB);jscolor.picker.box.appendChild(jscolor.picker.sldM);jscolor.picker.padB.appendChild(jscolor.picker.pad);jscolor.picker.box.appendChild(jscolor.picker.padB);jscolor.picker.box.appendChild(jscolor.picker.padM);jscolor.picker.btnS.appendChild(jscolor.picker.btnT);jscolor.picker.btn.appendChild(jscolor.picker.btnS);jscolor.picker.box.appendChild(jscolor.picker.btn);jscolor.picker.boxB.appendChild(jscolor.picker.box);}var p=jscolor.picker;p.box.onmouseup=p.box.onmouseout=function(){target.focus();};p.box.onmousedown=function(){abortBlur=true;};p.box.onmousemove=function(e){if(holdPad||holdSld){holdPad&&setPad(e);holdSld&&setSld(e);if(document.selection){document.selection.empty();}else{if(window.getSelection){window.getSelection().removeAllRanges();}}dispatchImmediateChange();}};p.padM.onmouseup=p.padM.onmouseout=function(){if(holdPad){holdPad=false;jscolor.fireEvent(valueElement,"change");}};p.padM.onmousedown=function(e){holdPad=true;setPad(e);dispatchImmediateChange();};p.sldM.onmouseup=p.sldM.onmouseout=function(){if(holdSld){holdSld=false;jscolor.fireEvent(valueElement,"change");}};p.sldM.onmousedown=function(e){holdSld=true;setSld(e);dispatchImmediateChange();};var dims=getPickerDims(THIS);p.box.style.width=dims[0]+"px";p.box.style.height=dims[1]+"px";p.boxB.style.position="absolute";p.boxB.style.clear="both";p.boxB.style.left=x+"px";p.boxB.style.top=y+"px";p.boxB.style.zIndex=THIS.pickerZIndex;p.boxB.style.border=THIS.pickerBorder+"px solid";p.boxB.style.borderColor=THIS.pickerBorderColor;p.boxB.style.background=THIS.pickerFaceColor;p.pad.style.width=jscolor.images.pad[0]+"px";p.pad.style.height=jscolor.images.pad[1]+"px";p.padB.style.position="absolute";p.padB.style.left=THIS.pickerFace+"px";p.padB.style.top=THIS.pickerFace+"px";p.padB.style.border=THIS.pickerInset+"px solid";p.padB.style.borderColor=THIS.pickerInsetColor;p.padM.style.position="absolute";p.padM.style.left="0";p.padM.style.top="0";p.padM.style.width=THIS.pickerFace+2*THIS.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px";p.padM.style.height=p.box.style.height;p.padM.style.cursor="crosshair";p.sld.style.overflow="hidden";p.sld.style.width=jscolor.images.sld[0]+"px";p.sld.style.height=jscolor.images.sld[1]+"px";p.sldB.style.display=THIS.slider?"block":"none";p.sldB.style.position="absolute";p.sldB.style.right=THIS.pickerFace+"px";p.sldB.style.top=THIS.pickerFace+"px";p.sldB.style.border=THIS.pickerInset+"px solid";p.sldB.style.borderColor=THIS.pickerInsetColor;p.sldM.style.display=THIS.slider?"block":"none";p.sldM.style.position="absolute";p.sldM.style.right="0";p.sldM.style.top="0";p.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+THIS.pickerFace+2*THIS.pickerInset+"px";p.sldM.style.height=p.box.style.height;try{p.sldM.style.cursor="pointer";}catch(eOldIE){p.sldM.style.cursor="hand";}function setBtnBorder(){var insetColors=THIS.pickerInsetColor.split(/\s+/);var pickerOutsetColor=insetColors.length<2?insetColors[0]:insetColors[1]+" "+insetColors[0]+" "+insetColors[0]+" "+insetColors[1];p.btn.style.borderColor=pickerOutsetColor;}p.btn.style.display=THIS.pickerClosable?"block":"none";p.btn.style.position="absolute";p.btn.style.left=THIS.pickerFace+"px";p.btn.style.bottom=THIS.pickerFace+"px";p.btn.style.padding="0 15px";p.btn.style.height="18px";p.btn.style.border=THIS.pickerInset+"px solid";setBtnBorder();p.btn.style.color=THIS.pickerButtonColor;p.btn.style.font="12px sans-serif";p.btn.style.textAlign="center";try{p.btn.style.cursor="pointer";}catch(eOldIE){p.btn.style.cursor="hand";}p.btn.onmousedown=function(){THIS.hidePicker();};p.btnS.style.lineHeight=p.btn.style.height;switch(modeID){case 0:var padImg="hs.png";break;case 1:var padImg="hv.png";break;}p.padM.style.backgroundImage="url('"+jscolor.getDir()+"cross.gif')";p.padM.style.backgroundRepeat="no-repeat";p.sldM.style.backgroundImage="url('"+jscolor.getDir()+"arrow.gif')";p.sldM.style.backgroundRepeat="no-repeat";p.pad.style.backgroundImage="url('"+jscolor.getDir()+padImg+"')";p.pad.style.backgroundRepeat="no-repeat";p.pad.style.backgroundPosition="0 0";redrawPad();redrawSld();jscolor.picker.owner=THIS;document.getElementsByTagName("body")[0].appendChild(p.boxB);}function getPickerDims(o){var dims=[2*o.pickerInset+2*o.pickerFace+jscolor.images.pad[0]+(o.slider?2*o.pickerInset+2*jscolor.images.arrow[0]+jscolor.images.sld[0]:0),o.pickerClosable?4*o.pickerInset+3*o.pickerFace+jscolor.images.pad[1]+o.pickerButtonHeight:2*o.pickerInset+2*o.pickerFace+jscolor.images.pad[1]];return dims;}function redrawPad(){switch(modeID){case 0:var yComponent=1;break;case 1:var yComponent=2;break;}var x=Math.round((THIS.hsv[0]/6)*(jscolor.images.pad[0]-1));var y=Math.round((1-THIS.hsv[yComponent])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=(THIS.pickerFace+THIS.pickerInset+x-Math.floor(jscolor.images.cross[0]/2))+"px "+(THIS.pickerFace+THIS.pickerInset+y-Math.floor(jscolor.images.cross[1]/2))+"px";var seg=jscolor.picker.sld.childNodes;switch(modeID){case 0:var rgb=HSV_RGB(THIS.hsv[0],THIS.hsv[1],1);for(var i=0;i<seg.length;i+=1){seg[i].style.backgroundColor="rgb("+(rgb[0]*(1-i/seg.length)*100)+"%,"+(rgb[1]*(1-i/seg.length)*100)+"%,"+(rgb[2]*(1-i/seg.length)*100)+"%)";}break;case 1:var rgb,s,c=[THIS.hsv[2],0,0];var i=Math.floor(THIS.hsv[0]);var f=i%2?THIS.hsv[0]-i:1-(THIS.hsv[0]-i);switch(i){case 6:case 0:rgb=[0,1,2];break;case 1:rgb=[1,0,2];break;case 2:rgb=[2,0,1];break;case 3:rgb=[2,1,0];break;case 4:rgb=[1,2,0];break;case 5:rgb=[0,2,1];break;}for(var i=0;i<seg.length;i+=1){s=1-1/(seg.length-1)*i;c[1]=c[0]*(1-s*f);c[2]=c[0]*(1-s);seg[i].style.backgroundColor="rgb("+(c[rgb[0]]*100)+"%,"+(c[rgb[1]]*100)+"%,"+(c[rgb[2]]*100)+"%)";}break;}}function redrawSld(){switch(modeID){case 0:var yComponent=2;break;case 1:var yComponent=1;break;}var y=Math.round((1-THIS.hsv[yComponent])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(THIS.pickerFace+THIS.pickerInset+y-Math.floor(jscolor.images.arrow[1]/2))+"px";}function isPickerOwner(){return jscolor.picker&&jscolor.picker.owner===THIS;}function blurTarget(){if(valueElement===target){THIS.importColor();}if(THIS.pickerOnfocus){THIS.hidePicker();}}function blurValue(){if(valueElement!==target){THIS.importColor();}}function setPad(e){var mpos=jscolor.getRelMousePos(e);var x=mpos.x-THIS.pickerFace-THIS.pickerInset;var y=mpos.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)),1-y/(jscolor.images.pad[1]-1),null,leaveSld);break;case 1:THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)),null,1-y/(jscolor.images.pad[1]-1),leaveSld);break;}}function setSld(e){var mpos=jscolor.getRelMousePos(e);var y=mpos.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(null,null,1-y/(jscolor.images.sld[1]-1),leavePad);break;case 1:THIS.fromHSV(null,1-y/(jscolor.images.sld[1]-1),null,leavePad);break;}}function dispatchImmediateChange(){if(THIS.onImmediateChange){if(typeof THIS.onImmediateChange==="string"){eval(THIS.onImmediateChange);}else{THIS.onImmediateChange(THIS);}}}var THIS=this;var modeID=this.pickerMode.toLowerCase()==="hvs"?1:0;var abortBlur=false;var valueElement=jscolor.fetchElement(this.valueElement),styleElement=jscolor.fetchElement(this.styleElement);var holdPad=false,holdSld=false;var leaveValue=1<<0,leaveStyle=1<<1,leavePad=1<<2,leaveSld=1<<3;jscolor.addEvent(target,"focus",function(){if(THIS.pickerOnfocus){THIS.showPicker();}});jscolor.addEvent(target,"blur",function(){if(!abortBlur){window.setTimeout(function(){abortBlur||blurTarget();abortBlur=false;},0);}else{abortBlur=false;}});if(valueElement){var updateField=function(){THIS.fromString(valueElement.value,leaveValue);dispatchImmediateChange();};jscolor.addEvent(valueElement,"keyup",updateField);jscolor.addEvent(valueElement,"input",updateField);jscolor.addEvent(valueElement,"blur",blurValue);valueElement.setAttribute("autocomplete","off");}if(styleElement){styleElement.jscStyle={backgroundColor:styleElement.style.backgroundColor,color:styleElement.style.color};}switch(modeID){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png");break;}jscolor.requireImage("cross.gif");jscolor.requireImage("arrow.gif");this.importColor();}};(function(){if(typeof Object.defineProperty!=="function"&&typeof Object.__defineGetter__==="function"){Object.defineProperty=function(c,b,a){if(typeof a.get==="function"){c.__defineGetter__(b,a.get);}if(typeof a.set==="function"){c.__defineSetter__(b,a.set);}};}})();(function(){function b(){return this;}function a(){var e=navigator.userAgent;var d=navigator.platform;info={};info.isOSX=(/Mac/i).test(d);info.isWindows=(/Windows/i).test(d);info.isLinux=(/Linux/i).test(d);info.isChrome=(/Chrome/i).test(e);info.isSafari=(/Safari/i).test(e)&&!info.isChrome;info.isFirefox=(/Firefox/i).test(e);info.isIE=(/MSIE/).test(e)&&info.isWindows;info.isOpera=(/Opera/i).test(e);return info;}var c=b.call(null);c.LTP=c.LTP||{};LTP.util={platformInfo:a(),ns:function(){for(var g=0,f=arguments.length;g<f;++g){var h=arguments[g].split(".");var d=h.indexOf("LTP")===0?c:LTP;for(var e=0,j=h.length;e<j;++e){if(d[h[e]]===undefined){d[h[e]]={};}d=d[h[e]];}}},bind:function(e,d){return function(){e.apply(d,arguments);};},toArray:function(e){var d=[];for(var f=0;f<e.length;++f){d.push(e[f]);}return d;},canvas:function(e,g){var d=document.createElement("canvas");d.width=e.width;d.height=e.height;if(g){for(var f in g){if(g.hasOwnProperty(f)){d.style[f]=g[f];}}}this.setImageRendering(d);return d;},setImageRendering:function(e){var d="optimizeSpeed";if(this.platformInfo.isOSX&&this.platformInfo.isChrome){d="-webkit-optimize-contrast";}if(this.platformInfo.isFirefox){d="-moz-crisp-edges";}e.style.imageRendering=d;},scaleSize:function(d,h){if(d.width<=h.width&&d.height<=h.height){return s(d.width,d.height);}var g=h.width/d.width;var e=h.height/d.height;var f=Math.min(g,e);return sr(d.width*f,d.height*f);},waitFor:function(d,f){if(d()){f();}else{var e=this;setTimeout(function(){e.waitFor(d,f);},50);}}};Object.defineProperty(LTP.util,"global",{get:function(){return c;},enumerable:true});})();(function(){LTP.compatibilityInfo=function(){var b={desktop:{available:Ext.is.Desktop,message:"LTP does not work on mobile devices yet",severity:4},"Object.defineProperty":{available:(function(){if(typeof Object.defineProperty!=="function"){return false;}var g=[document.createElement("div"),{}];try{for(var f=0;f<g.length;++f){var h=g[f];Object.defineProperty(h,"definePropTest",{get:function(){return 41;}});if(h.definePropTest!==41){return false;}}}catch(h){return false;}return true;})(),message:"Object.defineProperty is missing",severity:3},canvas:{available:!!window.HTMLCanvasElement,message:"canvas is missing",severity:2},"image-rendering":{available:(function(){var f=false;if(LTP.util.platformInfo.isChrome){f=LTP.util.platformInfo.isOSX;}if(LTP.util.platformInfo.isFirefox){f=true;}return f;})(),message:"nearest neighbor for image-rendering is missing",severity:1},FileReader:{available:!!window.FileReader,message:"FileReader is missing",severity:0},"Internet Explorer":{available:!LTP.util.platformInfo.isIE,message:"IE lacks key needed features",severity:4},Opera:{available:!LTP.util.platformInfo.isOpera,message:"Have not resolved all Opera issues yet",severity:4}};var c=true;var a=-1;var e;for(var d in b){if(b.hasOwnProperty(d)){c=c&&b[d].available;if(!b[d].available){a=Math.max(a,b[d].severity);if(a===b[d].severity){e=b[d].message;}}}}b.success=c;b.conclusion=e;return b;};})();(function(){Ext.define("LTP.LayerModel",{extend:"Ext.data.Model",fields:[{name:"layerId",type:"integer"},{name:"ltp.projectmodel_id",type:"integer"},{name:"layerName",type:"string"},{name:"index",type:"integer"},{name:"isVisible",type:"boolean"},{name:"data",type:"string"},{name:"thumbnailData",type:"string",persist:false},{name:"thumbnailHeight",type:"integer",persist:false},{name:"thumbnailWidth",type:"integer",persist:false}],associations:[{type:"belongsTo",model:"LTP.ProjectModel",name:"project"}],idProperty:"layerId",proxy:{type:"localstorage",id:"ltp-layers"}});})();(function(){Ext.define("LTP.ProjectModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"integer"},{name:"name",type:"string"},{name:"width",type:"integer"},{name:"height",type:"integer"},{name:"palette",type:"string"},{name:"lastSaved",type:"date"}],associations:[{type:"hasMany",model:"LTP.LayerModel",name:"layers",autoLoad:true}],proxy:{type:"localstorage",id:"ltp-projects"}});})();(function(){LTP.ProjectPersister=function a(){this._projectStore=Ext.create("Ext.data.Store",{model:"LTP.ProjectModel",autoLoad:false});};LTP.ProjectPersister.prototype={loadAllProjects:function(c,b){this._projectStore.load({scope:this,callback:function(){this._extract(this._projectStore,c,b);}});},saveProject:function(e,d,f){e.width=e.size.width;e.height=e.size.height;e.lastSaved=new Date();e.palette=f;var c;if(e.id){c=this._projectStore.getById(e.id);}else{c=this._projectStore.add({})[0];}c.data=e;c.dirty=true;this._projectStore.sync();var b=c.layers();Ext.Array.each(d,function(h){var g;if(h.layerId){g=b.getById(h.layerId);}else{g=b.add({})[0];}g.data=h;g.dirty=true;b.add(g);});b.each(function(g){if(!g.dirty){g.destroy();}});b.sync();},_extract:function(d,f,c){this.projects=[];var e=this;var b=d.count();if(b===0){f.call(c,e.projects);}else{d.each(function(h){var i=h.data;i.size=s(i.width,i.height);i.layers=[];var g=h.layers();g.each(function(j){i.layers.push(j.data);});this._createThumbnail(i,function(){--b;if(b===0){f.call(c,e.projects);}});this.projects.push(i);},this);}},_createThumbnail:function(c,d){var b=new LTP.LayerManager(c,new LTP.MessageBus(LTP.GlobalMessages));LTP.util.waitFor(function(){return b.dataLoaded;},function(){var e=b.composite(s(200,100));c.thumbnailData=e.toDataURL();c.thumbnailHeight=e.height;c.thumbnailWidth=e.width;d();});}};})();(function(){LTP.ImageLoader={load:function a(c,e,b,d){this.loadToDataURL(c,function(f){this.fromDataUrlToImg(f,e,d);},function(f){b.call(f,d);},this);},loadToDataURL:function(d,f,c,e){if(d.type.indexOf("image/")!==0){c.call(e,"Chosen file is not an image: "+d.name);}else{var b=new FileReader();b.onload=function(g){f.call(e,g.target.result);};b.readAsDataURL(d);}},fromDataUrlToImg:function(d,e,c){var b=document.createElement("img");b.onload=function(){e.call(c,b);};b.src=d;},createThumbnail:function(c,e,d,b){this.fromDataUrlToImg(c,function(g){var h=document.createElement("canvas");var j=g.width-e.width;var i=g.height-e.height;var f;if(j>0&&j>i){f=e.width/g.width;}else{if(i>0&&i>j){f=e.height/g.height;}}if(f){h.width=g.width*f;h.height=g.height*f;}else{h.width=g.width;h.height=g.height;}h.getContext("2d").drawImage(g,0,0,g.width,g.height,0,0,h.width,h.height);d.call(b,h.toDataURL("png"),s(h.width,h.height));});}};})();(function(){LTP.util.global.colors={black:"#000000",white:"#FFFFFF",red:"#FF0000",blue:"#0000FF",green:"#00FF00",yellow:"#FFFF00",orange:"#FF8800",purple:"#CC00FF",gray:"#888888",lightGray:"#BBBBBB",brown:"#773355",isHexString:function(a){if(typeof a!=="string"){return false;}if(a[0]!=="#"||a.length!==7){return false;}if(a.toUpperCase()!==a){return false;}return parseInt(a.substring(1),16)!==NaN;},fromArrayToHex:function(f,b){var a="#";var e=(b&&b.includeAlpha&&f.length===4)?4:3;for(var c=0;c<e;++c){var d=f[c].toString(16);if(d.length<2){d="0"+d;}a+=d;}return a;},fromHexToArray:function(e,c){e=e.substring(1);var b=e.substring(0,2);var a=e.substring(2,4);var d=e.substring(4,6);result=[parseInt(b,16),parseInt(a,16),parseInt(d,16),];if(c&&c.includeAlpha){result.push(255);}return result;},invert:function(b){var c=this.fromHexToArray(b);for(var a=0;a<c.length;++a){c[a]=255-c[a];}return this.fromArrayToHex(c);}};})();(function(){LTP.MessageBus=function e(f){if(!f||!f.length){throw new Error("MessageBus: messages is required");}this._messages=f;this._subscribers={};};LTP.MessageBus.prototype={subscribe:function c(g,h,f){if(!this._messageExists(g)){throw new Error("MessageBus.subscribe: subscribing to a nonexistant message: "+g);}if(typeof h!=="function"){throw new Error("MessageBus.subscribe: must provide a a callback when subscribing");}this._subscribers[g]=this._subscribers[g]||[];this._subscribers[g].push({scope:f,callback:h});},unsubscribe:function b(h,k){if(!this._messageExists(h)){throw new Error("MessageBus.unsubscribe: non existant message: "+h);}var j=this._subscribers[h];if(j){var g=-1;for(var f=0;f<j.length;++f){if(j[f].callback===k){g=f;break;}}if(g>=0){j.splice(g,1);}}},publish:function a(j){if(!this._messageExists(j)){throw new Error("MessageBus.publish: publishing a non existant message: "+j);}var k=this._subscribers[j];if(k&&k.length){var f=LTP.util.toArray(arguments).slice(1);for(var g=0;g<k.length;++g){var h=k[g];h.callback.apply(h.scope||null,f);}}},_messageExists:function d(f){return this._messages.indexOf(f)>=0;},};})();(function(){LTP.PointTransformer=function a(b){this._pageOffsets=b||window;};LTP.PointTransformer.prototype={transform:function(c){var d=1/(this.zoom);var b=this._pageOffsets.pageXOffset*d;var g=this._pageOffsets.pageYOffset*d;var f=c.x*d+b;var e=c.y*d+g;f=Math.ceil(f);e=Math.ceil(e);return p(f,e);}};Object.defineProperty(LTP.PointTransformer.prototype,"zoom",{get:function(){return this._zoom||1;},set:function(b){this._zoom=b;}});})();(function(){LTP.Rectangle=function b(d,f,e,c){this._x=d||0;this._y=f||0;this._width=e||0;this._height=c||0;if(this._x<0||this._y<0||this._width<0||this._height<0){throw new Error("Rectangle: negative values not allowed");}};LTP.Rectangle.prototype={equals:function a(c){if(c){return c===this||(c.x===this._x&&c.y===this._y&&c.width===this._width&&c.height===this._height);}else{return false;}}};Object.defineProperty(LTP.Rectangle.prototype,"x",{get:function(){return this._x;}});Object.defineProperty(LTP.Rectangle.prototype,"y",{get:function(){return this._y;}});Object.defineProperty(LTP.Rectangle.prototype,"width",{get:function(){return this._width;}});Object.defineProperty(LTP.Rectangle.prototype,"height",{get:function(){return this._height;}});Object.defineProperty(LTP.Rectangle.prototype,"hasArea",{get:function(){return this.height*this.width>0;}});})();(function(){LTP.Pair=function c(e,d){this._a=e||0;this._b=d||0;};LTP.Pair.prototype={equals:function b(d){if(d){return(d===this)||(d._a===this._a&&d._b==this._b)||(d.x===this._a&&d.y==this._b)||(d.width==this._a&&d.height==this._b);}return false;},toString:function a(){return"["+this._a+","+this._b+"]";}};Object.defineProperty(LTP.Pair.prototype,"width",{get:function(){return this._a;}});Object.defineProperty(LTP.Pair.prototype,"height",{get:function(){return this._b;}});Object.defineProperty(LTP.Pair.prototype,"x",{get:function(){return this._a;}});Object.defineProperty(LTP.Pair.prototype,"y",{get:function(){return this._b;}});})();(function(){LTP.BoundingBoxBuilder=function b(c){c=c||new LTP.Rectangle();this._minX=c.x;this._maxX=c.x+c.width;this._minY=c.y;this._maxY=c.y+c.height;};LTP.BoundingBoxBuilder.prototype={append:function a(c){if(!c){throw new Error("BoundingBoxBuilder.append: rect argument is required");}this._minX=Math.min(this._minX,c.x);this._minY=Math.min(this._minY,c.y);this._maxX=Math.max(this._maxX,c.x+c.width);this._maxY=Math.max(this._maxY,c.y+c.height);}};Object.defineProperty(LTP.BoundingBoxBuilder.prototype,"boundingBox",{get:function(){return r(this._minX,this._minY,this._maxX-this._minX,this._maxY-this._minY);}});})();(function(){LTP.ColorManager=function a(c,b){this._colors=c||[colors.black,colors.white];this._leftColorIndex=0;this._rightColorIndex=1;this._messageBus=b||LTP.GlobalMessageBus;};LTP.ColorManager.prototype={getColorsAsString:function(){return this._colors.join(",");},setColorsFromString:function(b,c){if(!b){this._colors=c;}else{this._colors=b.split(",");}if(!this._colors||this._colors.length===0||(this._colors.length===1&&!this._colors[0])){this._colors=c;}if(this._leftColorIndex>this._colors.length-1){this._leftColorIndex=0;}if(this._rightColorIndex>this._colors.length-1){if(this._colors.length>1){this._rightColorIndex=1;}else{this._rightColorIndex=0;}}},setLeftColorTo:function(b){if(this._inRange(b)){this._leftColorIndex=b;this._messageBus.publish("leftColorSelected",this.leftColor,this._leftColorIndex);}},setRightColorTo:function(b){if(this._inRange(b)){this._rightColorIndex=b;this._messageBus.publish("rightColorSelected",this.rightColor,this._rightColorIndex);}},addColor:function(b){if(!colors.isHexString(b)){throw new Error("Attempted to add a color that is not in hex format: "+b);}this._colors.push(b);this._messageBus.publish("paletteContentChange");},removeColorAt:function(b){if(this._inRange(b)){this._colors.splice(b,1);this._messageBus.publish("paletteContentChange");}},redefineAt:function(c,b){if(this._inRange(c)){if(this._colors[c]!==b){this._colors[c]=b;this._messageBus.publish("paletteContentChange");}}},moveColor:function(d,c){if(this._inRange(d)&&this._inRange(c)){var b=this._colors.splice(d,1);this._colors.splice(c,0,b[0]);this._messageBus.publish("paletteContentChange");}},_inRange:function(b){return b>=0&&b<this._colors.length;}};Object.defineProperty(LTP.ColorManager.prototype,"colors",{get:function(){return this._colors;},enumerable:true});Object.defineProperty(LTP.ColorManager.prototype,"leftColor",{get:function(){return this._colors[this._leftColorIndex];},enumerable:true});Object.defineProperty(LTP.ColorManager.prototype,"rightColor",{get:function(){return this._colors[this._rightColorIndex];},enumerable:true});})();(function(){LTP.BaseTool=function(a,b){this._causesChange=a;this._cursor=b;};LTP.BaseTool.prototype={perform:function(a){},overlay:function(b,a){b.save();b.fillStyle=colors.purple;b.fillRect(a.x,a.y,1,1);b.restore();}};Object.defineProperty(LTP.BaseTool.prototype,"causesChange",{get:function(){return this._causesChange;},enumerable:true});Object.defineProperty(LTP.BaseTool.prototype,"cursor",{get:function(){return this._cursor;},enumerable:true});})();(function(){var b=true;var a="none";LTP.BrushTool=function(c){if(!c){throw new Error("BrushTool: size must be specified");}this._size=c;LTP.BaseTool.call(this,b,a);};LTP.BrushTool.prototype=new LTP.BaseTool();LTP.BrushTool.prototype.overlay=function(e,c){e.save();var d="rgba(255, 0, 0, .5)";e.globalCompositeOperation="lighter";if(this._size<3){e.fillStyle=d;this._placePoint(e,c);}else{e.strokeStyle=d;e.lineWidth=1;this._placePoint(e,c,{stroke:true});}e.restore();};LTP.BrushTool.prototype.getBoundsAt=function(e){if(e.x<0||e.y<0){return r(0,0,0,0);}var d=Math.max(0,e.x-this._size);var g=Math.max(0,e.y-this._size);var f=e.x>=this._size?this._size:e.x;var c=e.y>=this._size?this._size:e.y;return r(d,g,f,c);};LTP.BrushTool.prototype.perform=function(h){var d=h.context;var c=h.lastPoint;var j=h.currentPoint;d.save();d.fillStyle=h.color;if(c.equals(j)){this._placePoint(d,c);}else{if(c.x>j.x){var k=c;c=j;j=k;}var i=(j.y-c.y)/(j.x-c.x);var f=c.y-i*c.x;var g=false;while(!g){this._placePoint(d,c);var l=this._moveTowards(c,j,i,f);g=l.arrived;c=l.point;}}this._placePoint(d,j);d.restore();};LTP.BrushTool.prototype._placePoint=function(e,c,d){var g=d&&d.stroke?e.strokeRect:e.fillRect;var f=d&&d.stroke?0.5:0;g.call(e,c.x-this._size-f,c.y-this._size-f,this._size+(2*f),this._size+(2*f));};LTP.BrushTool.prototype._moveTowards=function(h,g,f,e){if(f===Infinity||f===-Infinity){if(h.y===g.y){return{arrived:true,point:pr(h.x,h.y)};}else{var j=f===Infinity?1:-1;return{arrived:false,point:pr(h.x,h.y+j)};}}if(h.x===g.x){return{arrived:true,point:pr(h.x,h.y)};}var d,i;if(Math.abs(f)>1){if(g.y>h.y){i=h.y+1;}else{i=h.y-1;}d=(i-e)/f;}else{d=h.x+1;i=d*f+e;}var c=pr(d,i);return{arrived:false,point:c};};Object.defineProperty(LTP.BrushTool.prototype,"size",{get:function(){return this._size;}});})();(function(){var c=false;var b="url(images/cursors/EyeDropper.png), auto";LTP.EyeDropperTool=function a(d){LTP.BaseTool.call(this,c,b);this._messageBus=d||LTP.GlobalMessageBus;};LTP.EyeDropperTool.prototype=new LTP.BaseTool();LTP.EyeDropperTool.prototype.perform=function(g){var d=g.context;var h=g.currentPoint;var f=d.getImageData(h.x,h.y,1,1);this._sampledRgbColor=this._pixelToRgbString(f.data);this._sampledHexColor=this._pixelToHexString(f.data);this._messageBus.publish("colorSampled",this._sampledRgbColor,this._sampledHexColor,g.mouseButton);};LTP.EyeDropperTool.prototype._pixelToRgbString=function(d){return"rgb("+d[0]+","+d[1]+","+d[2]+");";};LTP.EyeDropperTool.prototype._pixelToHexString=function(d){function e(f){if(f.length==1){return"0"+f;}return f;}return"#"+e(d[0].toString(16))+e(d[1].toString(16))+e(d[2].toString(16));};Object.defineProperty(LTP.EyeDropperTool.prototype,"sampledRgbColor",{get:function(){return this._sampledRgbColor;}});Object.defineProperty(LTP.EyeDropperTool.prototype,"sampledHexColor",{get:function(){return this._sampledHexColor;}});})();(function(){var b=false;var a="move";LTP.PanningTool=function(){LTP.BaseTool.call(this,b,a);};LTP.PanningTool.prototype=new LTP.BaseTool();LTP.PanningTool.prototype.perform=function(i){var f=i.containerElement;var c=i.currentPointNonTransformed.y-i.lastPointNonTransformed.y;var d=i.currentPointNonTransformed.x-i.lastPointNonTransformed.x;var g=f.scrollTop-c;var h=f.scrollLeft-d;f.scrollTop=g;f.scrollLeft=h;};LTP.PanningTool.prototype.overlay=function(){};})();(function(){var b=true;var a="url(images/cursors/Fill.png), auto";LTP.FillTool=function(){LTP.BaseTool.call(this,b,a);};LTP.FillTool.prototype=new LTP.BaseTool();LTP.FillTool.prototype._sampleColorAt=function(d,c){var e=d.getImageData(c.x,c.y,1,1);return LTP.util.toArray(e.data);};LTP.FillTool.prototype._areSame=function(d,c){if(d===c){return true;}if(d.length!==c.length){return false;}for(var e=0;e<d.length;++e){if(d[e]!==c[e]){return false;}}return true;};LTP.FillTool.prototype.perform=function(g){if(g.imageCanvas.width!==g.context.canvas.width||g.imageCanvas.height!==g.context.canvas.height){throw new Error("FillTool.perform: source and dest canvases need to be the same size");}var d=g.imageCanvas.getContext("2d");var f=this._sampleColorAt(d,g.currentPoint);var c=colors.fromHexToArray(g.color,{includeAlpha:true});if(!this._areSame(f,c)){this._fill(d,g.context,g.currentPoint,f,c);}};LTP.FillTool.prototype.getBoundsAt=function(c,d){return this._lastBoundingBox||r(0,0,0,0);};LTP.FillTool.prototype._fill=function(o,c,j,v,n){var q=o.getImageData(0,0,o.canvas.width,o.canvas.height);var s=c.getImageData(0,0,c.canvas.width,c.canvas.height);var p=new LTP.BoundingBoxBuilder();function g(w){s.data[w]=n[0];s.data[w+1]=n[1];s.data[w+2]=n[2];s.data[w+3]=n[3];}function k(A){if(s.data[A+3]!==0){return false;}var z=q.data[A];var y=q.data[A+1];var w=q.data[A+2];var x=q.data[A+3];return z===v[0]&&y===v[1]&&w===v[2]&&x===v[3];}var d=[[j.x,j.y]];var f,m,l,u,i,h;var t=c.canvas.width;var e=c.canvas.height;while(d.length){f=d.pop();m=f[0];l=f[1];u=(l*t+m)*4;while(l-->=0&&k(u)){u-=t*4;}u+=t*4;++l;i=false;h=false;while(l++<e-1&&k(u)){g(u);p.append(r(m,l,1,1));if(m>0){if(k(u-4)){if(!i){d.push([m-1,l]);i=true;}}else{if(i){i=false;}}}if(m<t-1){if(k(u+4)){if(!h){d.push([m+1,l]);h=true;}}else{if(h){h=false;}}}u+=t*4;}}c.putImageData(s,0,0);this._lastBoundingBox=p.boundingBox;};})();(function(){LTP.DirectionLockTransformer=function a(b){if(!b){throw new Error("DirectionLockTransformer: direction is required");}this._direction=b;};LTP.DirectionLockTransformer.directions={leftRight:"leftRight",upDown:"upDown"};LTP.DirectionLockTransformer.prototype={transform:function(b,c){if(b.equals(c)){return c;}if(this._direction===LTP.DirectionLockTransformer.directions.leftRight){return p(c.x,b.y);}else{if(this._direction===LTP.DirectionLockTransformer.directions.upDown){return p(b.x,c.y);}}return c;},overlay:function(c,b){c.save();c.fillStyle="blue";if(this._direction===LTP.DirectionLockTransformer.directions.leftRight){c.fillRect(0,b.y,c.canvas.width,1);}else{if(this._direction===LTP.DirectionLockTransformer.directions.upDown){c.fillRect(b.x,0,1,c.canvas.height);}}c.restore();}};Object.defineProperty(LTP.DirectionLockTransformer.prototype,"transformOnHover",{get:function(){return false;},enumerable:true});})();(function(){function b(d,c){return Math.round(d/c)*c;}LTP.BrushSizeLockTransformer=function a(){};LTP.BrushSizeLockTransformer.prototype={transform:function(d,e,c){if(!c){return e;}return p(b(e.x,c),b(e.y,c));}};Object.defineProperty(LTP.BrushSizeLockTransformer.prototype,"transformOnHover",{get:function(){return true;},enumerable:true});Object.defineProperty(LTP.BrushSizeLockTransformer.prototype,"currentPointOnly",{get:function(){return true;},enumerable:true});})();(function(){var a=2000;var d=1999;LTP.Container=function b(g,e,f){if(!g){throw new Error("Container: size is required");}if(!e){throw new Error("Container: containingElement is required");}this._zoom=1;this._imageSize=g;this._containingElement=e;this._layers=[];this._messageBus=f||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",this._onZoomChanged,this);this._messageBus.subscribe("newLayerCreated",this._onNewLayerCreated,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("layerRemoved",this._onLayerRemoved,this);this._messageBus.subscribe("noLayersInProject",this._onNoLayersInProject,this);Ext.fly(this._containingElement.parentNode).on("mousemove",this._onMouseMove,this);this._pointTransformer=new LTP.PointTransformer();this._windowResizeListener=LTP.util.bind(this._onWindowResize,this);window.addEventListener("resize",this._windowResizeListener,false);this._addTransparencyBackdrop();};LTP.Container.prototype={zoomTo:function(e){this._zoom=e;this._pointTransformer.zoom=e;this._containingElement.style.zoom=(Math.round(e*100)).toString()+"%";Ext.Array.each(this._layers,function(f){f.style.MozTransform="scale("+e+")";});this._backdrop.style.MozTransform="scale("+e+")";this._centerLayers();if(this._mouseCoords){this._scrollTo(this._mouseCoords);}},_centerLayers:function(){this._centerLayer(this._backdrop);for(var e=0;e<this._layers.length;++e){this._centerLayer(this._layers[e]);}},_centerLayer:function(e){var f=LTP.util.platformInfo.isFirefox?this._centerLayerFirefox:this._centerLayerNotFirefox;f.call(this,e);},_centerLayerFirefox:function(f){var h=(this._imageSize.width*this._zoom-this._containingElement.clientWidth)/2;var e=(this._imageSize.height*this._zoom-this._containingElement.clientHeight)/2;var g=(this._containingElement.clientWidth-this._imageSize.width)/2;var i=(this._containingElement.clientHeight-this._imageSize.height)/2;if(h>0){g+=h;}if(e>0){i+=e;}f.style.top=Math.round(i)+"px";f.style.left=Math.round(g)+"px";},_centerLayerNotFirefox:function(e){var g=(this._containingElement.offsetHeight/2-e.height/2);var f=(this._containingElement.offsetWidth/2-e.width/2);e.style.top=Math.max(0,Math.round(g))+"px";e.style.left=Math.max(0,Math.round(f))+"px";},_scrollTo:function(e){var g=e.x/this._imageSize.x;var f=e.y/this._imageSize.y;var h=this._containingElement.parentNode;h.scrollLeft=h.scrollWidth*g-h.clientWidth/2;h.scrollTop=h.scrollHeight*f-h.clientHeight/2;},addLayer:function(e){e.style.position="absolute";e.style.cursor="none";this._containingElement.appendChild(e);this._centerLayer(e);this._layers.push(e);},removeLayer:function(f){var e=this._layers.indexOf(f);this._layers.splice(e,1);this._containingElement.removeChild(f);},_addTransparencyBackdrop:function(){var e=document.createElement("div");e.id="transparencyBackdropElement";e.style.position="absolute";e.style.cursor="none";e.style.width=this._imageSize.width+"px";e.style.height=this._imageSize.height+"px";e.width=this._imageSize.width;e.height=this._imageSize.height;this._containingElement.appendChild(e);this._centerLayer(e);this._backdrop=e;},_setScratchForLayer:function(f){var h=false;for(var e=0;e<this._layers.length;++e){if(this._layers[e]===f){h=true;break;}}if(h){var g=parseInt(f.style.zIndex,10);this._scratch.style.zIndex=g+1;}},destroy:function(){this._layers=null;this._messageBus.unsubscribe("zoomChanged",this._onZoomChanged);this._messageBus.unsubscribe("newLayerCreated",this._onNewLayerCreated);this._messageBus.unsubscribe("activeLayerChanged",this._onActiveLayerChanged);this._messageBus.unsubscribe("layerDeleted",this._onLayerRemoved);this._messageBus.unsubscribe("noLayersInProject",this._onNoLayersInProject);this._messageBus=null;Ext.fly(this._containingElement.parentNode).un("mousemove",this._onMouseMove,this);},_onZoomChanged:function(e){this.zoomTo(e);},_onNewLayerCreated:function(e){this.addLayer(e);this._backdrop.style.display="";},_onLayerRemoved:function(e){this.removeLayer(e);},_onNoLayersInProject:function(){this._backdrop.style.display="none";},_onActiveLayerChanged:function(e){this._setScratchForLayer(e);},_onMouseMove:function(h){var g=Ext.fly(h.target);var f=p(h.getX()-g.getLeft(),h.getY()-g.getTop());this._mouseCoords=this._pointTransformer.transform(f);},_onWindowResize:function c(){this._centerLayers();}};Object.defineProperty(LTP.Container.prototype,"overlay",{set:function(e){this.addLayer(e);e.style.zIndex=a;}});Object.defineProperty(LTP.Container.prototype,"grid",{set:function(e){this.addLayer(e);e.style.zIndex=d;}});Object.defineProperty(LTP.Container.prototype,"scratch",{set:function(e){this._scratch=e;this.addLayer(e);}});})();(function(){LTP.Painter=function(s,n,m,q,u,o,t){if(!s){throw new Error("LTP.Painter: size is required");}if(!n){throw new Error("LTP.Painter: pointTransformer is required");}this._messageBus=m||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",this._onZoomChanged,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("leftColorSelected",this._onLeftColorSelected,this);this._messageBus.subscribe("rightColorSelected",this._onRightColorSelected,this);this._messageBus.subscribe("cursorDisplayChangeRequest",this._onCursorDisplayChangeRequest,this);this._overrideToolState={down:false,active:false};this._leftToolState={down:false};this._rightToolState={down:false};this.leftTool=q||new LTP.BrushTool(5);this.rightTool=u||new LTP.BrushTool(5);this.leftColor=o||colors.black;this.rightColor=t||colors.white;this._lastToolState=this._leftToolState;this._size=s;this._pointTransformer=n;this._overlay=LTP.util.canvas(this._size,{position:"absolute",top:0,left:0});this._scratch=LTP.util.canvas(this._size,{position:"absolute",top:0,left:0});this._clear(this._overlay);this._clear(this._scratch);this._hook(this._overlay);this._undoRedoStates=[];this._currentUndoRedoStateIndex=-1;this._entireBoundingBox=r(0,0,this._size.width,this._size.height);this._zoom=1;};LTP.Painter.prototype={pushOverrideTool:function(m){this._overrideToolState.tool=m;this._overrideToolState.active=true;this._lastToolState=this._overrideToolState;this._setCursor(m.cursor);this._doOverlay();},popOverrideTool:function(){delete this._overrideToolState.tool;this._overrideToolState.active=false;this._lastToolState=this._leftToolState;this._setCursor("none");this._doOverlay();},destroy:function(){this._messageBus.unsubscribe("zoomChanged",this._onZoomChanged);this._messageBus.unsubscribe("activeLayerChanged",this._onActiveLayerChanged);this._messageBus.unsubscribe("leftColorSelected",this._onLeftColorSelected);this._messageBus.unsubscribe("rightColorSelected",this._onRightColorSelected);this._messageBus.unsubscribe("cursorDisplayChangeRequest",this._onCursorDisplayChangeRequest);this._unhook(this._overlay);},_hook:function k(m){this._setEventListeners(Ext.get(m),"on");},_unhook:function f(m){this._setEventListeners(Ext.get(m),"un");},_setEventListeners:function b(m,n){m[n]("mousedown",this._onMouseDown,this);m[n]("mousemove",this._onMouseMove,this);m[n]("mouseout",this._onMouseOut,this);m[n]("mouseup",this._onMouseUp,this);m[n]("contextmenu",this._onContextMenu,this);},_setCursor:function(m){this._overlay.style.cursor=m;},_getToolStateForButton:function(m){if(this._overrideToolState.active){return this._overrideToolState;}if(m===0){return this._leftToolState;}return this._rightToolState;},_doOverlay:function(m){var m=m||this._lastOverlayPoint;if(m){this._clear(this._overlay);var n=this._overlay.getContext("2d");this._lastToolState.tool.overlay(n,m);if(this._adhocTransformer&&this._adhocTransformer.overlay){this._adhocTransformer.overlay(n,m);}this._lastOverlayPoint=m;}this._messageBus.publish("canvasMouseCoordinatesChanged",m);},_getLeftFirefox:function(m){var n=m.getLeft();var o=this._size.width*this._zoom-this._size.width;o=o/2;return n-o;},_getTopFirefox:function(m){var o=m.getTop();var n=this._size.height*this._zoom-this._size.height;n=n/2;return o-n;},_getCurrentPoint:function(s){var n=Ext.fly(s.target);var q,o;if(LTP.util.platformInfo.isFirefox){q=this._getLeftFirefox(n);o=this._getTopFirefox(n);}else{q=n.getLeft()*this._zoom;o=n.getTop()*this._zoom;}var m=s.getX()-q;var u=s.getY()-o;return p(m,u);},_onMouseDown:function d(t){t.preventDefault();this._clear(this._overlay);var m=this._getToolStateForButton(t.button);var q=this._getCurrentPoint(t);var u=this._pointTransformer.transform(q);if(this._adhocTransformer){var s=m&&m.tool.size;u=this._adhocTransformer.transform(u,u,s);}if(m){if(m.tool.causesChange){this._pruneUndoRedoStates();}m.down=true;var o=m.tool.causesChange?this._scratch:this._activeCanvas;var n=t.button===0?this.leftColor:this.rightColor;m.tool.perform({canvas:o,imageCanvas:this._activeCanvas,context:o.getContext("2d"),lastPoint:u,currentPoint:u,lastPointNonTransformed:q,currentPointNonTransformed:q,containerElement:this._activeCanvas.parentNode.parentNode,mouseButton:t.button,color:n});m.lastPoint=u;m.lastPointNonTransformed=q;if(m.tool.causesChange){this._currentBoundingBox=new LTP.BoundingBoxBuilder(m.tool.getBoundsAt(u));}}if(m){this._lastToolState=m;}this._doOverlay(u);},_onMouseMove:function j(s){s.preventDefault();var q=this._getToolStateForButton(s.button);var u=this._getCurrentPoint(s);var w=this._pointTransformer.transform(u);var t=q.lastPoint||w;var v=q.lastPointNonTransformed||u;if(q&&q.down){if(this._adhocTransformer){w=this._adhocTransformer.transform(t,w,q.tool.size);if(this._adhocTransformer.currentPointOnly){t=w;v=u;}}var m=q.tool.causesChange?this._scratch:this._activeCanvas;var n=s.button===0?this.leftColor:this.rightColor;q.tool.perform({canvas:m,imageCanvas:this._activeCanvas,context:m.getContext("2d"),lastPoint:t,currentPoint:w,lastPointNonTransformed:v,currentPointNonTransformed:u,containerElement:this._activeCanvas.parentNode.parentNode,mouseButton:s.button,color:n});q.lastPoint=w;q.lastPointNonTransformed=u;if(q.tool.causesChange){this._currentBoundingBox.append(q.tool.getBoundsAt(w));this._currentBoundingBox.append(q.tool.getBoundsAt(t));}}else{if(this._adhocTransformer&&this._adhocTransformer.transformOnHover){var o=this._lastToolState&&this._lastToolState.tool.size;w=this._adhocTransformer.transform(t,w,o);}}this._doOverlay(w);},_onMouseUp:function a(o){o.preventDefault();var m=this._getToolStateForButton(o.button);var n=this._getCurrentPoint(o);var q=this._pointTransformer.transform(n);if(m&&m.down){m.down=false;m.lastPoint=null;if(m.tool.causesChange){this._finishUndoRedo(m.tool,q);this._messageBus.publish("canvasContentChange",this._activeCanvas);}}this._doOverlay(q);},_onMouseOut:function(s){this._clear(this._overlay);var q=null;var o=[this._leftToolState,this._rightToolState,this._overrideToolState];for(var n=0;n<o.length;++n){var m=o[n];if(m.down){q=m;}m.down=false;m.lastPoint=null;}if(q){var t=this._pointTransformer.transform(p(s.offsetX,s.offsetY));if(q.tool.causesChange){this._finishUndoRedo(this._lastToolState.tool,t);this._messageBus.publish("canvasContentChange",this._activeCanvas);}}this._messageBus.publish("canvasMouseCoordinatesChanged",null);},_pruneUndoRedoStates:function(){this._undoRedoStates=this._undoRedoStates.slice(0,this._currentUndoRedoStateIndex+1);this._currentUndoredoStateIndex=this._undoRedoStates.length-1;},_finishUndoRedo:function(o,m){this._currentBoundingBox.append(o.getBoundsAt(m));var n=this._currentBoundingBox.boundingBox;if(n.hasArea){this._undoRedoStates.push({boundingBox:n,undoClip:this._createClip(this._activeCanvas,n),redoClip:this._createClip(this._scratch,n),canvas:this._activeCanvas});this._currentUndoRedoStateIndex=this._undoRedoStates.length-1;}this._applyClip(this._activeCanvas,this._scratch,this._entireBoundingBox);this._clear(this._scratch);},_onContextMenu:function l(m){m.preventDefault();m.stopPropagation();return false;},_clear:function(m){m.getContext("2d").clearRect(0,0,m.width,m.height);},_createClip:function(n,m){var o=LTP.util.canvas(m);o.getContext("2d").drawImage(n,m.x,m.y,m.width,m.height,0,0,m.width,m.height);return o;},_applyClip:function(m,q,o,n){var s=m.getContext("2d");if(typeof q.getContext==="function"){if(n){s.clearRect(o.x,o.y,o.width,o.height);}s.drawImage(q,o.x,o.y,o.width,o.height);}else{s.putImageData(q,o.x,o.y);}},undo:function(){if(this._currentUndoRedoStateIndex>-1){var m=this._undoRedoStates[this._currentUndoRedoStateIndex];this._applyClip(m.canvas,m.undoClip,m.boundingBox,true);this._messageBus.publish("canvasContentChange",this._activeCanvas);--this._currentUndoRedoStateIndex;}},redo:function(){if(this._currentUndoRedoStateIndex<this._undoRedoStates.length-1){this._currentUndoRedoStateIndex+=1;var m=this._undoRedoStates[this._currentUndoRedoStateIndex];this._applyClip(m.canvas,m.redoClip,m.boundingBox,false);this._messageBus.publish("canvasContentChange",this._activeCanvas);}},_onZoomChanged:function i(m){this._zoom=m;this._pointTransformer.zoom=m;},_onActiveLayerChanged:function g(m){this.activeCanvas=m;},_onLeftColorSelected:function c(m){this.leftColor=m;},_onRightColorSelected:function e(m){this.rightColor=m;},_onCursorDisplayChangeRequest:function h(m){this._overlay.style.cursor=m;}};Object.defineProperty(LTP.Painter.prototype,"overlay",{get:function(){return this._overlay;},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"scratch",{get:function(){return this._scratch;},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"activeCanvas",{set:function(m){this._activeCanvas=m;}});Object.defineProperty(LTP.Painter.prototype,"leftTool",{get:function(){if(this._overrideToolState.active){return this._overrideToolState.tool;}else{return this._leftToolState.tool;}},set:function(m){this._leftToolState.tool=m;this._lastToolState=this._leftToolState;this._messageBus.publish("leftToolChanged",m);this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"rightTool",{get:function(){if(this._overrideToolState.active){return this._overrideToolState.tool;}else{return this._rightToolState.tool;}},set:function(m){this._rightToolState.tool=m;this._lastToolState=this._rightToolState;this._messageBus.publish("rightToolChanged",m);this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"leftColor",{get:function(){return this._leftColor;},set:function(m){this._leftColor=m;this._lastToolState=this._leftToolState;this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"rightColor",{get:function(){return this._rightColor;},set:function(m){this._rightColor=m;this._lastToolState=this._rightToolState;this._doOverlay();},enumerable:true});Object.defineProperty(LTP.Painter.prototype,"adhocTransformer",{set:function(m){this._adhocTransformer=m;this._doOverlay();},});})();(function(){LTP.LayerManager=function d(f,e){if(!f){throw new Error("LayerManager: project is required");}this._size=f.size;this._messageBus=e||LTP.GlobalMessageBus;if(f.layers){this._layers=this._hydrateLayersFromProject(f);}else{this._layers=[this._createLayer(this.InitialLayerName,f.size)];}this._activeLayerIndex=this._layers.length-1;this._layerCounter=1;};LTP.LayerManager.prototype={InitialLayerName:"Initial Layer",_hydrateLayersFromProject:function a(j){var h=[];for(var f=0;f<j.layers.length;++f){var e=j.layers[f];var g=this._createLayer(e.layerName,j.size,e.data,{layerId:e.layerId,index:e.index});h.push(g);}h.sort(function(k,i){return k.index-i.index;});return h;},dumpLayers:function(){for(var f=0;f<this._layers.length;++f){var e=this._layers[f];window.open(e.toDataURL("png"),e.layerName+f);}},setActiveLayer:function(e){this._activeLayerIndex=e;this._messageBus.publish("activeLayerChanged",this.activeLayer);return this.activeLayer;},setActiveLayerByLayer:function b(f){var e=this._layers.indexOf(f);if(e>-1){this.setActiveLayer(e);}},addNewLayer:function(e,f){this._layers.push(this._createLayer(e||"new layer "+this._layerCounter++,f));this._activeLayerIndex=this._layers.length-1;this._updateZIndices();this._messageBus.publish("newLayerCreated",this.activeLayer);this.setActiveLayer(this._activeLayerIndex);return this.activeLayer;},moveLayerAhead:function(f,h){var e=this._layers.indexOf(f);this._layers.splice(e,1);var g=this._layers.indexOf(h);this._layers.splice(g+1,0,f);this._updateZIndices();},moveLayerBehind:function(f,h){var e=this._layers.indexOf(f);this._layers.splice(e,1);var g=this._layers.indexOf(h);this._layers.splice(g,0,f);this._updateZIndices();},deleteLayer:function(e){if(e<0||e>=this.count){throw new Error("LayerManger.deleteLayer: index out of range: "+e);}var f=this._layers.splice(e,1)[0];if(this._activeLayerIndex>=this.count){this._activeLayerIndex=this.count-1;}this.setActiveLayer(this._activeLayerIndex);this._updateZIndices();this._messageBus.publish("layerRemoved",f);if(this._layers.length===0){this._messageBus.publish("noLayersInProject");}return true;},deleteLayerByLayer:function(f){var e=this._layers.indexOf(f);if(e>=0){return this.deleteLayer(e);}},mergeLayer:function(f){if(f<=0){return false;}var e=this._layers[f];var g=this._layers[f-1];if(e.isVisible){g.getContext("2d").drawImage(e,0,0);}this.deleteLayer(f);this._messageBus.publish("canvasContentChange",g);return true;},mergeLayerByLayer:function(f){var e=this._layers.indexOf(f);if(e>=1){return this.mergeLayer(e);}},composite:function(m){m=m||this._size;var j=LTP.util.scaleSize(this._size,m);var f=this._createLayer("composite",j);var k=f.getContext("2d");for(var h=0,e=this.count;h<e;++h){var g=this._layers[h];if(g.isVisible){k.drawImage(g,0,0,g.width,g.height,0,0,f.width,f.height);}}return f;},flatten:function(){if(this.count===0){return;}while(this.count>1){this.mergeLayer(this.count-1);}return this.activeLayer;},destroy:function(){this._layers=null;},_createLayer:function(f,h,i,g){h=h||this._size;var e=LTP.util.canvas(h,{position:"absolute",top:0,left:0});c(e);e.layerName=f;e.layerManager=this;if(g){for(var j in g){if(g.hasOwnProperty(j)){e[j]=g[j];}}}if(i){e.data=i;}return e;},_drawImageInto:function(g,f){var e=f.getContext("2d");e.save();e.drawImage(g,0,0);e.restore();},_updateZIndices:function(){for(var e=0;e<this._layers.length;++e){this._layers[e].style.zIndex=(e+1)*3;}}};Object.defineProperty(LTP.LayerManager.prototype,"dataLoaded",{get:function(){if(!this._layers||this._layers.length===0){return true;}for(var e=0;e<this._layers.length;++e){if(!this._layers[e].dataLoaded){return false;}}return true;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"size",{get:function(){return this._size;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"count",{get:function(){return this._layers.length;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"layers",{get:function(){return this._layers;},enumerable:true});Object.defineProperty(LTP.LayerManager.prototype,"activeLayer",{get:function(){return this._layers[this._activeLayerIndex];},enumerable:true});function c(e){Object.defineProperty(e,"layerName",{get:function(){return this._layerName;},set:function(f){this._layerName=f;},enumerable:true});Object.defineProperty(e,"isVisible",{get:function(){return this.style.display==="";},set:function(f){this.style.display=f?"":"none";},enumerable:true});Object.defineProperty(e,"index",{get:function(){return parseInt(this.style.zIndex,10);},set:function(f){this.style.zIndex=f;},enumerable:true});Object.defineProperty(e,"data",{get:function(){return this.toDataURL("png");},set:function(h){var g=this;var f=document.createElement("img");f.onload=function(){g.getContext("2d").drawImage(f,0,0);g.dataLoaded=true;g.layerManager._messageBus.publish("layerLoad",g);};f.src=h;},enumerable:true});Object.defineProperty(e,"thumbnailData",{get:function(){var g=LTP.util.scaleSize(s(this.width,this.height),s(50,50));var f=LTP.util.canvas(g);f.getContext("2d").drawImage(this,0,0,this.width,this.height,0,0,g.width,g.height);return f.toDataURL();},set:function(f){},enumerable:true});Object.defineProperty(e,"thumbnailHeight",{get:function(){var f=LTP.util.scaleSize(s(this.width,this.height),s(50,50));return f.height;},set:function(f){},enumerable:true});Object.defineProperty(e,"thumbnailWidth",{get:function(){var f=LTP.util.scaleSize(s(this.width,this.height),s(50,50));return f.width;},set:function(f){},enumerable:true});}})();(function(){LTP.Grid=function a(b,d,e,c){if(!b){throw new Error("Grid: canvasSize is required");}this._canvasSize=b;this._color=d||colors.blue;this._cellSize=e||0;this._messageBus=c||LTP.GlobalMessageBus;this._canvas=LTP.util.canvas(b);this._paintGrid(this._canvas,this._cellSize,this._color);};LTP.Grid.prototype={destroy:function(){this._canvas=null;this._messageBus=null;},_paintGrid:function(d,g,c){var e=d.getContext("2d");e.clearRect(0,0,d.width,d.height);if(g<=0){return;}e.save();e.strokeStyle=c;e.beginPath();for(var b=0.5;b<d.width;b+=g){e.moveTo(b,0);e.lineTo(b,d.height);}for(var f=0.5;f<d.height;f+=g){e.moveTo(0,f);e.lineTo(d.width,f);}e.strokeRect(0,0,d.width,d.height);e.closePath();e.stroke();e.restore();this._messageBus.publish("gridCellSizeChanged",g);}};Object.defineProperty(LTP.Grid.prototype,"color",{get:function(){return this._color;}});Object.defineProperty(LTP.Grid.prototype,"canvasSize",{get:function(){return this._canvasSize;}});Object.defineProperty(LTP.Grid.prototype,"cellSize",{get:function(){return this._cellSize;},set:function(b){this._cellSize=b;this._paintGrid(this._canvas,b,this._color);}});Object.defineProperty(LTP.Grid.prototype,"canvas",{get:function(){return this._canvas;}});Object.defineProperty(LTP.Grid.prototype,"visible",{get:function(){return this._canvas.style.display==="";},set:function(b){if(b){this._canvas.style.display="";}else{this._canvas.style.display="none";}}});})();(function(){var c={"16":"shift","17":"control","18":"alt","32":"space","91":"command","27":"esc"};var b={"!":1,"@":2,"#":3,"$":4,"%":5,"^":6,"&":7,"*":8,"(":9,")":0};LTP.KeyListener=function a(d){var e=this;if(!d){throw new Error("KeyListener: must be constructed with a config object");}this._scope=d.scope||this;this._hook=d.hook||window;this._callbacks=d.callbacks||{};this._keyPressListener=LTP.util.bind(this._onKeyPress,this);this._hook.addEventListener("keypress",this._keyPressListener,false);this._keyDownListener=LTP.util.bind(this._onKeyDown,this);this._hook.addEventListener("keydown",this._keyDownListener,false);this._keyUpListener=LTP.util.bind(this._onKeyUp,this);this._hook.addEventListener("keyup",this._keyUpListener,false);this._downKeys={};};LTP.KeyListener.prototype={_getCharacter:function(d){return c[d]||String.fromCharCode(d).toLowerCase();},_onKeyPress:function(f){if(f.target instanceof HTMLInputElement){return;}var d=this._getCharacter(f.keyCode||f.charCode);d=d.toLowerCase();if(d==="space"){f.preventDefault();}if(typeof this._callbacks[d]==="function"){this._callbacks[d].call(this._scope,f.shiftKey);}else{if(b[d]&&typeof this._callbacks[b[d].toString()]==="function"){this._callbacks[b[d].toString()].call(this._scope,true);}}return d!=="space";},_onKeyDown:function(g){if(g.target instanceof HTMLInputElement){return;}var d=this._getCharacter(g.keyCode);if(d==="space"){g.preventDefault();}if(!this._downKeys[d]){var f=d+"down";if(typeof this._callbacks[f]==="function"){this._callbacks[f].call(this._scope,g.shiftKey);}this._downKeys[d]=true;}return d!=="space";},_onKeyUp:function(g){if(g.target instanceof HTMLInputElement){return;}var d=this._getCharacter(g.keyCode);var f=d+"up";if(d==="space"){g.preventDefault();}if(typeof this._callbacks[f]==="function"){this._callbacks[f].call(this._scope,g.shiftKey);}this._downKeys[d]=false;return d!=="space";},destroy:function(){this._hook.removeEventListener("keypress",this._keyPressListener,false);this._hook.removeEventListener("keydown",this._keyDownListener,false);this._hook.removeEventListener("keyup",this._keyUpListener,false);}};})();(function(){LTP.version="0.1.3 alpha";LTP.s=function(a,b){return new LTP.Pair(a,b);};LTP.sr=function(a,b){return new LTP.Pair(Math.round(a),Math.round(b));};LTP.r=function(){if(arguments.length===4){return new LTP.Rectangle(arguments[0],arguments[1],arguments[2],arguments[3]);}else{var a=arguments[0];return new LTP.Rectangle(a.x,a.y,arguments[1],arguments[2]);}};LTP.util.global.s=LTP.p=LTP.util.global.p=LTP.s;LTP.util.global.sr=LTP.pr=LTP.util.global.pr=LTP.sr;LTP.util.global.r=LTP.r;LTP.GlobalMessages=["colorSampled","zoomChanged","canvasMouseCoordinatesChanged","gridCellSizeChanged","leftToolChanged","rightToolChanged","leftColorSelected","rightColorSelected","leftSizeSelected","rightSizeSelected","newLayerCreated","activeLayerChanged","lockChanged","cursorDisplayChangeRequest","flairMessage","canvasContentChange","paletteContentChange","layerLoad","layerRemoved","noLayersInProject"];LTP.GlobalMessageBus=new LTP.MessageBus(LTP.GlobalMessages);})();(function(){Ext.define("LTP.FlairMessage",{extend:"Ext.container.Container",alias:"widget.ltp.flairmessage",width:200,items:{xtype:"label",text:"Let's pixel!"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("flairMessage",function(b){if(b){this.el.highlight(colors.orange,{duration:2000});this.down("label").setText(b);Ext.defer(function(){this._resetMessage();},2000,this);}else{this._resetMessage();}},this);},_resetMessage:function(){this.down("label").setText("Let's pixel!");}});})();(function(){Ext.define("LTP.CurrentCoordinates",{extend:"Ext.container.Container",alias:"widget.ltp.currentcoordinates",width:100,items:{xtype:"label",text:"x: out y: out"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("canvasMouseCoordinatesChanged",function(b){if(b){this.down("label").setText("x: "+b.x+", y: "+b.y);}else{this.down("label").setText("x: out, y: out");}},this);}});})();(function(){Ext.define("LTP.CurrentZoom",{extend:"Ext.container.Container",alias:"widget.ltp.currentzoom",width:100,items:{xtype:"label",text:"zoom: 100%",},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("zoomChanged",function(b){this.down("label").setText("zoom: "+(b*100).toString()+"%");},this);}});})();(function(){Ext.define("LTP.CurrentColor",{extend:"Ext.container.Container",alias:"widget.ltp.currentcolor",width:40,height:16,style:{margin:"2px",border:"1px solid black"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe(a.tool+"ColorSelected",function(b){if(b){this.el.setStyle("backgroundColor",b);}},this);}});})();(function(){Ext.define("LTP.CurrentLock",{extend:"Ext.container.Container",alias:"widget.ltp.currentlock",width:100,items:{xtype:"label",text:"lock: none"},constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("lockChanged",function(b){if(b){this.down("label").setText("lock: "+b);}else{this.down("label").setText("lock: none");}},this);}});})();(function(){Ext.define("LTP.StatusBar",{extend:"Ext.container.Container",layout:"hbox",alias:"widget.ltp.statusbar",items:[{xtype:"ltp.flairmessage"},{xtype:"ltp.currentcolor",tool:"left"},{xtype:"ltp.currentcolor",tool:"right"},{xtype:"ltp.currentzoom",},{xtype:"ltp.currentcoordinates"},{xtype:"ltp.currentlock"},{xtype:"container",html:'<b>LoveToPixel: alpha </b><a href="mailto:matt.e.greer@gmail.com?subject=LTP">matt.e.greer@gmail.com</a>, <a href="https://github.com/city41/LoveToPixel" target="_blank">github</a>, <a href="https://github.com/city41/LoveToPixel/blob/master/README.md" target="_blank">README</a>'}]});})();(function(){Ext.define("LTP.ColorSwatch",{extend:"Ext.container.Container",alias:"widget.ltp.colorswatch",width:20,height:20,margin:1,constructor:function(a){this.callParent(arguments);this.addEvents("click","dblclick");this.style={backgroundColor:a.color,border:"1px solid black",color:colors.invert(a.color)};this.html=a.label;var b=this;this.on("render",function(){b.el.dom.addEventListener("mousedown",function(c){b._mouseIsDown=true;setTimeout(function(){if(b._mouseIsDown){b.fireEvent("longclick",c);b._mouseIsDown=false;}},200);});b.el.dom.addEventListener("mouseup",function(c){if(b._mouseIsDown){b.fireEvent("click",c);}b._mouseIsDown=false;});b.el.dom.addEventListener("contextmenu",function(c){c.preventDefault();c.stopPropagation();return false;});});},setIsCurrentLeft:function(b){var a=b?"4px solid black":"1px solid black";this.el.setStyle("borderLeft",a);this.el.setStyle("borderBottom",a);},setIsCurrentRight:function(b){var a=b?"4px solid black":"1px solid black";this.el.setStyle("borderRight",a);this.el.setStyle("borderTop",a);}});})();(function(){Ext.define("LTP.SizeSwatch",{extend:"Ext.container.Container",alias:"widget.ltp.sizeswatch",width:20,height:20,constructor:function(a){this.callParent(arguments);this.addEvents("click");this.style={backgroundColor:colors.black,border:(10-this.size)+"px solid white"};var b=this;this.on("render",function(){b.el.dom.addEventListener("mousedown",function(d){var c=d.button===0?"left":"right";LTP.GlobalMessageBus.publish(c+"SizeSelected",b.size);b.fireEvent("click");});b.el.dom.addEventListener("contextmenu",function(c){c.preventDefault();c.stopPropagation();return false;});});}});})();(function(){Ext.define("LTP.Toolbar",{extend:"Ext.container.Container",alias:"widget.ltp.toolbar",layout:"column",height:25,defaults:{xtype:"ltp.swatch",},constructor:function(a){this.callParent(arguments);},initComponent:function(){var a=this.colors||[];var b=[];for(var c=0;c<a.length;++c){b.push({color:a[c]});}this.items=b;this.callParent(arguments);}});})();(function(){Ext.define("LTP.ProjectList",{extend:"Ext.grid.Panel",alias:"widget.ltp.projectlist",layout:"fit",multiSelect:false,selType:"rowmodel",sortableColumns:false,border:false,viewConfig:{emptyText:"<div class='emptyGridText'>You have no saved projects. Start a new project above, then when you save it with 's' it will show up here</div>",deferEmptyText:false},initComponent:function(){this.columns=[{header:"Thumbnail",xtype:"templatecolumn",tpl:'<div style="height:{thumbnailHeight}px; width:{thumbnailWidth}px"><img class="thumbnail" src="{thumbnailData}" /></div>',flex:1,dataIndex:"thumbnailData",menuDisabled:true},{header:"Name",dataIndex:"name",menuDisabled:true},{header:"Last Saved",xtype:"datecolumn",dataIndex:"lastSaved",menuDisabled:true},{xtype:"actioncolumn",header:"Delete",width:50,menuDisabled:true,items:[{icon:"/images/delete.png",iconCls:"x-grid-center-icon",handler:function(b,c,a){this.up("panel").deleteAt(c);}}]}],this.store=Ext.create("Ext.data.Store",{model:"LTP.ProjectModel",data:this.projects,sorters:[{property:"lastSaved",direction:"DESC"}]});this.callParent(arguments);},getSelectedProject:function(){var a=this.getSelectionModel().getSelection();return a&&a.length&&a[0]&&a[0].data;},deleteAt:function(a){Ext.MessageBox.confirm("Delete?","Really delete this project?",function(d){if(d==="yes"){var b=this.store.getAt(a);if(b){var c=b.layers();c.each(function(e){e.destroy();});c.sync();this.store.remove(b);this.store.sync();}}},this);}});})();(function(){Ext.define("LTP.BrowserWarningPanel",{extend:"Ext.panel.Panel",alias:"widget.ltp.browserwarningpanel",border:false,iconCls:"warningIcon",style:{borderBottom:"4px solid black"},constructor:function(){this.callParent(arguments);},initComponent:function(){var b=LTP.compatibilityInfo();var a=[];if(!b.success){a.push({xtype:"container",margin:0,html:'<img src="images/browserWarning.png" alt="browser warning" />',height:63,style:{borderBottom:"4px solid black",backgroundColor:"orange"}},{xtype:"container",border:false,margin:15,html:"So far only Chrome (on OSX) or Firefox 8 (on all platforms) are fully supported. Your browser is not supported because: <b>"+b.conclusion+"</b>"});}this.items=a;this.callParent(arguments);this.setVisible(!b.success);}});})();(function(){Ext.define("LTP.ProjectChooserHeader",{extend:"Ext.panel.Panel",alias:"widget.ltp.projectchooserheader",layout:"anchor",border:false,defaults:{border:false},items:[{html:"header goes here"},{xtype:"ltp.browserwarningpanel"}]});})();(function(){var c="__ltp_projectchooser_size__";var a="love to pixel is a web based pixel editor. That's a fancy name for a paint program geared towards those who do \"old school\" pixel art (think 16 bit video games). <a href='https://github.com/city41/LoveToPixel/blob/master/help/QuickHelp.md' target='_blank' id='launchHelpLink'>Read the quick help</a> to get started";function b(e){if(!e){return e;}var g=e.split("x");if(!g||g.length!==2){return;}var f=parseInt(g[0],10);var d=parseInt(g[1],10);if(isNaN(f)||f<=0||isNaN(d)||d<=0){return;}return s(f,d);}Ext.define("LTP.ProjectChooser",{extend:"Ext.container.Container",alias:"widget.ltp.projectchooser",layout:"fit",border:false,width:"100%",height:"100%",itemId:"projectChooser",baseCls:"projectChooserContainer",defaults:{border:false},initComponent:function(){Ext.EventManager.onWindowResize(this._onWindowResize,this);this.items={xtype:"panel",width:556,itemId:"chooserPanel",layout:{type:"vbox",align:"stretch"},baseCls:"projectChooser",defaults:{autoScroll:false,border:false},items:[{xtype:"container",margin:0,html:'<img src="images/mainLogo.png" alt="main logo" />',height:107,style:{borderBottom:"4px solid black"}},{xtype:"container",items:{xtype:"container",baseCls:"introSection",margin:15,html:a},style:{borderBottom:"4px solid black",backgroundColor:"white"}},{xtype:"ltp.browserwarningpanel"},{xtype:"container",margin:0,html:'<img src="images/newProject.png" alt="new project header" />',height:63,style:{borderBottom:"4px solid black",backgroundColor:"#9E0000"}},{xtype:"panel",layout:"hbox",defaults:{margin:5},style:{borderBottom:"4px solid black",},items:[{xtype:"textfield",fieldLabel:"Name",labelWidth:40,name:"name",itemId:"nameField",enableKeyEvents:true,listeners:{keydown:function(g,f){if(f.keyCode===Ext.EventObject.ENTER){var d=this.up("#projectChooser");d._startNewProject();}}}},{xtype:"textfield",fieldLabel:"Size",labelWidth:40,value:this._getInitialSizeValue(),name:"size",itemId:"sizeField",invalidText:"needs to be in the form '100x100'",enableKeyEvents:true,listeners:{keydown:function(g,f){if(f.keyCode===Ext.EventObject.ENTER){var d=this.up("#projectChooser");d._startNewProject();}}},validate:function(){var d=!!b(this.value);if(!d){this.markInvalid("needs to be in the form '100x100'");}else{this.clearInvalid();}return d;}},{xtype:"button",text:"Start",handler:function(){var d=this.up("#projectChooser");d._startNewProject();}}]},{xtype:"container",margin:0,html:'<img src="images/savedProjects.png" alt="saved projects header" />',height:63,style:{borderBottom:"4px solid black",backgroundColor:"#9E0000"}},{xtype:"ltp.projectlist",itemId:"projectList",projects:this.projects,flex:1,autoScroll:true,listeners:{itemdblclick:function(e,d,f){this._startExistingProject(d.data);},scope:this}},{xtype:"container",margin:0,items:{xtype:"container",margin:10,baseCls:"doubleClickLine",html:"double click a project to edit it",},style:{backgroundColor:"white"}},{xtype:"container",margin:0,style:{textAlign:"right",backgroundColor:"black",color:"white",fontSize:".9em",fontStyle:"italic",padding:"2px"},html:Ext.String.format('version {0}, <a href="http://github.com/city41/LoveToPixel" target="_blank">github</a>',LTP.version)}]};this.callParent(arguments);this.on("afterrender",this._centerItems,this);},_getInitialSizeValue:function(){return localStorage[c]||"600x400";},_getSizeFromSizeField:function(){var f=this.down("#sizeField");var d=f.getValue();var e=b(d);if(e){localStorage[c]=d;}return e;},_getNameFromNameField:function(){var d=this.down("#nameField").getValue();return d||"Untitled Project";},_setSizeAndImageDataFromFile:function(d,e,f){LTP.ImageLoader.load(d,function(g){e.size=s(g.width,g.height);e.layers[0].data=g.src;f();});},_onWindowResize:function(e,d){this.setSize(e,d);this._centerItems();},_centerItems:function(){var e=this.getWidth();var d=this.down("#chooserPanel");var f=(e-d.getWidth())/2;d.el.setStyle("margin-left",f+"px");d.el.setStyle("margin-right",f+"px");},_startNewProject:function(){var d=this._getSizeFromSizeField();if(!d){return;}var e={name:this._getNameFromNameField(),layers:[{id:1,layerName:"Initial Layer",isVisible:true,index:3,data:null}],isDirty:true,size:d};this._go(e);},_startExistingProject:function(d){this._go(d);},_go:function(d){this.fireEvent("projectChosen",d);this.destroy();}});})();(function(){Ext.define("LTP.LayerPanel",{extend:"Ext.panel.Panel",layout:"fit",itemId:"layerPanel",border:false,constructor:function(a){this.callParent(arguments);this._messageBus=a.messageBus||LTP.GlobalMessageBus;this._messageBus.subscribe("canvasContentChange",this._onCanvasContentChange,this);this._messageBus.subscribe("layerLoad",this._onCanvasContentChange,this);this._messageBus.subscribe("activeLayerChanged",this._onActiveLayerChanged,this);this._messageBus.subscribe("layerRemoved",this._onLayerRemoved,this);},initComponent:function(){var a=Ext.create("Ext.data.Store",{model:"LTP.LayerModel"});this.viewStore=a;this.viewStore.sync=function(){};var b=this;this.dockedItems=[{dock:"top",xtype:"toolbar",items:[{text:"New Layer",listeners:{click:this._onNewClick,scope:this}},{text:"New From Image"},{text:"Flatten",listeners:{click:this._onFlattenClick,scope:this}}]}];this.items=[{xtype:"grid",hideHeaders:true,itemId:"layerGrid",multiSelect:false,sortableColumns:false,viewConfig:{plugins:{ptype:"gridviewdragdrop",dragText:"Drag to re-arrange layer ordering"},listeners:{drop:function(d,f,e,c){var g=c==="before"?"Ahead":"Behind";b.layerManager["moveLayer"+g](f.records[0].data,e.data);}}},store:a,minHeight:100,columns:[{dataIndex:"layerName",flex:2,field:{xtype:"textfield"},menuDisabled:true},{xtype:"templatecolumn",tpl:'<div style="height:{thumbnailHeight}px; width:{thumbnailWidth}px"><img class="thumbnail" src="{thumbnailData}" /></div>',flex:1,dataIndex:"thumbnailData",menuDisabled:true},{xtype:"actioncolumn",width:75,items:[{icon:"/images/visible.png",getClass:this._getVisibleIcon,tooltip:"Toggle visibility",handler:function(d,e,c){this.up("#layerPanel")._toggleVisibilityAt(e);}},{icon:"/images/merge.png",getClass:this._getMergeIcon,tooltip:"Merge into layer below",handler:function(d,e,c){this.up("#layerPanel")._deleteOrMergeAt(e,"merge");}},{icon:"/images/delete.png",tooltip:"Delete",iconCls:"x-grid-center-icon",handler:function(d,e,c){this.up("#layerPanel")._deleteOrMergeAt(e,"delete");}}],menuDisabled:true}],selType:"rowmodel",plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2,listeners:{edit:function(c,d){c.context.record.commit();}}})],listeners:{selectionchange:this._selectionChange,scope:this}}];this.disabled=true;this.callParent(arguments);},_getMergeIcon:function(d,e,a,f,c,b){return f<b.count()-1?"x-grid-center-icon":"x-hide-display";},_getVisibleIcon:function(b,c,a){return a.get("isVisible")?"x-grid-center-icon":"x-grid-center-icon closed-eye-visibility";},load:function(b){this.layerManager=b;this._addLayersToStore(this.viewStore,b);this.setDisabled(false);var a=this.down("#layerGrid");a.getSelectionModel().select(a.store.first());},_selectionChange:function(a,c,b){if(c&&c.length){this.layerManager.setActiveLayerByLayer(c[0].data);}},_onFlattenClick:function(){Ext.MessageBox.confirm("Flatten?","Flatten all layers into one?<br/> This cannot be undone",function(a){if(a==="yes"){this.layerManager.flatten();}},this);},_onNewClick:function(){var c=this.layerManager.addNewLayer();var b=Ext.create("LTP.LayerModel");b.data=c;this.viewStore.insert(0,[b]);var a=this.down("#layerGrid");a.getSelectionModel().select(b,false);},_addLayersToStore:function(a,e){for(var d=0;d<e.layers.length;++d){var c=e.layers[d];var b=Ext.create("LTP.LayerModel");b.data=c;a.insert(0,[b]);}},_onCanvasContentChange:function(b){var a=this._findRecordByCanvas(b);if(a){a.commit();}},_onActiveLayerChanged:function(c){var a=this._findRecordByCanvas(c);if(a){var b=this.down("#layerGrid");b.getSelectionModel().select(a,false);}},_onLayerRemoved:function(b){var a=this._findRecordByCanvas(b);if(a){this.viewStore.remove(a);}},_findRecordByCanvas:function(a){var b;this.viewStore.each(function(c){if(c.data===a){b=c;return false;}});return b;},_toggleVisibilityAt:function(a){var b=this.viewStore.getAt(a);b.set("isVisible",!b.get("isVisible"));b.commit();},_deleteOrMergeAt:function(b,d){var c=this.viewStore.getAt(b);var a=Ext.String.capitalize(d);var e=Ext.String.format("Really {0} '{1}'? <br/>This cannot be undone.",d,c.get("layerName"));Ext.MessageBox.confirm(a+" Layer",e,function(f){if(f==="yes"){this.layerManager[d+"LayerByLayer"](c.data);}},this);}});})();(function(){var b,a;function c(d){b=d.getX();a=d.getY();}Ext.define("LTP.FloatingPalette",{extend:"Ext.panel.Panel",alias:"widget.ltp.floatingpalette",width:200,autoRender:true,floating:true,layout:"column",isPopped:false,constructor:function(d){this.callParent(arguments);this.messageBus=d.messageBus||LTP.GlobalMessageBus;},togglePopup:function(){if(!this.isPopped){this.messageBus.publish("cursorDisplayChangeRequest","");this.showAt(b-this.width/2,a);}else{this.messageBus.publish("cursorDisplayChangeRequest","none");this.hide();}this.isPopped=!this.isPopped;}},function(){Ext.getDoc().on("mousemove",c);});})();(function(){var e;var b;function d(i){var h=i.button?"Right":"Left";var g=this.up("panel");g.colorManager["set"+h+"ColorTo"](this.index);g.hide();g.isPopped=false;if(e){e.hidePicker();e=null;}}function c(g){g.addEventListener("contextmenu",function(h){h.preventDefault();h.stopPropagation();return false;});}function f(){b=this;this.el.dom.value=b.color;e=new jscolor.color(b.el.dom,{pickerClosable:false,pickerPosition:"right",pickerZIndex:40000});e.showPicker();c(document.getElementById("jscolor.boxB"));}function a(i){if(i.target.id&&i.target.id.indexOf("colorswatch")>=0){return;}if(e&&i.target){if(!i.target.id||i.target.id.indexOf("jscolor.")===-1){if(b){b.color="#"+e.toString().toUpperCase();var g=b.up("panel");g.colorManager.redefineAt(b.index,b.color);var h=i.button?"Right":"Left";g.colorManager["set"+h+"ColorTo"](b.index);b=null;}e.hidePicker();e=null;if(this.isPopped){this.togglePopup();}}}}Ext.define("LTP.FloatingColorPalette",{extend:"LTP.FloatingPalette",alias:"widget.ltp.floatingcolorpalette",constructor:function(){this.callParent(arguments);this.messageBus.subscribe("leftColorSelected",this._onLeftColorSelected,this);this.messageBus.subscribe("rightColorSelected",this._onRightColorSelected,this);},dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{text:"Add Color",handler:function(){var g=this.up("panel");g.addColor();}}]}],defaults:{xtype:"ltp.colorswatch"},initComponent:function(){var g=[];var k=this;for(var h=0;h<this.colorManager.colors.length;++h){var j={color:this.colorManager.colors[h],index:h,listeners:{click:d,longclick:f}};if(h<9){j.label=(h+1).toString();}g.push(j);}this.items=g;Ext.getBody().on("mousedown",a,this);this.callParent(arguments);},addColor:function(){this.add({color:colors.white,index:this.items.items.length,listeners:{click:d,longclick:f}});this.colorManager.addColor(colors.white);},_onLeftColorSelected:function(g,h){Ext.Array.each(this.items.items,function(i){i.setIsCurrentLeft(i.index===h);});},_onRightColorSelected:function(g,h){Ext.Array.each(this.items.items,function(i){i.setIsCurrentRight(i.index===h);});}});})();(function(){Ext.define("LTP.FloatingSizePalette",{extend:"LTP.FloatingPalette",alias:"widget.ltp.floatingsizepalette",width:144,height:26,defaults:{xtype:"ltp.sizeswatch"},initComponent:function(){var c=this.sizes||[];var a=[];for(var b=0;b<c.length;++b){a.push({size:c[b],listeners:{click:function(){var d=this.up("panel");d.hide();d.isPopped=false;}}});}this.items=a;this.callParent(arguments);},});})();(function(){var j=[0.125,0.25,0.5,1,1.5,2,3,4,6,8,16,32,64];var f=j.indexOf(1);var l=undefined;var b=f;var d=[0,5,10,15,20];var a=d.indexOf(0);var g=false;var m=[LTP.DirectionLockTransformer.directions.upDown,LTP.DirectionLockTransformer.directions.leftRight];var i=0;var h=[colors.white,colors.black,colors.red,colors.lightGray,colors.blue,colors.green,colors.yellow,colors.orange,colors.purple,colors.gray,colors.brown,"#FF9999","#33AA11","#333333","#88AAFF","#337722",];var c=[1,2,3,4,5,8,14];function k(q){var o;if(q){for(var p=0,n=q.length;p<n;++p){o=q[p];if(typeof o.destroy==="function"){o.destroy();}}}}var e={callbacks:{c:function(){if(!LTP.app.floatingColorPalette){LTP.app.floatingColorPalette=Ext.create("LTP.FloatingColorPalette",{colorManager:LTP.app.colorManager});}LTP.app.floatingColorPalette.togglePopup();},b:function(){if(!LTP.app.floatingSizePalette){LTP.app.floatingSizePalette=Ext.create("LTP.FloatingSizePalette",{sizes:c});}LTP.app.floatingSizePalette.togglePopup();},escdown:function(){if(LTP.app.floatingColorPalette&&LTP.app.floatingColorPalette.isPopped){LTP.app.floatingColorPalette.togglePopup();}if(LTP.app.floatingSizePalette&&LTP.app.floatingSizePalette.isPopped){LTP.app.floatingSizePalette.togglePopup();}},z:function(n){var o=n?-1:1;b+=o;if(b>=j.length){b=j.length-1;}if(b<0){b=0;}LTP.GlobalMessageBus.publish("zoomChanged",j[b]);},u:function(){LTP.app.painter.undo();},r:function(){LTP.app.painter.redo();},g:function(){a=(a+1)%d.length;LTP.app.grid.cellSize=d[a];},i:function(){if(g){LTP.app.painter.popOverrideTool();g=false;}else{LTP.app.painter.pushOverrideTool(new LTP.EyeDropperTool());g=true;}},adown:function(n){if(!n){l=b;}b=f;LTP.GlobalMessageBus.publish("zoomChanged",j[b]);},aup:function(n){if(!n&&!!l){b=l;LTP.GlobalMessageBus.publish("zoomChanged",j[b]);}},s:function(){LTP.app.projectPersister.saveProject(LTP.app._currentProject,LTP.app.layerManager.layers,LTP.app.colorManager.getColorsAsString());LTP.GlobalMessageBus.publish("flairMessage","Project Saved");LTP.app._currentProject.isDirty=false;},e:function(){var n=LTP.app.layerManager.composite();window.open(n.toDataURL("png"),"savedImage");},d:function(){LTP.app.layerManager.dumpLayers();},spacedown:function(){if(g){LTP.app.painter.popOverrideTool();}LTP.app.painter.pushOverrideTool(new LTP.PanningTool());g=true;},spaceup:function(){LTP.app.painter.popOverrideTool();g=false;},k:function(){if(g){LTP.app.painter.popOverrideTool();}else{LTP.app.painter.pushOverrideTool(new LTP.FillTool());}g=!g;},controldown:function(){var n=m[i];i=(i+1)%m.length;LTP.app.painter.adhocTransformer=new LTP.DirectionLockTransformer(n);LTP.GlobalMessageBus.publish("lockChanged",n);},controlup:function(){LTP.app.painter.adhocTransformer=null;LTP.GlobalMessageBus.publish("lockChanged",null);},altdown:function(){LTP.app.painter.adhocTransformer=new LTP.BrushSizeLockTransformer(20);LTP.GlobalMessageBus.publish("lockChanged","brush");},altup:function(){LTP.app.painter.adhocTransformer=null;LTP.GlobalMessageBus.publish("lockChanged",null);},n:function(){window.location=window.location;}},init:function(n){Ext.apply(this,n);this.showProjectChooser();},showProjectChooser:function(){this.projectPersister=new LTP.ProjectPersister();this.projectPersister.loadAllProjects(function(n){this.projectChooser=Ext.create("LTP.ProjectChooser",{renderTo:Ext.getBody(),projects:n,listeners:{projectChosen:this._load,scope:this}});},this);},_createDomStructure:function(){Ext.getBody().createChild('<div id="layerPanelElement"></div>');Ext.getBody().createChild('<div id="outerContainerElement"><div id="containerElement"></div></div >');Ext.getBody().createChild('<div id="statusBarElement"></div>');},_load:function(o){this._currentProject=o;document.title=o.name+" - ltp";this._createDomStructure();this.statusBar=Ext.create("LTP.StatusBar",{renderTo:"statusBarElement"});this.layerPanel=Ext.create("LTP.LayerPanel",{renderTo:"layerPanelElement"});k(this._components);this._components=[];this.colorManager=new LTP.ColorManager();this.colorManager.setColorsFromString(o.palette,h);this.layerManager=new LTP.LayerManager(o);this._components.push(this.layerManager);this.container=new LTP.Container(o.size,document.getElementById("containerElement"));this._components.push(this.container);this.painter=new LTP.Painter(o.size,new LTP.PointTransformer());this._components.push(this.painter);this.grid=new LTP.Grid(o.size,"gray",0);this._components.push(this.grid);Ext.Array.each(this.layerManager.layers,function(p){this.container.addLayer(p);},this);this.painter.activeCanvas=this.layerManager.activeLayer;this.container.overlay=this.painter.overlay;this.container.grid=this.grid.canvas;this.container.scratch=this.painter.scratch;LTP.GlobalMessageBus.subscribe("colorSampled",function(r,q,p){var s=p===0?"left":"right";LTP.GlobalMessageBus.publish(s+"ColorSelected",q);this.painter.popOverrideTool();},this);LTP.GlobalMessageBus.subscribe("leftSizeSelected",function(p){this.painter.leftTool=new LTP.BrushTool(p);},this);LTP.GlobalMessageBus.subscribe("rightSizeSelected",function(p){this.painter.rightTool=new LTP.BrushTool(p);},this);for(var n=1;n<10;++n){this.callbacks[n.toString()]=(function(p){return function(q){var r=q?"Right":"Left";LTP.app.colorManager["set"+r+"ColorTo"](p-1);};})(n);}this.keyListener=new LTP.KeyListener(this);this._components.push(this.keyListener);LTP.GlobalMessageBus.publish("activeLayerChanged",this.layerManager.activeLayer);LTP.GlobalMessageBus.publish("leftColorSelected",this.painter.leftColor);LTP.GlobalMessageBus.publish("rightColorSelected",this.painter.rightColor);this._addCloseWarningHook();this.layerPanel.load(this.layerManager);},_addCloseWarningHook:function(){LTP.GlobalMessageBus.subscribe("canvasContentChange",function(){this._currentProject.isDirty=true;},this);LTP.GlobalMessageBus.subscribe("paletteContentChange",function(){this._currentProject.isDirty=true;},this);var n=this;window.onbeforeunload=function(){if(n._currentProject.isDirty){return"There are unsaved changes to this project";}};}};LTP.app=e;})();